
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>6. Advanced PostGIS &#8212; Introduction to PostGIS</title>
    <link rel="stylesheet" href="_static/pyramid.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="7. Maintenance" href="maintenance.html" />
    <link rel="prev" title="5. PostGIS - Basics" href="basic.html" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Neuton&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nobile:regular,italic,bold,bolditalic&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->

  </head><body>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="maintenance.html" title="7. Maintenance"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="basic.html" title="5. PostGIS - Basics"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Introduction to PostGIS</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="advanced-postgis">
<h1>6. Advanced PostGIS<a class="headerlink" href="#advanced-postgis" title="Permalink to this headline">¶</a></h1>
<div class="section" id="more-spatial-joins">
<span id="joins-advanced"></span><h2>6.1. More Spatial Joins<a class="headerlink" href="#more-spatial-joins" title="Permalink to this headline">¶</a></h2>
<p>In the last section we saw the <strong class="command">ST_Centroid(geometry)</strong> and <strong class="command">ST_Union([geometry])</strong> functions, and some simple examples. In this section we will do some more elaborate things with them.</p>
<div class="section" id="creating-a-census-tracts-table">
<span id="creatingtractstable"></span><h3>6.1.1. Creating a Census Tracts Table<a class="headerlink" href="#creating-a-census-tracts-table" title="Permalink to this headline">¶</a></h3>
<p>In the course <code class="docutils literal notranslate"><span class="pre">\data\</span></code> directory, is a file that includes attribute data, but no geometry, <code class="docutils literal notranslate"><span class="pre">nyc_census_sociodata.sql</span></code>. The table includes interesting socioeconomic data about New York: commute times, incomes, and education attainment. There is just one problem. The data are summarized by “census tract” and we have no census tract spatial data!</p>
<p>In this section we will</p>
<ul class="simple">
<li>Load the <code class="docutils literal notranslate"><span class="pre">nyc_census_sociodata.sql</span></code> table</li>
<li>Create a spatial table for census tracts</li>
<li>Join the attribute data to the spatial data</li>
<li>Carry out some analysis using our new data</li>
</ul>
<div class="section" id="loading-nyc-census-sociodata-sql">
<h4>6.1.1.1. Loading nyc_census_sociodata.sql<a class="headerlink" href="#loading-nyc-census-sociodata-sql" title="Permalink to this headline">¶</a></h4>
<ol class="arabic simple">
<li>Open the SQL query window in PgAdmin</li>
<li>Select <strong>File-&gt;Open</strong> from the menu and browse to the <code class="docutils literal notranslate"><span class="pre">nyc_census_sociodata.sql</span></code> file</li>
<li>(<em>Alternative</em>) In case your postgres user does not have access to access the files in the directory you can use a text editor to open the <code class="docutils literal notranslate"><span class="pre">nyc_census_sociodata.sql</span></code> file and copy its content into the pgAdmin query window</li>
<li>Press the “Run Query” button</li>
<li>If you press the “Refresh” button in pgAdmin, the list of tables should now include at <code class="docutils literal notranslate"><span class="pre">nyc_census_sociodata</span></code> table</li>
</ol>
</div>
<div class="section" id="id1">
<h4>6.1.1.2. Creating a Census Tracts Table<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p>As we saw in the previous section, we can build up higher level geometries from the census block by summarizing on substrings of the <code class="docutils literal notranslate"><span class="pre">blkid</span></code> key. In order to get census tracts, we need to summarize grouping on the first 11 characters of the <code class="docutils literal notranslate"><span class="pre">blkid</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">360610001001001</span> <span class="o">=</span> <span class="mi">36</span> <span class="mi">061</span> <span class="mi">000100</span> <span class="mi">1</span> <span class="mi">001</span>

<span class="mi">36</span>     <span class="o">=</span> <span class="n">State</span> <span class="n">of</span> <span class="n">New</span> <span class="n">York</span>
<span class="mi">061</span>    <span class="o">=</span> <span class="n">New</span> <span class="n">York</span> <span class="n">County</span> <span class="p">(</span><span class="n">Manhattan</span><span class="p">)</span>
<span class="mi">000100</span> <span class="o">=</span> <span class="n">Census</span> <span class="n">Tract</span>
<span class="mi">1</span>      <span class="o">=</span> <span class="n">Census</span> <span class="n">Block</span> <span class="n">Group</span>
<span class="mi">001</span>    <span class="o">=</span> <span class="n">Census</span> <span class="n">Block</span>
</pre></div>
</div>
<p>Create the new table using the <strong class="command">ST_Union</strong> aggregate:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Make the tracts table</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">nyc_census_tract_geoms</span> <span class="k">AS</span>
<span class="k">SELECT</span>
  <span class="n">ST_Union</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span> <span class="k">AS</span> <span class="n">geom</span><span class="p">,</span>
  <span class="n">SubStr</span><span class="p">(</span><span class="n">blkid</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">11</span><span class="p">)</span> <span class="k">AS</span> <span class="n">tractid</span>
<span class="k">FROM</span> <span class="n">nyc_census_blocks</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">tractid</span><span class="p">;</span>

<span class="c1">-- Index the tractid</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">idx_nyc_census_tract_geoms_tractid</span>
  <span class="k">ON</span> <span class="n">nyc_census_tract_geoms</span> <span class="p">(</span><span class="n">tractid</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="join-the-attributes-to-the-spatial-data">
<h4>6.1.1.3. Join the Attributes to the Spatial Data<a class="headerlink" href="#join-the-attributes-to-the-spatial-data" title="Permalink to this headline">¶</a></h4>
<p>Join the table of tract geometries to the table of tract attributes with a standard attribute join</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Make the tracts table</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">nyc_census_tracts</span> <span class="k">AS</span>
<span class="k">SELECT</span>
  <span class="k">g</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span>
  <span class="n">a</span><span class="p">.</span><span class="o">*</span>
<span class="k">FROM</span> <span class="n">nyc_census_tract_geoms</span> <span class="k">g</span>
<span class="k">JOIN</span> <span class="n">nyc_census_sociodata</span> <span class="n">a</span>
<span class="k">ON</span> <span class="k">g</span><span class="p">.</span><span class="n">tractid</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">tractid</span><span class="p">;</span>

<span class="c1">-- Index the geometries</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">sidx_nyc_census_tract</span>
  <span class="k">ON</span> <span class="n">nyc_census_tracts</span> <span class="k">USING</span> <span class="n">GIST</span> <span class="p">(</span><span class="n">geom</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="answer-an-interesting-question">
<span id="interestingquestion"></span><h4>6.1.1.4. Answer an Interesting Question<a class="headerlink" href="#answer-an-interesting-question" title="Permalink to this headline">¶</a></h4>
<p>Answer an interesting question! “List top 10 New York neighborhoods ordered by the proportion of people who have graduate degrees.”</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span>
  <span class="mi">100</span><span class="p">.</span><span class="mi">0</span> <span class="o">*</span> <span class="k">Sum</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">edu_graduate_dipl</span><span class="p">)</span> <span class="o">/</span> <span class="k">Sum</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">edu_total</span><span class="p">)</span> <span class="k">AS</span> <span class="n">graduate_pct</span><span class="p">,</span>
  <span class="n">n</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">n</span><span class="p">.</span><span class="n">boroname</span>
<span class="k">FROM</span> <span class="n">nyc_neighborhoods</span> <span class="n">n</span>
<span class="k">JOIN</span> <span class="n">nyc_census_tracts</span> <span class="n">t</span>
<span class="k">ON</span> <span class="n">ST_Intersects</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span>
<span class="k">WHERE</span> <span class="n">t</span><span class="p">.</span><span class="n">edu_total</span> <span class="o">&gt;</span> <span class="mi">0</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">n</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">n</span><span class="p">.</span><span class="n">boroname</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">graduate_pct</span> <span class="k">DESC</span>
<span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>
</pre></div>
</div>
<p>We sum up the statistics we are interested, then divide them together at the end. In order to avoid divide-by-zero errors, we don’t bother bringing in tracts that have a population count of zero.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">graduate_pct</span> <span class="o">|</span>       <span class="n">name</span>        <span class="o">|</span> <span class="n">boroname</span>
<span class="o">--------------+-------------------+-----------</span>
         <span class="mf">47.6</span> <span class="o">|</span> <span class="n">Carnegie</span> <span class="n">Hill</span>     <span class="o">|</span> <span class="n">Manhattan</span>
         <span class="mf">42.2</span> <span class="o">|</span> <span class="n">Upper</span> <span class="n">West</span> <span class="n">Side</span>   <span class="o">|</span> <span class="n">Manhattan</span>
         <span class="mf">41.1</span> <span class="o">|</span> <span class="n">Battery</span> <span class="n">Park</span>      <span class="o">|</span> <span class="n">Manhattan</span>
         <span class="mf">39.6</span> <span class="o">|</span> <span class="n">Flatbush</span>          <span class="o">|</span> <span class="n">Brooklyn</span>
         <span class="mf">39.3</span> <span class="o">|</span> <span class="n">Tribeca</span>           <span class="o">|</span> <span class="n">Manhattan</span>
         <span class="mf">39.2</span> <span class="o">|</span> <span class="n">North</span> <span class="n">Sutton</span> <span class="n">Area</span> <span class="o">|</span> <span class="n">Manhattan</span>
         <span class="mf">38.7</span> <span class="o">|</span> <span class="n">Greenwich</span> <span class="n">Village</span> <span class="o">|</span> <span class="n">Manhattan</span>
         <span class="mf">38.6</span> <span class="o">|</span> <span class="n">Upper</span> <span class="n">East</span> <span class="n">Side</span>   <span class="o">|</span> <span class="n">Manhattan</span>
         <span class="mf">37.9</span> <span class="o">|</span> <span class="n">Murray</span> <span class="n">Hill</span>       <span class="o">|</span> <span class="n">Manhattan</span>
         <span class="mf">37.4</span> <span class="o">|</span> <span class="n">Central</span> <span class="n">Park</span>      <span class="o">|</span> <span class="n">Manhattan</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">New York geographers will be wondering at the presence of “Flatbush” in this list of over-educated neighborhoods. The answer is discussed in the next section.</p>
</div>
</div>
</div>
<div class="section" id="polygon-polygon-joins">
<span id="polypolyjoins"></span><h3>6.1.2. Polygon/Polygon Joins<a class="headerlink" href="#polygon-polygon-joins" title="Permalink to this headline">¶</a></h3>
<p>In our interesting query (in <a class="reference internal" href="joins_advanced.html#interestingquestion"><span class="std std-ref">Answer an Interesting Question</span></a>) we used the <strong class="command">ST_Intersects(geometry_a, geometry_b)</strong> function to determine which census tract polygons to include in each neighborhood summary. Which leads to the question: what if a tract falls on the border between two neighborhoods? It will intersect both, and so will be included in the summary statistics for <strong>both</strong>.</p>
<img alt="_images/centroid_neighborhood.png" src="_images/centroid_neighborhood.png" />
<p>To avoid this kind of double counting there are two methods:</p>
<ul class="simple">
<li>The simple method is to ensure that each tract only falls in <strong>one</strong> summary area (using <strong class="command">ST_Centroid(geometry)</strong>)</li>
<li>The complex method is to divide crossing tracts at the borders (using <strong class="command">ST_Intersection(geometry,geometry)</strong>)</li>
</ul>
<p>Here is an example of using the simple method to avoid double counting in our graduate education query:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span>
  <span class="mi">100</span><span class="p">.</span><span class="mi">0</span> <span class="o">*</span> <span class="k">Sum</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">edu_graduate_dipl</span><span class="p">)</span> <span class="o">/</span> <span class="k">Sum</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">edu_total</span><span class="p">)</span> <span class="k">AS</span> <span class="n">graduate_pct</span><span class="p">,</span>
  <span class="n">n</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">n</span><span class="p">.</span><span class="n">boroname</span>
<span class="k">FROM</span> <span class="n">nyc_neighborhoods</span> <span class="n">n</span>
<span class="k">JOIN</span> <span class="n">nyc_census_tracts</span> <span class="n">t</span>
<span class="k">ON</span> <span class="n">ST_Contains</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">ST_Centroid</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">geom</span><span class="p">))</span>
<span class="k">WHERE</span> <span class="n">t</span><span class="p">.</span><span class="n">edu_total</span> <span class="o">&gt;</span> <span class="mi">0</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">n</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">n</span><span class="p">.</span><span class="n">boroname</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">graduate_pct</span> <span class="k">DESC</span>
<span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>
</pre></div>
</div>
<p>Note that the query takes longer to run now, because the <strong class="command">ST_Centroid</strong> function  has to be run on every census tract.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">graduate_pct</span> <span class="o">|</span>        <span class="n">name</span>         <span class="o">|</span> <span class="n">boroname</span>
<span class="o">--------------+---------------------+-----------</span>
         <span class="mf">48.0</span> <span class="o">|</span> <span class="n">Carnegie</span> <span class="n">Hill</span>       <span class="o">|</span> <span class="n">Manhattan</span>
         <span class="mf">44.2</span> <span class="o">|</span> <span class="n">Morningside</span> <span class="n">Heights</span> <span class="o">|</span> <span class="n">Manhattan</span>
         <span class="mf">42.1</span> <span class="o">|</span> <span class="n">Greenwich</span> <span class="n">Village</span>   <span class="o">|</span> <span class="n">Manhattan</span>
         <span class="mf">42.0</span> <span class="o">|</span> <span class="n">Upper</span> <span class="n">West</span> <span class="n">Side</span>     <span class="o">|</span> <span class="n">Manhattan</span>
         <span class="mf">41.4</span> <span class="o">|</span> <span class="n">Tribeca</span>             <span class="o">|</span> <span class="n">Manhattan</span>
         <span class="mf">40.7</span> <span class="o">|</span> <span class="n">Battery</span> <span class="n">Park</span>        <span class="o">|</span> <span class="n">Manhattan</span>
         <span class="mf">39.5</span> <span class="o">|</span> <span class="n">Upper</span> <span class="n">East</span> <span class="n">Side</span>     <span class="o">|</span> <span class="n">Manhattan</span>
         <span class="mf">39.3</span> <span class="o">|</span> <span class="n">North</span> <span class="n">Sutton</span> <span class="n">Area</span>   <span class="o">|</span> <span class="n">Manhattan</span>
         <span class="mf">37.4</span> <span class="o">|</span> <span class="n">Cobble</span> <span class="n">Hill</span>         <span class="o">|</span> <span class="n">Brooklyn</span>
         <span class="mf">37.4</span> <span class="o">|</span> <span class="n">Murray</span> <span class="n">Hill</span>         <span class="o">|</span> <span class="n">Manhattan</span>
</pre></div>
</div>
<p>Avoiding double counting changes the results!</p>
<div class="section" id="what-about-flatbush">
<h4>6.1.2.1. What about Flatbush?<a class="headerlink" href="#what-about-flatbush" title="Permalink to this headline">¶</a></h4>
<p>In particular, the Flatbush neighborhood has dropped off the list. The reason why can be seen by looking more closely at the map of the Flatbush neighborhood in our table.</p>
<img alt="_images/nyc_tracts_flatbush.jpg" src="_images/nyc_tracts_flatbush.jpg" />
<p>As defined by our data source, Flatbush is not really a neighborhood in the conventional sense, since it just covers the area of Prospect Park. The census tract for that area records, naturally, zero residents. However, the neighborhood boundary does scrape one of the expensive census tracts bordering the north side of the park (in the gentrified Park Slope neighborhood). When using polygon/polygon tests, this single tract was added to the otherwise empty Flatbush, resulting in the very high score for that query.</p>
</div>
</div>
<div class="section" id="large-radius-distance-joins">
<span id="largeradiusjoins"></span><h3>6.1.3. Large Radius Distance Joins<a class="headerlink" href="#large-radius-distance-joins" title="Permalink to this headline">¶</a></h3>
<p>A query that is fun to ask is “How do the commute times of people near (within 500 meters) subway stations differ from those of people far away from subway stations?”</p>
<p>However, the question runs into some problems of double counting: many people will be within 500 meters of multiple subway stations. Compare the population of New York:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="k">Sum</span><span class="p">(</span><span class="n">popn_total</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">nyc_census_blocks</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">8175032</span>
</pre></div>
</div>
<p>With the population of the people in New York within 500 meters of a subway station:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="k">Sum</span><span class="p">(</span><span class="n">popn_total</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">nyc_census_blocks</span> <span class="n">census</span>
<span class="k">JOIN</span> <span class="n">nyc_subway_stations</span> <span class="n">subway</span>
<span class="k">ON</span> <span class="n">ST_DWithin</span><span class="p">(</span><span class="n">census</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">subway</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">10855873</span>
</pre></div>
</div>
<p>There’s more people close to the subway than there are people! Clearly, our simple SQL is making a big double-counting error. You can see the problem looking at the picture of the buffered subways.</p>
<img alt="_images/subways_buffered.png" src="_images/subways_buffered.png" />
<p>The solution is to ensure that we have only distinct census blocks before passing them into the summarization portion of the query. We can do that by breaking our query up into a subquery that finds the distinct blocks, wrapped in a summarization query that returns our answer:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">WITH</span> <span class="n">distinct_blocks</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="k">ON</span> <span class="p">(</span><span class="n">blkid</span><span class="p">)</span> <span class="n">popn_total</span>
  <span class="k">FROM</span> <span class="n">nyc_census_blocks</span> <span class="n">census</span>
  <span class="k">JOIN</span> <span class="n">nyc_subway_stations</span> <span class="n">subway</span>
  <span class="k">ON</span> <span class="n">ST_DWithin</span><span class="p">(</span><span class="n">census</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">subway</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">SELECT</span> <span class="k">Sum</span><span class="p">(</span><span class="n">popn_total</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">distinct_blocks</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">5005743</span>
</pre></div>
</div>
<p>That’s better! So a bit over half the population of New York is within 500m (about a 5-7 minute walk) of the subway.</p>
</div>
</div>
<div class="section" id="validity">
<span id="id2"></span><h2>6.2. Validity<a class="headerlink" href="#validity" title="Permalink to this headline">¶</a></h2>
<p>In 90% of the cases the answer to the question, “why is my query giving me a ‘TopologyException’ error” is “one or more of the inputs are invalid”.  Which begs the question: what does it mean to be invalid, and why should we care?</p>
<div class="section" id="what-is-validity">
<h3>6.2.1. What is Validity<a class="headerlink" href="#what-is-validity" title="Permalink to this headline">¶</a></h3>
<p>Validity is most important for polygons, which define bounded areas and require a good deal of structure. Lines are very simple and cannot be invalid, nor can points.</p>
<p>Some of the rules of polygon validity feel obvious, and others feel arbitrary (and in fact, are arbitrary).</p>
<ul class="simple">
<li>Polygon rings must close.</li>
<li>Rings that define holes should be inside rings that define exterior boundaries.</li>
<li>Rings may not self-intersect (they may neither touch nor cross one another).</li>
<li>Rings may not touch other rings, except at a point.</li>
</ul>
<p>The last two rules are in the arbitrary category. There are other ways to define polygons that are equally self-consistent but the rules above are the ones used by the <a class="reference internal" href="glossary.html#term-ogc"><span class="xref std std-term">OGC</span></a> <a class="reference internal" href="glossary.html#term-sfsql"><span class="xref std std-term">SFSQL</span></a> standard that PostGIS conforms to.</p>
<p>The reason the rules are important is because algorithms for geometry calculations depend on consistent structure in the inputs. It is possible to build algorithms that have no structural assumptions, but those routines tend to be very slow, because the first step in any structure-free routine is to <em>analyze the inputs and build structure into them</em>.</p>
<p>Here’s an example of why structure matters. This polygon is invalid:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">POLYGON</span><span class="p">((</span><span class="mi">0</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">));</span>
</pre></div>
</div>
<p>You can see the invalidity a little more clearly in this diagram:</p>
<img alt="_images/figure_eight.png" src="_images/figure_eight.png" />
<p>The outer ring is actually a figure-eight, with a self-intersection in the middle. Note that the graphic routines successfully render the polygon fill, so that visually it is appears to be an “area”: two one-unit squares, so a total area of two units of area.</p>
<p>Let’s see what the database thinks the area of our polygon is:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">ST_Area</span><span class="p">(</span><span class="n">ST_GeometryFromText</span><span class="p">(</span>
         <span class="s1">&#39;POLYGON((0 0, 0 1, 1 1, 2 1, 2 2, 1 2, 1 1, 1 0, 0 0))&#39;</span>
       <span class="p">));</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">st_area</span>
<span class="o">---------</span>
       <span class="mi">0</span>
</pre></div>
</div>
<p>What’s going on here? The algorithm that calculates area assumes that rings to not self-intersect. A well-behaved ring will always have the area that is bounded (the interior) on one side of the bounding line (it doesn’t matter which side, just that it is on <em>one</em> side). However, in our (poorly behaved) figure-eight, the bounded area is to the right of the line for one lobe and to the left for the other. This causes the areas calculated for each lobe to cancel out (one comes out as 1, the other as -1) hence the “zero area” result.</p>
</div>
<div class="section" id="detecting-validity">
<h3>6.2.2. Detecting Validity<a class="headerlink" href="#detecting-validity" title="Permalink to this headline">¶</a></h3>
<p>In the previous example we had one polygon that we <strong>knew</strong> was invalid. How do we detect invalidity in a table with millions of geometries? With the <strong class="command">ST_IsValid(geometry)</strong> function. Used against our figure-eight, we get a quick answer:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">ST_IsValid</span><span class="p">(</span><span class="n">ST_GeometryFromText</span><span class="p">(</span>
         <span class="s1">&#39;POLYGON((0 0, 0 1, 1 1, 2 1, 2 2, 1 2, 1 1, 1 0, 0 0))&#39;</span>
       <span class="p">));</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">f</span>
</pre></div>
</div>
<p>Now we know that the feature is invalid, but we don’t know why. We can use the <strong class="command">ST_IsValidReason(geometry)</strong> function to find out the source of the invalidity:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">ST_IsValidReason</span><span class="p">(</span><span class="n">ST_GeometryFromText</span><span class="p">(</span>
         <span class="s1">&#39;POLYGON((0 0, 0 1, 1 1, 2 1, 2 2, 1 2, 1 1, 1 0, 0 0))&#39;</span>
       <span class="p">));</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Self</span><span class="o">-</span><span class="n">intersection</span><span class="p">[</span><span class="mi">1</span> <span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
<p>Note that in addition to the reason (self-intersection) the location of the invalidity (coordinate (1 1)) is also returned.</p>
<p>We can use the <strong class="command">ST_IsValid(geometry)</strong> function to test our tables too:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Find all the invalid polygons and what their problem is</span>
<span class="k">SELECT</span> <span class="n">name</span><span class="p">,</span> <span class="n">boroname</span><span class="p">,</span> <span class="n">ST_IsValidReason</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">nyc_neighborhoods</span>
<span class="k">WHERE</span> <span class="k">NOT</span> <span class="n">ST_IsValid</span><span class="p">(</span><span class="n">geom</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>          <span class="n">name</span>           <span class="o">|</span>   <span class="n">boroname</span>    <span class="o">|</span>                     <span class="n">st_isvalidreason</span>
<span class="o">-------------------------+---------------+-----------------------------------------------------------</span>
 <span class="n">Howard</span> <span class="n">Beach</span>            <span class="o">|</span> <span class="n">Queens</span>        <span class="o">|</span> <span class="n">Self</span><span class="o">-</span><span class="n">intersection</span><span class="p">[</span><span class="mf">597264.083368305</span> <span class="mf">4499924.54228856</span><span class="p">]</span>
 <span class="n">Corona</span>                  <span class="o">|</span> <span class="n">Queens</span>        <span class="o">|</span> <span class="n">Self</span><span class="o">-</span><span class="n">intersection</span><span class="p">[</span><span class="mf">595483.058764138</span> <span class="mf">4513817.95350787</span><span class="p">]</span>
 <span class="n">Red</span> <span class="n">Hook</span>                <span class="o">|</span> <span class="n">Brooklyn</span>      <span class="o">|</span> <span class="n">Self</span><span class="o">-</span><span class="n">intersection</span><span class="p">[</span><span class="mf">584306.820375986</span> <span class="mf">4502360.51774956</span><span class="p">]</span>
 <span class="n">Steinway</span>                <span class="o">|</span> <span class="n">Queens</span>        <span class="o">|</span> <span class="n">Self</span><span class="o">-</span><span class="n">intersection</span><span class="p">[</span><span class="mf">593545.572199759</span> <span class="mf">4514735.20870587</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="repairing-invalidity">
<h3>6.2.3. Repairing Invalidity<a class="headerlink" href="#repairing-invalidity" title="Permalink to this headline">¶</a></h3>
<p>First the bad news: there is no 100% guaranteed way to fix invalid geometries. The worst case scenario is identifying them with the <strong class="command">ST_IsValid(geometry)</strong> function, moving them to a side table, exporting that table, and repairing them externally.</p>
<p>Here’s an example of SQL to move invalid geometries out of the main table into a side table suitable for dumping to an external cleaning process.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Side table of invalids</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">nyc_neighborhoods_invalid</span> <span class="k">AS</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">nyc_neighborhoods</span>
<span class="k">WHERE</span> <span class="k">NOT</span> <span class="n">ST_IsValid</span><span class="p">(</span><span class="n">geom</span><span class="p">);</span>

<span class="c1">-- Remove them from the main table</span>
<span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">nyc_neighborhoods</span>
<span class="k">WHERE</span> <span class="k">NOT</span> <span class="n">ST_IsValid</span><span class="p">(</span><span class="n">geom</span><span class="p">);</span>
</pre></div>
</div>
<p>A good tool for visually repairing invalid geometry is QGIS (<a class="reference external" href="https://qgis.org/en/site/">https://qgis.org/en/site/</a>) which includes a validation tool under <strong>Vector-&gt;Geometry Tools-&gt;Check Validity…</strong>.</p>
<p>Now the good news: a large proportion of invalidities <strong>can be fixed inside the database</strong> using either:</p>
<ul class="simple">
<li>the <strong class="command">ST_MakeValid</strong> function or,</li>
<li>the <strong class="command">ST_Buffer</strong> function.</li>
</ul>
<div class="section" id="st-makevalid">
<h4>6.2.3.1. ST_MakeValid<a class="headerlink" href="#st-makevalid" title="Permalink to this headline">¶</a></h4>
<p><strong class="command">ST_MakeValid</strong> attempts to repair invalidities without only minimal alterations to the input geometries. No vertices are dropped or moved, the structure of the object is simply re-arranged. This is a good thing for clean, but invalid data, and a bad thing for messy and invalid data.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Fix the invalid figure-8 polygon</span>
<span class="k">SELECT</span> <span class="n">ST_AsText</span><span class="p">(</span><span class="n">ST_MakeValid</span><span class="p">(</span>
         <span class="s1">&#39;POLYGON((0 0, 0 1, 1 1, 2 1, 2 2, 1 2, 1 1, 1 0, 0 0))&#39;</span>
       <span class="p">));</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MULTIPOLYGON</span><span class="p">(</span>
  <span class="p">((</span><span class="mi">0</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span> <span class="mi">0</span><span class="p">)),</span>
  <span class="p">((</span><span class="mi">1</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1</span> <span class="mi">2</span><span class="p">,</span><span class="mi">2</span> <span class="mi">2</span><span class="p">,</span><span class="mi">2</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1</span> <span class="mi">1</span><span class="p">))</span>
<span class="p">)</span>
</pre></div>
</div>
<p><strong class="command">ST_MakeValid</strong> successfully converts the figure-8 into a multi-polygon that represents the same area.</p>
</div>
<div class="section" id="st-buffer">
<h4>6.2.3.2. ST_Buffer<a class="headerlink" href="#st-buffer" title="Permalink to this headline">¶</a></h4>
<p>Cleaning using the buffer trick takes advantage of the way buffers are built: a buffered geometry is a brand new geometry, constructed by offsetting lines from the original geometry. If you offset the original lines by <strong>nothing</strong> (zero) then the new geometry will be structurally identical to the original one, but because it is built using the <a class="reference internal" href="glossary.html#term-ogc"><span class="xref std std-term">OGC</span></a> topology rules, it will be valid.</p>
<p>For example, here’s a classic invalidity – the “banana polygon” – a single ring that encloses an area but bends around to touch itself, leaving a “hole” which is not actually a hole.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">POLYGON</span><span class="p">((</span><span class="mi">0</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">))</span>
</pre></div>
</div>
<img alt="_images/banana.png" class="inline" src="_images/banana.png" />
<p>Running the zero-offset buffer on the polygon returns a valid <a class="reference internal" href="glossary.html#term-ogc"><span class="xref std std-term">OGC</span></a> polygon, consisting of an outer and inner ring that touch at one point.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">ST_AsText</span><span class="p">(</span>
         <span class="n">ST_Buffer</span><span class="p">(</span>
           <span class="n">ST_GeometryFromText</span><span class="p">(</span><span class="s1">&#39;POLYGON((0 0, 2 0, 1 1, 2 2, 3 1, 2 0, 4 0, 4 4, 0 4, 0 0))&#39;</span><span class="p">),</span>
           <span class="mi">0</span><span class="p">.</span><span class="mi">0</span>
         <span class="p">)</span>
       <span class="p">);</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">POLYGON</span><span class="p">((</span><span class="mi">0</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span> <span class="mi">4</span><span class="p">,</span><span class="mi">4</span> <span class="mi">4</span><span class="p">,</span><span class="mi">4</span> <span class="mi">0</span><span class="p">,</span><span class="mi">2</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span> <span class="mi">0</span><span class="p">),(</span><span class="mi">2</span> <span class="mi">0</span><span class="p">,</span><span class="mi">3</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span> <span class="mi">2</span><span class="p">,</span><span class="mi">1</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span> <span class="mi">0</span><span class="p">))</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The “banana polygon” (or “inverted shell”) is a case where the <a class="reference internal" href="glossary.html#term-ogc"><span class="xref std std-term">OGC</span></a> topology model for valid geometry and the model used internally by ESRI differ. The ESRI model considers rings that touch to be invalid, and prefers the banana form for this kind of shape. The OGC model is the reverse. Neither is “correct”, they are just different ways to model the same situation.</p>
</div>
</div>
</div>
</div>
<div class="section" id="equality">
<span id="id3"></span><h2>6.3. Equality<a class="headerlink" href="#equality" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id4">
<h3>6.3.1. Equality<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>Determining equality when dealing with geometries can be tricky.  PostGIS supports three different functions that can be used to determine different levels of equality, though for clarity we will use the definitions below.  To illustrate these functions, we will use the following polygons.</p>
<img alt="_images/polygon-table.png" class="inline" src="_images/polygon-table.png" />
<p>These polygons are loaded using the following commands.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">polygons</span> <span class="p">(</span><span class="n">id</span> <span class="nb">integer</span><span class="p">,</span> <span class="n">name</span> <span class="nb">varchar</span><span class="p">,</span> <span class="n">poly</span> <span class="n">geometry</span><span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">polygons</span> <span class="k">VALUES</span>
  <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Polygon 1&#39;</span><span class="p">,</span> <span class="s1">&#39;POLYGON((-1 1.732,1 1.732,2 0,1 -1.732,</span>
<span class="s1">      -1 -1.732,-2 0,-1 1.732))&#39;</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Polygon 2&#39;</span><span class="p">,</span> <span class="s1">&#39;POLYGON((-1 1.732,-2 0,-1 -1.732,1 -1.732,</span>
<span class="s1">      2 0,1 1.732,-1 1.732))&#39;</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;Polygon 3&#39;</span><span class="p">,</span> <span class="s1">&#39;POLYGON((1 -1.732,2 0,1 1.732,-1 1.732,</span>
<span class="s1">      -2 0,-1 -1.732,1 -1.732))&#39;</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;Polygon 4&#39;</span><span class="p">,</span> <span class="s1">&#39;POLYGON((-1 1.732,0 1.732, 1 1.732,1.5 0.866,</span>
<span class="s1">      2 0,1.5 -0.866,1 -1.732,0 -1.732,-1 -1.732,-1.5 -0.866,</span>
<span class="s1">      -2 0,-1.5 0.866,-1 1.732))&#39;</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;Polygon 5&#39;</span><span class="p">,</span> <span class="s1">&#39;POLYGON((-2 -1.732,2 -1.732,2 1.732,</span>
<span class="s1">      -2 1.732,-2 -1.732))&#39;</span><span class="p">);</span>
</pre></div>
</div>
<img alt="_images/start13.png" src="_images/start13.png" />
<p>Exact equality is determined by comparing two geometries, vertex by vertex, in order, to ensure they are identical in position.  The following examples show how this method can be limited in its effectiveness.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">a</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">ST_OrderingEquals</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">poly</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">poly</span><span class="p">)</span>
    <span class="k">THEN</span> <span class="s1">&#39;Exactly Equal&#39;</span> <span class="k">ELSE</span> <span class="s1">&#39;Not Exactly Equal&#39;</span> <span class="k">end</span>
  <span class="k">FROM</span> <span class="n">polygons</span> <span class="k">as</span> <span class="n">a</span><span class="p">,</span> <span class="n">polygons</span> <span class="k">as</span> <span class="n">b</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   <span class="n">name</span>    <span class="o">|</span>   <span class="n">name</span>    <span class="o">|</span>       <span class="n">case</span>
<span class="o">-----------+-----------+-------------------</span>
 <span class="n">Polygon</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">Exactly</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">Not</span> <span class="n">Exactly</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">3</span> <span class="o">|</span> <span class="n">Not</span> <span class="n">Exactly</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">Not</span> <span class="n">Exactly</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">5</span> <span class="o">|</span> <span class="n">Not</span> <span class="n">Exactly</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">Not</span> <span class="n">Exactly</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">Exactly</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">3</span> <span class="o">|</span> <span class="n">Not</span> <span class="n">Exactly</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">Not</span> <span class="n">Exactly</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">5</span> <span class="o">|</span> <span class="n">Not</span> <span class="n">Exactly</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">3</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">Not</span> <span class="n">Exactly</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">3</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">Not</span> <span class="n">Exactly</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">3</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">3</span> <span class="o">|</span> <span class="n">Exactly</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">3</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">Not</span> <span class="n">Exactly</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">3</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">5</span> <span class="o">|</span> <span class="n">Not</span> <span class="n">Exactly</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">Not</span> <span class="n">Exactly</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">Not</span> <span class="n">Exactly</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">3</span> <span class="o">|</span> <span class="n">Not</span> <span class="n">Exactly</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">Exactly</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">5</span> <span class="o">|</span> <span class="n">Not</span> <span class="n">Exactly</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">5</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">Not</span> <span class="n">Exactly</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">5</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">Not</span> <span class="n">Exactly</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">5</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">3</span> <span class="o">|</span> <span class="n">Not</span> <span class="n">Exactly</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">5</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">Not</span> <span class="n">Exactly</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">5</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">5</span> <span class="o">|</span> <span class="n">Exactly</span> <span class="n">Equal</span>
</pre></div>
</div>
<p>In this example, the polygons are only equal to themselves, not to other seemingly equivalent polygons (as in the case of Polygons 1 through 3).  In the case of Polygons 1, 2, and 3, the vertices are in identical positions but are defined in differing orders.  Polygon 4 has colinear (and thus redundant) vertices on the hexagon edges causing inequality with Polygon 1.</p>
<p>As we saw above, exact equality does not take into account the spatial nature of the geometries.  There is an function, aptly named <strong class="command">ST_Equals</strong>, available to test the spatial equality or equivalence of geometries.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">a</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">ST_Equals</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">poly</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">poly</span><span class="p">)</span>
    <span class="k">THEN</span> <span class="s1">&#39;Spatially Equal&#39;</span> <span class="k">ELSE</span> <span class="s1">&#39;Not Equal&#39;</span> <span class="k">end</span>
  <span class="k">FROM</span> <span class="n">polygons</span> <span class="k">as</span> <span class="n">a</span><span class="p">,</span> <span class="n">polygons</span> <span class="k">as</span> <span class="n">b</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   <span class="n">name</span>    <span class="o">|</span>   <span class="n">name</span>    <span class="o">|</span>      <span class="n">case</span>
<span class="o">-----------+-----------+-----------------</span>
 <span class="n">Polygon</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">Spatially</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">Spatially</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">3</span> <span class="o">|</span> <span class="n">Spatially</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">Spatially</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">5</span> <span class="o">|</span> <span class="n">Not</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">Spatially</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">Spatially</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">3</span> <span class="o">|</span> <span class="n">Spatially</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">Spatially</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">5</span> <span class="o">|</span> <span class="n">Not</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">3</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">Spatially</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">3</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">Spatially</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">3</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">3</span> <span class="o">|</span> <span class="n">Spatially</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">3</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">Spatially</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">3</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">5</span> <span class="o">|</span> <span class="n">Not</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">Spatially</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">Spatially</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">3</span> <span class="o">|</span> <span class="n">Spatially</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">Spatially</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">5</span> <span class="o">|</span> <span class="n">Not</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">5</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">Not</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">5</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">Not</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">5</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">3</span> <span class="o">|</span> <span class="n">Not</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">5</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">Not</span> <span class="n">Equal</span>
 <span class="n">Polygon</span> <span class="mi">5</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">5</span> <span class="o">|</span> <span class="n">Spatially</span> <span class="n">Equal</span>
</pre></div>
</div>
<p>These results are more in line with our intuitive understanding of equality.  Polygons 1 through 4 are considered equal, since they enclose the same area.  Note that neither the direction of the polygon is drawn, the starting point for defining the polygon, nor the number of points used are important here.  What is important is that the polygons contain the same space.</p>
<p>Exact equality requires, in the worst case, comparison of each and every vertex in the geometry to determine equality.  This can be slow, and may not be appropriate for comparing huge numbers of geometries.  To allow for speedier comparison, the equal bounds operator, <strong class="command">=</strong>, is provided.  This operates only on the bounding box (rectangle), ensuring that the geometries occupy the same two dimensional extent, but not necessarily the same space.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">a</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">a</span><span class="p">.</span><span class="n">poly</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="n">poly</span>
    <span class="k">THEN</span> <span class="s1">&#39;Equal Bounds&#39;</span> <span class="k">ELSE</span> <span class="s1">&#39;Non-equal Bounds&#39;</span> <span class="k">end</span>
  <span class="k">FROM</span> <span class="n">polygons</span> <span class="k">as</span> <span class="n">a</span><span class="p">,</span> <span class="n">polygons</span> <span class="k">as</span> <span class="n">b</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   <span class="n">name</span>    <span class="o">|</span>   <span class="n">name</span>    <span class="o">|</span>       <span class="n">case</span>
<span class="o">-----------+-----------+------------------</span>
 <span class="n">Polygon</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">Equal</span> <span class="n">Bounds</span>
 <span class="n">Polygon</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">Non</span><span class="o">-</span><span class="n">equal</span> <span class="n">Bounds</span>
 <span class="n">Polygon</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">3</span> <span class="o">|</span> <span class="n">Non</span><span class="o">-</span><span class="n">equal</span> <span class="n">Bounds</span>
 <span class="n">Polygon</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">Non</span><span class="o">-</span><span class="n">equal</span> <span class="n">Bounds</span>
 <span class="n">Polygon</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">5</span> <span class="o">|</span> <span class="n">Non</span><span class="o">-</span><span class="n">equal</span> <span class="n">Bounds</span>
 <span class="n">Polygon</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">Non</span><span class="o">-</span><span class="n">equal</span> <span class="n">Bounds</span>
 <span class="n">Polygon</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">Equal</span> <span class="n">Bounds</span>
 <span class="n">Polygon</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">3</span> <span class="o">|</span> <span class="n">Non</span><span class="o">-</span><span class="n">equal</span> <span class="n">Bounds</span>
 <span class="n">Polygon</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">Non</span><span class="o">-</span><span class="n">equal</span> <span class="n">Bounds</span>
 <span class="n">Polygon</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">5</span> <span class="o">|</span> <span class="n">Non</span><span class="o">-</span><span class="n">equal</span> <span class="n">Bounds</span>
 <span class="n">Polygon</span> <span class="mi">3</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">Non</span><span class="o">-</span><span class="n">equal</span> <span class="n">Bounds</span>
 <span class="n">Polygon</span> <span class="mi">3</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">Non</span><span class="o">-</span><span class="n">equal</span> <span class="n">Bounds</span>
 <span class="n">Polygon</span> <span class="mi">3</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">3</span> <span class="o">|</span> <span class="n">Equal</span> <span class="n">Bounds</span>
 <span class="n">Polygon</span> <span class="mi">3</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">Non</span><span class="o">-</span><span class="n">equal</span> <span class="n">Bounds</span>
 <span class="n">Polygon</span> <span class="mi">3</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">5</span> <span class="o">|</span> <span class="n">Non</span><span class="o">-</span><span class="n">equal</span> <span class="n">Bounds</span>
 <span class="n">Polygon</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">Non</span><span class="o">-</span><span class="n">equal</span> <span class="n">Bounds</span>
 <span class="n">Polygon</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">Non</span><span class="o">-</span><span class="n">equal</span> <span class="n">Bounds</span>
 <span class="n">Polygon</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">3</span> <span class="o">|</span> <span class="n">Non</span><span class="o">-</span><span class="n">equal</span> <span class="n">Bounds</span>
 <span class="n">Polygon</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">Equal</span> <span class="n">Bounds</span>
 <span class="n">Polygon</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">5</span> <span class="o">|</span> <span class="n">Non</span><span class="o">-</span><span class="n">equal</span> <span class="n">Bounds</span>
 <span class="n">Polygon</span> <span class="mi">5</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">Non</span><span class="o">-</span><span class="n">equal</span> <span class="n">Bounds</span>
 <span class="n">Polygon</span> <span class="mi">5</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">Non</span><span class="o">-</span><span class="n">equal</span> <span class="n">Bounds</span>
 <span class="n">Polygon</span> <span class="mi">5</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">3</span> <span class="o">|</span> <span class="n">Non</span><span class="o">-</span><span class="n">equal</span> <span class="n">Bounds</span>
 <span class="n">Polygon</span> <span class="mi">5</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">Non</span><span class="o">-</span><span class="n">equal</span> <span class="n">Bounds</span>
 <span class="n">Polygon</span> <span class="mi">5</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="mi">5</span> <span class="o">|</span> <span class="n">Equal</span> <span class="n">Bounds</span>
</pre></div>
</div>
<p>As you can see, all of our spatially equal geometries also have equal bounds.  Unfortunately, Polygon 5 is also returned as equal under this test, because it shares the same bounding box as the other geometries.  Why is this useful, then?  Although this will be covered in detail later, the shot answer is that this enables the use of spatial indexing that can quickly reduce huge comparison sets into more manageable blocks when joining or filtering data.</p>
</div>
</div>
<div class="section" id="linear-referencing">
<span id="id5"></span><h2>6.4. Linear Referencing<a class="headerlink" href="#linear-referencing" title="Permalink to this headline">¶</a></h2>
<p>Linear referencing is a means of representing features that are can be described by referencing a base set of linear features. Common examples of features that are modelled using linear referencing are:</p>
<ul class="simple">
<li>Highway assets, which are referenced using miles along a highway network</li>
<li>Road maintenance operations, which are referenced as occurring along a road network between a pair of mile measurements.</li>
<li>Aquatic inventories, where fish presence is recorded as existing between a pair of mileage-upstream measurements.</li>
<li>Hydrologic characterizations (“reaches”) of streams, recorded with a from- and to- mileage.</li>
</ul>
<p>The benefit of linear referencing models is that the dependent spatial observations do not need to be separately recorded from the base observations, and updates to the base observation layer can be carried out knowing that the dependent observations will automatically track the new geometry.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The ESRI convention for linear referencing is to have a base table of linear spatial features, and a non-spatial table of “events” which includes a foreign key reference to the spatial feature and a measure along the referenced feature. We will use the term “event table” to refer to the non-spatial tables we build.</p>
</div>
<div class="section" id="creating-linear-references">
<h3>6.4.1. Creating Linear References<a class="headerlink" href="#creating-linear-references" title="Permalink to this headline">¶</a></h3>
<p>If you have an existing point table that you want to reference to a linear network, use the <strong class="command">ST_LineLocatePoint</strong> function, which takes a line and point, and returns the proportion along the line that the point can be found.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Simple example of locating a point half-way along a line</span>
<span class="k">SELECT</span> <span class="n">ST_LineLocatePoint</span><span class="p">(</span><span class="s1">&#39;LINESTRING(0 0, 2 2)&#39;</span><span class="p">,</span> <span class="s1">&#39;POINT(1 1)&#39;</span><span class="p">);</span>
<span class="c1">-- Answer 0.5</span>

<span class="c1">-- What if the point is not on the line? It projects to closest point</span>
<span class="k">SELECT</span> <span class="n">ST_LineLocatePoint</span><span class="p">(</span><span class="s1">&#39;LINESTRING(0 0, 2 2)&#39;</span><span class="p">,</span> <span class="s1">&#39;POINT(0 2)&#39;</span><span class="p">);</span>
<span class="c1">-- Answer 0.5</span>
</pre></div>
</div>
<p>We can convert the <strong>nyc_subway_stations</strong> into an “event table” relative to the streets by using <strong class="command">ST_LineLocatePoint</strong>.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- All the SQL below is in aid of creating the new event table</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">nyc_subway_station_events</span> <span class="k">AS</span>
<span class="c1">-- We first need to get a candidate set of maybe-closest</span>
<span class="c1">-- streets, ordered by id and distance...</span>
<span class="k">WITH</span> <span class="n">ordered_nearest</span> <span class="k">AS</span> <span class="p">(</span>
<span class="k">SELECT</span>
  <span class="n">ST_GeometryN</span><span class="p">(</span><span class="n">streets</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">AS</span> <span class="n">streets_geom</span><span class="p">,</span>
  <span class="n">streets</span><span class="p">.</span><span class="n">id</span> <span class="k">AS</span> <span class="n">streets_id</span><span class="p">,</span>
  <span class="n">subways</span><span class="p">.</span><span class="n">geom</span> <span class="k">AS</span> <span class="n">subways_geom</span><span class="p">,</span>
  <span class="n">subways</span><span class="p">.</span><span class="n">id</span> <span class="k">AS</span> <span class="n">subways_id</span><span class="p">,</span>
  <span class="n">ST_Distance</span><span class="p">(</span><span class="n">streets</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">subways</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span> <span class="k">AS</span> <span class="n">distance</span>
<span class="k">FROM</span> <span class="n">nyc_streets</span> <span class="n">streets</span>
  <span class="k">JOIN</span> <span class="n">nyc_subway_stations</span> <span class="n">subways</span>
  <span class="k">ON</span> <span class="n">ST_DWithin</span><span class="p">(</span><span class="n">streets</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">subways</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">subways_id</span><span class="p">,</span> <span class="n">distance</span> <span class="k">ASC</span>
<span class="p">)</span>
<span class="c1">-- We use the &#39;distinct on&#39; PostgreSQL feature to get the first</span>
<span class="c1">-- street (the nearest) for each unique street gid. We can then</span>
<span class="c1">-- pass that one street into ST_LineLocatePoint along with</span>
<span class="c1">-- its candidate subway station to calculate the measure.</span>
<span class="k">SELECT</span>
  <span class="k">DISTINCT</span> <span class="k">ON</span> <span class="p">(</span><span class="n">subways_id</span><span class="p">)</span>
  <span class="n">subways_id</span><span class="p">,</span>
  <span class="n">streets_id</span><span class="p">,</span>
  <span class="n">ST_LineLocatePoint</span><span class="p">(</span><span class="n">streets_geom</span><span class="p">,</span> <span class="n">subways_geom</span><span class="p">)</span> <span class="k">AS</span> <span class="n">measure</span><span class="p">,</span>
  <span class="n">distance</span>
<span class="k">FROM</span> <span class="n">ordered_nearest</span><span class="p">;</span>

<span class="c1">-- Primary keys are useful for visualization softwares</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">nyc_subway_station_events</span> <span class="k">ADD</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">subways_id</span><span class="p">);</span>
</pre></div>
</div>
<p>Once we have an event table, it’s fun to turn it back into a spatial view, so we can visualize the events relative to the original points they were derived from.</p>
<p>To go from a measure to a point, we use the <strong class="command">ST_LineInterpolatePoint</strong> function. Here’s our previous simple examples reversed:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Simple example of locating a point half-way along a line</span>
<span class="k">SELECT</span> <span class="n">ST_AsText</span><span class="p">(</span><span class="n">ST_LineInterpolatePoint</span><span class="p">(</span><span class="s1">&#39;LINESTRING(0 0, 2 2)&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">));</span>

<span class="c1">-- Answer POINT(1 1)</span>
</pre></div>
</div>
<p>And we can join the <strong>nyc_subway_station_events</strong> tables back to the <strong>nyc_streets</strong> table and use the <strong>measure</strong> attribute to generate the spatial event points, without referencing the original <strong>nyc_subway_stations</strong> table.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- New view that turns events back into spatial objects</span>
<span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">VIEW</span> <span class="n">nyc_subway_stations_lrs</span> <span class="k">AS</span>
<span class="k">SELECT</span>
  <span class="n">events</span><span class="p">.</span><span class="n">subways_id</span><span class="p">,</span>
  <span class="n">ST_LineInterpolatePoint</span><span class="p">(</span><span class="n">ST_GeometryN</span><span class="p">(</span><span class="n">streets</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">events</span><span class="p">.</span><span class="n">measure</span><span class="p">)</span><span class="k">AS</span> <span class="n">geom</span><span class="p">,</span>
  <span class="n">events</span><span class="p">.</span><span class="n">streets_id</span>
<span class="k">FROM</span> <span class="n">nyc_subway_station_events</span> <span class="n">events</span>
<span class="k">JOIN</span> <span class="n">nyc_streets</span> <span class="n">streets</span>
<span class="k">ON</span> <span class="p">(</span><span class="n">streets</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">events</span><span class="p">.</span><span class="n">streets_id</span><span class="p">);</span>
</pre></div>
</div>
<p>Viewing the original (red star) and event (blue circle) points with the streets, you can see how the events are snapped directly to the closest street lines.</p>
<img alt="_images/lrs1.jpg" src="_images/lrs1.jpg" />
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">One surprising use of the linear referencing functions has nothing to do with linear referencing models. As shown above, it’s possible to use the functions to snap points to linear features. For use cases like GPS tracks or other inputs that are expected to reference a linear network, snapping is a handy feature to have available.</p>
</div>
</div>
<div class="section" id="function-list">
<h3>6.4.2. Function List<a class="headerlink" href="#function-list" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><a class="reference external" href="http://postgis.net/docs/ST_LineInterpolatePoint.html">ST_LineInterpolatePoint(geometry A, double measure)</a>: Returns a point interpolated along a line.</li>
<li><a class="reference external" href="http://postgis.net/docs/ST_LineLocatePoint.html">ST_LineLocatePoint(geometry A, geometry B)</a>: Returns a float between 0 and 1 representing the location of the closest point on LineString to the given Point.</li>
<li><a class="reference external" href="http://www.postgis.org/docs/ST_Line_Substring.html">ST_Line_Substring(geometry A, double from, double to)</a>: Return a linestring being a substring of the input one starting and ending at the given fractions of total 2d length.</li>
<li><a class="reference external" href="https://postgis.net/docs/ST_LocateAlong.html">ST_LocateAlong(geometry A, double measure, double offset)</a>: Return a derived geometry collection value with elements that match the specified measure.</li>
<li><a class="reference external" href="https://postgis.net/docs/ST_LocateBetween.html">ST_Locate_Between(geometry A, double from, double to, double offset)</a>: Return a derived geometry collection value with elements that match the specified range of measures inclusively.</li>
<li><a class="reference external" href="http://postgis.net/docs/ST_AddMeasure.html">ST_AddMeasure(geometry A, double from, double to)</a>: Return a derived geometry with measure elements linearly interpolated between the start and end points. If the geometry has no measure dimension, one is added.</li>
</ul>
</div>
</div>
<div class="section" id="dimensionally-extended-9-intersection-model">
<span id="de9im"></span><h2>6.5. Dimensionally Extended 9-Intersection Model<a class="headerlink" href="#dimensionally-extended-9-intersection-model" title="Permalink to this headline">¶</a></h2>
<p>The “<a class="reference external" href="http://en.wikipedia.org/wiki/DE-9IM">Dimensionally Extended 9-Intersection Model</a>” (DE9IM) is a framework for modelling how two spatial objects interact.</p>
<p>First, every spatial object has:</p>
<ul class="simple">
<li>An interior</li>
<li>A boundary</li>
<li>An exterior</li>
</ul>
<p>For polygons, the interior, boundary and exterior are obvious:</p>
<img alt="_images/de9im1.jpg" class="inline" src="_images/de9im1.jpg" />
<p>The interior is the part bounded by the rings; the boundary is the rings themselves; the exterior is everything else in the plane.</p>
<p>For linear features, the interior, boundary and exterior are less well-known:</p>
<img alt="_images/de9im2.jpg" class="inline" src="_images/de9im2.jpg" />
<p>The interior is the part of the line bounded by the ends; the boundary is the ends of the linear feature, and the exterior is everything else in the plane.</p>
<p>For points, things are even stranger: the interior is the point; the boundary is the empty set and the exterior is everything else in the plane.</p>
<p>Using these definitions of interior, exterior and boundary, the relationships between any pair of spatial features can be characterized using the dimensionality of the nine possible intersections between the interiors/boundaries/exteriors of a pair of objects.</p>
<img alt="_images/de9im3.jpg" class="inline" src="_images/de9im3.jpg" />
<p>For the polygons in the example above, the intersection of the interiors is a 2-dimensional area, so that portion of the matrix is filled out with a “2”. The boundaries only intersect at points, which are zero-dimensional, so that portion of the matrix is filled out with a 0.</p>
<p>When there is no intersection between components, the square the matrix is filled out with an “F”.</p>
<p>Here’s another example, of a linestring partially entering a polygon:</p>
<img alt="_images/de9im4.jpg" class="inline" src="_images/de9im4.jpg" />
<p>The DE9IM matrix for the interaction is this:</p>
<img alt="_images/de9im5.jpg" class="inline" src="_images/de9im5.jpg" />
<p>Note that the boundaries of the two objects don’t actually intersect at all (the end point of the line interacts with the interior of the polygon, not the boundary, and vice versa), so the B/B cell is filled in with an “F”.</p>
<p>While it’s fun to visually fill out DE9IM matrices, it would be nice if a computer could do it, and that’s what the <strong class="command">ST_Relate</strong> function is for.</p>
<p>The previous example can be simplified using a simple box and line, with the same spatial relationship as our polygon and linestring:</p>
<img alt="_images/de9im6.jpg" class="inline" src="_images/de9im6.jpg" />
<p>And we can generate the DE9IM information in SQL:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">ST_Relate</span><span class="p">(</span>
         <span class="s1">&#39;LINESTRING(0 0, 2 0)&#39;</span><span class="p">,</span>
         <span class="s1">&#39;POLYGON((1 -1, 1 1, 3 1, 3 -1, 1 -1))&#39;</span>
       <span class="p">);</span>
</pre></div>
</div>
<p>The answer (1010F0212) is the same as we calculated visually, but returned as a 9-character string, with the first row, second row and third row of the table appended together.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">101</span>
<span class="mi">0</span><span class="n">F0</span>
<span class="mi">212</span>
</pre></div>
</div>
<p>However, the power of DE9IM matrices is not in generating them, but in using them as a matching key to find geometries with very specific relationships to one another.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">lakes</span> <span class="p">(</span> <span class="n">id</span> <span class="nb">serial</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span> <span class="n">geom</span> <span class="n">geometry</span><span class="p">(</span><span class="n">POLYGON</span><span class="p">)</span> <span class="p">);</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">docks</span> <span class="p">(</span> <span class="n">id</span> <span class="nb">serial</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span> <span class="n">good</span> <span class="nb">boolean</span><span class="p">,</span> <span class="n">geom</span> <span class="n">geometry</span><span class="p">(</span><span class="n">LINESTRING</span><span class="p">)</span> <span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">lakes</span> <span class="p">(</span> <span class="n">geom</span> <span class="p">)</span>
  <span class="k">VALUES</span> <span class="p">(</span> <span class="s1">&#39;POLYGON ((100 200, 140 230, 180 310, 280 310, 390 270, 400 210, 320 140, 215 141, 150 170, 100 200))&#39;</span><span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">docks</span> <span class="p">(</span> <span class="n">geom</span><span class="p">,</span> <span class="n">good</span> <span class="p">)</span>
  <span class="k">VALUES</span>
        <span class="p">(</span><span class="s1">&#39;LINESTRING (170 290, 205 272)&#39;</span><span class="p">,</span><span class="k">true</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;LINESTRING (120 215, 176 197)&#39;</span><span class="p">,</span><span class="k">true</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;LINESTRING (290 260, 340 250)&#39;</span><span class="p">,</span><span class="k">false</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;LINESTRING (350 300, 400 320)&#39;</span><span class="p">,</span><span class="k">false</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;LINESTRING (370 230, 420 240)&#39;</span><span class="p">,</span><span class="k">false</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;LINESTRING (370 180, 390 160)&#39;</span><span class="p">,</span><span class="k">false</span><span class="p">);</span>
</pre></div>
</div>
<p>Suppose we have a data model that includes <strong>Lakes</strong> and <strong>Docks</strong>, and suppose further that Docks must be inside lakes, and must touch the boundary of their containing lake at one end. Can we find all the docks in our database that obey that rule?</p>
<img alt="_images/de9im7.jpg" class="inline" src="_images/de9im7.jpg" />
<p>Our legal docks have the following characteristics:</p>
<ul class="simple">
<li>Their interiors have a linear (1D) intersection with the lake interior</li>
<li>Their boundaries have a point (0D) intersection with the lake interior</li>
<li>Their boundaries <strong>also</strong> have a point (0D) intersection with the lake boundary</li>
<li>Their interiors have no intersection (F) with the lake exterior</li>
</ul>
<p>So their DE9IM matrix looks like this:</p>
<img alt="_images/de9im8.jpg" class="inline" src="_images/de9im8.jpg" />
<p>So to find all the legal docks, we would want to find all the docks that intersect lakes (a super-set of <strong>potential</strong> candidates we use for our join key), and then find all the docks in that set which have the legal relate pattern.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">docks</span><span class="p">.</span><span class="o">*</span>
<span class="k">FROM</span> <span class="n">docks</span> <span class="k">JOIN</span> <span class="n">lakes</span> <span class="k">ON</span> <span class="n">ST_Intersects</span><span class="p">(</span><span class="n">docks</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">lakes</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span>
<span class="k">WHERE</span> <span class="n">ST_Relate</span><span class="p">(</span><span class="n">docks</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">lakes</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="s1">&#39;1FF00F212&#39;</span><span class="p">);</span>

<span class="c1">-- Answer: our two good docks</span>
</pre></div>
</div>
<p>Note the use of the three-parameter version of <strong class="command">ST_Relate</strong>, which returns true if the pattern matches or false if it does not. For a fully-defined pattern like this one, the three-parameter version is not needed – we could have just used a string equality operator.</p>
<p>However, for looser pattern searches, the three-parameter allows substitution characters in the pattern string:</p>
<ul class="simple">
<li>“*” means “any value in this cell is acceptable”</li>
<li>“T” means “any non-false value (0, 1 or 2) is acceptable”</li>
</ul>
<p>So for example, one possible dock we did not include in our example graphic is a dock with a two-dimensional intersection with the lake boundary:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">docks</span> <span class="p">(</span> <span class="n">geom</span><span class="p">,</span> <span class="n">good</span> <span class="p">)</span>
  <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;LINESTRING (140 230, 150 250, 210 230)&#39;</span><span class="p">,</span><span class="k">true</span><span class="p">);</span>
</pre></div>
</div>
<img alt="_images/de9im9.jpg" class="inline" src="_images/de9im9.jpg" />
<p>If we are to include this case in our set of “legal” docks, we need to change the relate pattern in our query. In particular, the intersection of the dock interior lake boundary can now be either 1 (our new case) or F (our original case). So we use the “*” catchall in the pattern.</p>
<img alt="_images/de9im10.jpg" class="inline" src="_images/de9im10.jpg" />
<p>And the SQL looks like this:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">docks</span><span class="p">.</span><span class="o">*</span>
<span class="k">FROM</span> <span class="n">docks</span> <span class="k">JOIN</span> <span class="n">lakes</span> <span class="k">ON</span> <span class="n">ST_Intersects</span><span class="p">(</span><span class="n">docks</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">lakes</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span>
<span class="k">WHERE</span> <span class="n">ST_Relate</span><span class="p">(</span><span class="n">docks</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">lakes</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="s1">&#39;1*F00F212&#39;</span><span class="p">);</span>

<span class="c1">-- Answer: our (now) three good docks</span>
</pre></div>
</div>
<p>Confirm that the stricter SQL from the previous example does <em>not</em> return the new dock.</p>
<p>The TIGER data is carefully quality controlled when it is prepared, so we expect our data to meet strict standards. For example: no census block should overlap any other census block. Can we test for that?</p>
<img alt="_images/de9im11.jpg" class="inline" src="_images/de9im11.jpg" />
<p>Sure!</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">id</span>
<span class="k">FROM</span> <span class="n">nyc_census_blocks</span> <span class="n">a</span><span class="p">,</span> <span class="n">nyc_census_blocks</span> <span class="n">b</span>
<span class="k">WHERE</span> <span class="n">ST_Intersects</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span>
  <span class="k">AND</span> <span class="n">ST_Relate</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="s1">&#39;2********&#39;</span><span class="p">)</span>
  <span class="k">AND</span> <span class="n">a</span><span class="p">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">b</span><span class="p">.</span><span class="n">id</span>
<span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>

<span class="c1">-- Answer: 10, there&#39;s some funny business</span>
</pre></div>
</div>
<p>Similarly, we would expect that the roads data is all end-noded. That is, we expect that intersections only occur at the ends of lines, not at the mid-points.</p>
<img alt="_images/de9im12.jpg" class="inline" src="_images/de9im12.jpg" />
<p>We can test for that by looking for streets that intersect (so we have a join) but where the intersection between the boundaries is not zero-dimensional (that is, the end points don’t touch):</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">id</span>
<span class="k">FROM</span> <span class="n">nyc_streets</span> <span class="n">a</span><span class="p">,</span> <span class="n">nyc_streets</span> <span class="n">b</span>
<span class="k">WHERE</span> <span class="n">ST_Intersects</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span>
  <span class="k">AND</span> <span class="k">NOT</span> <span class="n">ST_Relate</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="s1">&#39;****0****&#39;</span><span class="p">)</span>
  <span class="k">AND</span> <span class="n">a</span><span class="p">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">b</span><span class="p">.</span><span class="n">id</span>
<span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>

<span class="c1">-- Answer: 10, this happens, so the data is not end-noded.</span>
</pre></div>
</div>
<div class="section" id="id7">
<h3>6.5.1. Function List<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://postgis.net/docs/ST_Relate.html">ST_Relate(geometry A, geometry B)</a>: Returns a text string representing the DE9IM relationship between the geometries.</p>
</div>
</div>
<div class="section" id="clustering-on-indices">
<span id="clusterindex"></span><h2>6.6. Clustering on Indices<a class="headerlink" href="#clustering-on-indices" title="Permalink to this headline">¶</a></h2>
<p>Databases can only retrieve information as fast as they can get it off of disk. Small databases will float up entirely into RAM cache, and get away from physical disk limitations, but for large databases, access to the physical disk will be a limiting stop in disk access speed.</p>
<p>Data is written to disk opportunistically, so there is not necessarily any correlation between the order data is stored on the disk and the way it will be accessed or organized by applications. With the advent of Solid State Disks (SSD) this is changing to improve performance, <a class="reference external" href="https://postgis.net/docs/using_postgis_dbmanagement.html#idm2461">in the postgis Data Management and Queries</a> is mentioned the configuration for an index on an SSD.</p>
<img alt="_images/clustering1.jpg" class="inline" src="_images/clustering1.jpg" />
<p>One way to speed up access to data is to ensure that records which is likely to be retrieved together in the same result set are located in similar physical locations on the hard disk platters. This is called “clustering”.</p>
<p>The right clustering scheme to use can be tricky, but a general rule applies: indexes define a natural ordering scheme for data which is similar to the access pattern that will be used in retrieving the data.</p>
<img alt="_images/clustering2.jpg" class="inline" src="_images/clustering2.jpg" />
<p>Because of this, ordering the data on the disk in the same order as the index can provide a speed advantage in some cases.</p>
<div class="section" id="clustering-on-the-r-tree">
<h3>6.6.1. Clustering on the R-Tree<a class="headerlink" href="#clustering-on-the-r-tree" title="Permalink to this headline">¶</a></h3>
<p>Spatial data tends to be accessed in spatially correlated windows: think of the map window in a web or desktop application. All the data in the windows has similar location value (or it wouldn’t be in the window!)</p>
<p>So, clustering based on a spatial index makes sense for spatial data that is going to be accessed with spatial queries: similar things tend to have similar locations.</p>
<p>Let’s cluster our <code class="docutils literal notranslate"><span class="pre">nyc_census_blocks</span></code> based on their spatial index:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Cluster the blocks based on their spatial index</span>
<span class="k">CLUSTER</span> <span class="n">nyc_census_blocks</span> <span class="k">USING</span> <span class="n">sidx_nyc_census_blocks_geom</span><span class="p">;</span>
</pre></div>
</div>
<p>The command re-writes the <code class="docutils literal notranslate"><span class="pre">nyc_census_blocks</span></code> in the order defined by the spatial index <code class="docutils literal notranslate"><span class="pre">sidx_nyc_census_blocks_geom</span></code>. Can you perceive a speed difference? Probably not, because the table is quite small and easily fits into memory, so disk access overhead doesn’t affect performance.</p>
<p>One of the surprises of the R-Tree is that an R-Tree built incrementally on spatial data might not have high spatial coherence of the leaves. For example, see this visualization of the spatial index leaves of an index on roads in the province of British Columbia.</p>
<img alt="_images/clustering3.jpg" class="inline" src="_images/clustering3.jpg" />
<p>We would prefer to cluster using a more spatially compact tree, like this balanced R-Tree.</p>
<img alt="_images/clustering4.jpg" class="inline" src="_images/clustering4.jpg" />
<p>We don’t have a balanced R-Tree algorithm available in PostGIS, but we do have a useful proxy that puts spatial data into a spatially autocorrelated order, the <strong>ST_GeoHash()</strong> function.</p>
</div>
<div class="section" id="clustering-on-geohash">
<h3>6.6.2. Clustering on GeoHash<a class="headerlink" href="#clustering-on-geohash" title="Permalink to this headline">¶</a></h3>
<p>To cluster on the ST_GeoHash() function, you first need to have a geohash index on your data. Fortunately, they are easy to build.</p>
<p>Geohash is a public domain geocode system invented in 2008 by Gustavo Niemeyer, it encodes a geographic location into a short string of letters and digits. The first step is decoding it from a variant of base 32 using all digits 0-9 and almost all lower case letters except a, i, l and o, here is an example following the <a class="reference external" href="https://en.wikipedia.org/wiki/Geohash">hash ezs42</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Decimal</span> <span class="o">|</span> <span class="n">Base</span> <span class="mi">32</span>
<span class="o">------------------</span>
    <span class="mi">0</span>   <span class="o">|</span> <span class="mi">0</span>
    <span class="mi">1</span>   <span class="o">|</span> <span class="mi">1</span>
    <span class="mi">2</span>   <span class="o">|</span> <span class="mi">2</span>
    <span class="mi">3</span>   <span class="o">|</span> <span class="mi">3</span>
    <span class="mi">4</span>   <span class="o">|</span> <span class="mi">4</span>
    <span class="mi">5</span>   <span class="o">|</span> <span class="mi">5</span>
    <span class="mi">6</span>   <span class="o">|</span> <span class="mi">6</span>
    <span class="mi">7</span>   <span class="o">|</span> <span class="mi">7</span>
    <span class="mi">8</span>   <span class="o">|</span> <span class="mi">8</span>
    <span class="mi">9</span>   <span class="o">|</span> <span class="mi">9</span>
    <span class="mi">10</span>  <span class="o">|</span> <span class="n">b</span>
    <span class="mi">11</span>  <span class="o">|</span> <span class="n">c</span>
    <span class="mi">12</span>  <span class="o">|</span> <span class="n">d</span>
    <span class="mi">13</span>  <span class="o">|</span> <span class="n">e</span>
    <span class="mi">14</span>  <span class="o">|</span> <span class="n">f</span>
    <span class="mi">15</span>  <span class="o">|</span> <span class="n">g</span>
    <span class="mi">16</span>  <span class="o">|</span> <span class="n">h</span>
    <span class="mi">17</span>  <span class="o">|</span> <span class="n">j</span>
    <span class="mi">18</span>  <span class="o">|</span> <span class="n">k</span>
    <span class="mi">19</span>  <span class="o">|</span> <span class="n">m</span>
    <span class="mi">20</span>  <span class="o">|</span> <span class="n">n</span>
    <span class="mi">21</span>  <span class="o">|</span> <span class="n">p</span>
    <span class="mi">22</span>  <span class="o">|</span> <span class="n">q</span>
    <span class="mi">23</span>  <span class="o">|</span> <span class="n">r</span>
    <span class="mi">24</span>  <span class="o">|</span> <span class="n">s</span>
    <span class="mi">25</span>  <span class="o">|</span> <span class="n">t</span>
    <span class="mi">26</span>  <span class="o">|</span> <span class="n">u</span>
    <span class="mi">27</span>  <span class="o">|</span> <span class="n">v</span>
    <span class="mi">28</span>  <span class="o">|</span> <span class="n">w</span>
    <span class="mi">29</span>  <span class="o">|</span> <span class="n">y</span>
    <span class="mi">30</span>  <span class="o">|</span> <span class="n">z</span>
</pre></div>
</div>
<p>This operation results in the bits 01101 11111 11000 00100 00010. Assuming that counting starts at 0 in the left side, the even bits are taken for the longitude code (0111110000000), while the odd bits are taken for the latitude code (101111001001).</p>
<p>Each binary code is then used in a series of divisions, considering one bit at a time, again from the left to the right side. For the latitude value, the interval -90 to +90 is divided by 2, producing two intervals: -90 to 0, and 0 to +90. Since the first bit is 1, the higher interval is chosen, and becomes the current interval. The procedure is repeated for all bits in the code. Finally, the latitude value is the center of the resulting interval. Longitudes are processed in an equivalent way, keeping in mind that the initial interval is -180 to +180.</p>
<p>The geohash algorithm only works on data in geographic (longitude/latitude) coordinates, so we need to transform the geometries (to EPSG:4326, which is longitude/latitude) at the same time as we hash them.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">geohash_nyc_census_blocks</span> <span class="k">ON</span> <span class="n">nyc_census_blocks</span> <span class="p">(</span><span class="n">ST_GeoHash</span><span class="p">(</span><span class="n">ST_Transform</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span><span class="mi">4326</span><span class="p">)));</span>
</pre></div>
</div>
<p>Once you have a geohash index, clustering on it uses the same syntax as the R-Tree clustering.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CLUSTER</span> <span class="n">nyc_census_blocks</span> <span class="k">USING</span> <span class="n">geohash_nyc_census_blocks</span><span class="p">;</span>
</pre></div>
</div>
<p>Now your data is nicely arranged in spatially correlated order!</p>
</div>
<div class="section" id="id8">
<h3>6.6.3. Function List<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://postgis.net/docs/ST_GeoHash.html">ST_GeoHash(geometry A)</a>: Returns a text string representing the GeoHash of the bounds of the object.</p>
</div>
</div>
<div class="section" id="d">
<span id="id9"></span><h2>6.7. 3-D<a class="headerlink" href="#d" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This section refers to many features that are only available with PostGIS 2.0 and higher.</p>
</div>
<div class="section" id="d-geometries">
<h3>6.7.1. 3-D Geometries<a class="headerlink" href="#d-geometries" title="Permalink to this headline">¶</a></h3>
<p>So far, we have been working with 2-D geometries, with only X and Y coordinates. But PostGIS supports additional dimensions on all geometry types, a “Z” dimension to add height information and a “M” dimension for additional dimensional information (commonly time, or road-mile, or upstream-distance information) for each coordinate.</p>
<p>For 3-D and 4-D geometries, the extra dimensions are added as extra coordinates for each vertex in the geometry, and the geometry type is enhanced to indicate how to interpret the extra dimensions. Adding the extra dimensions results in three extra possible geometry types for each geometry primitive:</p>
<ul class="simple">
<li>Point (a 2-D type)i is joined by PointZ, PointM and PointZM types.</li>
<li>Linestring (a 2-D type) is joined by LinestringZ, LinestringM and LinestringZM types.</li>
<li>Polygon (a 2-D type) is joined by PolygonZ, PolygonM and PolygonZM types.</li>
<li>And so on.</li>
</ul>
<p>For well-known text (<a class="reference internal" href="glossary.html#term-wkt"><span class="xref std std-term">WKT</span></a>) representation, the format for higher dimensional geometries is given by the ISO SQL/MM specification. The extra dimensionality information is simply added to the text string after the type name, and the extra coordinates added after the X/Y information. For example:</p>
<ul class="simple">
<li>POINT ZM (1 2 3 4)</li>
<li>LINESTRING M (1 1 0, 1 2 0, 1 3 1, 2 2 0)</li>
<li>POLYGON Z ((0 0 0, 0 1 0, 1 1 0, 1 0 0, 0 0 0))</li>
</ul>
<p>The ST_AsText() function will return the above representations when dealing with 3-D and 4-D geometries.</p>
<p>For well-known binary (<a class="reference internal" href="glossary.html#term-wkb"><span class="xref std std-term">WKB</span></a>) representation, the format for higher dimensional geometries is given by the ISO SQL/MM specification. The BNF form of the format is available from <a class="reference external" href="http://svn.osgeo.org/postgis/trunk/doc/bnf-wkb.txt">http://svn.osgeo.org/postgis/trunk/doc/bnf-wkb.txt</a>.</p>
<p>In addition to higher-dimensional forms of the standard types, PostGIS includes a few new types that make sense in a 3-D space:</p>
<ul class="simple">
<li>The TIN type allows you to model triangular meshes as rows in your database.</li>
<li>The POLYHEDRALSURFACE allows you to model volumetric objects in your database.</li>
</ul>
<p>Since both these types are for modelling 3-D objects, it only really makes sense to use the Z variants.  An example of a POLYHEDRALSURFACE Z would be the 1 unit cube:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">POLYHEDRALSURFACE</span> <span class="n">Z</span> <span class="p">(</span>
  <span class="p">((</span><span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="mi">1</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">)),</span>
  <span class="p">((</span><span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">)),</span>
  <span class="p">((</span><span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="mi">0</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">)),</span>
  <span class="p">((</span><span class="mi">1</span> <span class="mi">1</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="mi">0</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="mi">1</span> <span class="mi">1</span><span class="p">)),</span>
  <span class="p">((</span><span class="mi">1</span> <span class="mi">1</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="mi">0</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="mi">1</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="mi">1</span> <span class="mi">1</span><span class="p">)),</span>
  <span class="p">((</span><span class="mi">1</span> <span class="mi">1</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="mi">1</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="mi">1</span> <span class="mi">1</span><span class="p">))</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="d-functions">
<h3>6.7.2. 3-D Functions<a class="headerlink" href="#d-functions" title="Permalink to this headline">¶</a></h3>
<p>There are a number of functions built to calculate relationships between 3-D objects:</p>
<ul class="simple">
<li>ST_3DClosestPoint — Returns the 3-dimensional point on g1 that is closest to g2. This is the first point of the 3D shortest line.</li>
<li>ST_3DDistance — For geometry type Returns the 3-dimensional cartesian minimum distance (based on spatial ref) between two geometries in projected units.</li>
<li>ST_3DDWithin — For 3d (z) geometry type Returns true if two geometries 3d distance is within number of units.</li>
<li>ST_3DDFullyWithin — Returns true if all of the 3D geometries are within the specified distance of one another.</li>
<li>ST_3DIntersects — Returns TRUE if the Geometries “spatially intersect” in 3d - only for points and linestrings</li>
<li>ST_3DLongestLine — Returns the 3-dimensional longest line between two geometries</li>
<li>ST_3DMaxDistance — For geometry type Returns the 3-dimensional cartesian maximum distance (based on spatial ref) between two geometries in projected units.</li>
<li>ST_3DShortestLine — Returns the 3-dimensional shortest line between two geometries</li>
</ul>
<p>For example, we can calculate the distance between our unit cube and a point using the ST_3DDistance function:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- This is really the distance between the top corner</span>
<span class="c1">-- and the point.</span>
<span class="k">SELECT</span> <span class="n">ST_3DDistance</span><span class="p">(</span>
  <span class="s1">&#39;POLYHEDRALSURFACE Z (</span>
<span class="s1">    ((0 0 0, 0 1 0, 1 1 0, 1 0 0, 0 0 0)),</span>
<span class="s1">    ((0 0 0, 0 1 0, 0 1 1, 0 0 1, 0 0 0)),</span>
<span class="s1">    ((0 0 0, 1 0 0, 1 0 1, 0 0 1, 0 0 0)),</span>
<span class="s1">    ((1 1 1, 1 0 1, 0 0 1, 0 1 1, 1 1 1)),</span>
<span class="s1">    ((1 1 1, 1 0 1, 1 0 0, 1 1 0, 1 1 1)),</span>
<span class="s1">    ((1 1 1, 1 1 0, 0 1 0, 0 1 1, 1 1 1))</span>
<span class="s1">  )&#39;</span><span class="p">::</span><span class="n">geometry</span><span class="p">,</span>
  <span class="s1">&#39;POINT Z (2 2 2)&#39;</span><span class="p">::</span><span class="n">geometry</span>
<span class="p">);</span>

<span class="c1">-- So here&#39;s a shorter form.</span>
<span class="k">SELECT</span> <span class="n">ST_3DDistance</span><span class="p">(</span>
  <span class="s1">&#39;POINT Z (1 1 1)&#39;</span><span class="p">::</span><span class="n">geometry</span><span class="p">,</span>
  <span class="s1">&#39;POINT Z (2 2 2)&#39;</span><span class="p">::</span><span class="n">geometry</span>
<span class="p">);</span>

<span class="c1">-- Both return 1.73205080756888 == sqrt(3) as expected</span>
</pre></div>
</div>
</div>
<div class="section" id="n-d-indexes">
<h3>6.7.3. N-D Indexes<a class="headerlink" href="#n-d-indexes" title="Permalink to this headline">¶</a></h3>
<p>Once you have data in higher dimensions it may make sense to index it. However, you should think carefully about the distribution of your data in all dimensions before applying a multi-dimensional index.</p>
<p>Indexes are only useful when they allow the database to drastically reduce the number of return rows as a result of a WHERE condition. For a higher dimension index to be useful, the data must cover a wide range of that dimension, relative to the kinds of queries you are constructing.</p>
<ul class="simple">
<li>A set of DEM points would probably be a <em>poor</em> candidate for a 3-D index, since the queries would usually be extracting a 2-D box of points, and rarely attempting to select a Z-slice of points.</li>
<li>A set of GPS traces in X/Y/T space might be a <em>good</em> candidate for a 3-D index, if the GPS tracks overlapped each other frequently in all dimensions (for example, driving the same route over and over at different times), since there would be large variability in all dimensions of the data set.</li>
</ul>
<p>You can create a multi-dimensional index on data of any dimensionality (even mixed dimensionality). For example, to create a multi-dimensional index on the <code class="docutils literal notranslate"><span class="pre">nyc_streets</span></code> table,</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">sidx_nd_nyc_streets</span> <span class="k">ON</span> <span class="n">nyc_streets</span>
<span class="k">USING</span> <span class="n">GIST</span> <span class="p">(</span><span class="n">geom</span> <span class="n">gist_geometry_ops_nd</span><span class="p">);</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">gist_geometry_ops_nd</span></code> parameter tells PostGIS to use the N-D index instead of the standard 2-D index.</p>
<p>Once you have the index built, you can use it in queries with the <code class="docutils literal notranslate"><span class="pre">&amp;&amp;&amp;</span></code> index operator. <code class="docutils literal notranslate"><span class="pre">&amp;&amp;&amp;</span></code> has the same semantics as <code class="docutils literal notranslate"><span class="pre">&amp;&amp;</span></code>, “bounding boxes interact”, but applies those semantics using all the dimensions of the input geometries. Geometries with mis-matching dimensionality do not interact.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Returns true (both 3-D on the zero plane)</span>
<span class="k">SELECT</span> <span class="s1">&#39;POINT Z (1 1 0)&#39;</span><span class="p">::</span><span class="n">geometry</span> <span class="o">&amp;&amp;&amp;</span>
       <span class="s1">&#39;POLYGON ((0 0 0, 0 2 0, 2 2 0, 2 0 0, 0 0 0))&#39;</span><span class="p">::</span><span class="n">geometry</span><span class="p">;</span>

<span class="c1">-- Returns false (one 2-D one 3-D)</span>
<span class="k">SELECT</span> <span class="s1">&#39;POINT Z (1 1 1)&#39;</span><span class="p">::</span><span class="n">geometry</span> <span class="o">&amp;&amp;&amp;</span>
       <span class="s1">&#39;POLYGON ((0 0, 0 2, 2 2, 2 0, 0 0))&#39;</span><span class="p">::</span><span class="n">geometry</span><span class="p">;</span>

<span class="c1">-- Returns true (the volume around the linestring interacts with the point)</span>
<span class="k">SELECT</span> <span class="s1">&#39;LINESTRING Z(0 0 0, 1 1 1)&#39;</span><span class="p">::</span><span class="n">geometry</span> <span class="o">&amp;&amp;&amp;</span>
       <span class="s1">&#39;POINT(0 1 1)&#39;</span><span class="p">::</span><span class="n">geometry</span><span class="p">;</span>
</pre></div>
</div>
<p>To search the <code class="docutils literal notranslate"><span class="pre">nyc_streets</span></code> table using the N-D index, just replace the usual <code class="docutils literal notranslate"><span class="pre">&amp;&amp;</span></code> 2-D index operator with the <code class="docutils literal notranslate"><span class="pre">&amp;&amp;&amp;</span></code> operator.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- N-D index operator</span>
<span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">name</span>
<span class="k">FROM</span> <span class="n">nyc_streets</span>
<span class="k">WHERE</span> <span class="n">geom</span> <span class="o">&amp;&amp;&amp;</span>
      <span class="n">ST_SetSRID</span><span class="p">(</span><span class="s1">&#39;LINESTRING(586785 4492901,587561 4493037)&#39;</span><span class="p">::</span><span class="n">geometry</span><span class="p">,</span><span class="mi">26918</span><span class="p">);</span>

<span class="c1">-- 2-D index operator</span>
<span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">name</span>
<span class="k">FROM</span> <span class="n">nyc_streets</span>
<span class="k">WHERE</span> <span class="n">geom</span> <span class="o">&amp;&amp;</span>
      <span class="n">ST_SetSRID</span><span class="p">(</span><span class="s1">&#39;LINESTRING(586785 4492901,587561 4493037)&#39;</span><span class="p">::</span><span class="n">geometry</span><span class="p">,</span><span class="mi">26918</span><span class="p">);</span>
</pre></div>
</div>
<p>The results should be the same. In general the N-D index is very slightly slower than the 2-D index, so only use the N-D index where you are certain that N-D queries will improve the selectivity of your queries.</p>
</div>
</div>
<div class="section" id="nearest-neighbour-searching">
<span id="knn"></span><h2>6.8. Nearest-Neighbour Searching<a class="headerlink" href="#nearest-neighbour-searching" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This section refers to a feature that is only available with PostGIS 2.0 and higher.</p>
</div>
<div class="section" id="what-is-a-nearest-neighbour-search">
<h3>6.8.1. What is a Nearest Neighbour Search?<a class="headerlink" href="#what-is-a-nearest-neighbour-search" title="Permalink to this headline">¶</a></h3>
<p>A frequently posed spatial query is: “what is the nearest &lt;candidate feature&gt; to &lt;query feature&gt;?”</p>
<p>Unlike a distance search, the “nearest neighbour” search doesn’t include any measurement restricting how far away candidate geometries might be, features of any distance away will be accepted, as long as they are the <em>nearest</em>. This poses a problem for traditional index-assisted queries, that require a search box, and therefore need some kind of measurement value to build the box.</p>
<p>The naive way to carry out a nearest neighbour query is to order the candidate table by distance from the query geometry, and then take the record with the smallest distance:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Closest street to Broad Street station is Wall St</span>
<span class="k">SELECT</span> <span class="n">streets</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">streets</span><span class="p">.</span><span class="n">name</span>
<span class="k">FROM</span>
  <span class="n">nyc_streets</span> <span class="n">streets</span><span class="p">,</span>
  <span class="n">nyc_subway_stations</span> <span class="n">subways</span>
<span class="k">WHERE</span> <span class="n">subways</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Broad St&#39;</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">ST_Distance</span><span class="p">(</span><span class="n">streets</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">subways</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span> <span class="k">ASC</span>
<span class="k">LIMIT</span> <span class="mi">1</span><span class="p">;</span>
</pre></div>
</div>
<p>The trouble with this approach is that it forces the database to calculate the distance between the query geometry and <em>every</em> feature in the table of candidate features, then sort them all. For a large table of  candidate features, it is not a reasonable approach.</p>
<p>One way to improve performance is to add an index constraint to the search. This requires a magic number: what’s the smallest box we could search around the query geometry, and still come up with at least one candidate geometry?</p>
<p>If you turn on timing, you can see the performance difference between the box-assisted query below and the simple query above.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Closest street to Broad Street station is Wall St</span>
<span class="k">SELECT</span> <span class="n">streets</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">streets</span><span class="p">.</span><span class="n">name</span>
<span class="k">FROM</span>
  <span class="n">nyc_streets</span> <span class="n">streets</span><span class="p">,</span>
  <span class="n">nyc_subway_stations</span> <span class="n">subways</span>
<span class="k">WHERE</span> <span class="n">subways</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Broad St&#39;</span>
<span class="k">AND</span> <span class="n">streets</span><span class="p">.</span><span class="n">geom</span> <span class="o">&amp;&amp;</span> <span class="n">ST_Expand</span><span class="p">(</span><span class="n">subways</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span> <span class="c1">-- Magic number: 200m</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">ST_Distance</span><span class="p">(</span><span class="n">streets</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">subways</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span> <span class="k">ASC</span>
<span class="k">LIMIT</span> <span class="mi">1</span><span class="p">;</span>
</pre></div>
</div>
<p>The problem with this approach is the magic number of 200 meters. What if there had not happened to be any roads within 200m? We would have failed to come up with a result: there is always a nearest neighbour, it just might not be within 200m.</p>
</div>
<div class="section" id="index-based-knn">
<h3>6.8.2. Index-based KNN<a class="headerlink" href="#index-based-knn" title="Permalink to this headline">¶</a></h3>
<p>“KNN” stands for “K nearest neighbours”, where “K” is the number of neighbours you are looking for.</p>
<p>KNN is a pure index based nearest neighbour search. By walking up and down the index, the search can find the nearest candidate geometries without using any magical search radius numbers, so the technique is suitable and high performance even for very large tables with highly variable data densities.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The KNN feature is only available on PostGIS 2.0 with PostgreSQL 9.1 or greater.</p>
</div>
<p>The KNN system works by evaluating distances between bounding boxes inside the PostGIS R-Tree index.</p>
<p>Because the index is built using the bounding boxes of geometries, the distances between any geometries that are not points will be inexact: they will be the distances between the bounding boxes of geometries.</p>
<p>The syntax of the index-based KNN query places a special “index-based distance operator” in the ORDER BY clause of the query, in this case “&lt;-&gt;”. There are two index-based distance operators,</p>
<ul class="simple">
<li><strong>&lt;-&gt;</strong> means “distance between geometries”</li>
<li><strong>&lt;#&gt;</strong> means “distance between bounding boxes”</li>
</ul>
<p>One side of the index-based distance operator must be a literal geometry value. We can get away with a subquery that returns as single geometry, or we could include a <a class="reference internal" href="glossary.html#term-wkt"><span class="xref std std-term">WKT</span></a> geometry instead.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Closest 10 streets to Broad Street station are ?</span>
<span class="k">SELECT</span>
  <span class="n">streets</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
  <span class="n">streets</span><span class="p">.</span><span class="n">name</span>
<span class="k">FROM</span>
  <span class="n">nyc_streets</span> <span class="n">streets</span>
<span class="k">ORDER</span> <span class="k">BY</span>
  <span class="n">streets</span><span class="p">.</span><span class="n">geom</span> <span class="o">&lt;-&gt;</span>
  <span class="p">(</span><span class="k">SELECT</span> <span class="n">geom</span> <span class="k">FROM</span> <span class="n">nyc_subway_stations</span> <span class="k">WHERE</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Broad St&#39;</span><span class="p">)</span>
<span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>

<span class="c1">-- Same query using a geometry EWKT literal</span>

<span class="k">SELECT</span> <span class="n">ST_AsEWKT</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">nyc_subway_stations</span>
<span class="k">WHERE</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Broad St&#39;</span><span class="p">;</span>
<span class="c1">-- SRID=26918;POINT(583571 4506714)</span>

<span class="k">SELECT</span>
  <span class="n">streets</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
  <span class="n">streets</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
  <span class="n">ST_Distance</span><span class="p">(</span>
    <span class="n">streets</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span>
    <span class="s1">&#39;SRID=26918;POINT(583571.905921312 4506714.34119218)&#39;</span><span class="p">::</span><span class="n">geometry</span>
    <span class="p">)</span> <span class="k">AS</span> <span class="n">distance</span>
<span class="k">FROM</span>
  <span class="n">nyc_streets</span> <span class="n">streets</span>
<span class="k">ORDER</span> <span class="k">BY</span>
  <span class="n">streets</span><span class="p">.</span><span class="n">geom</span> <span class="o">&lt;-&gt;</span>
  <span class="s1">&#39;SRID=26918;POINT(583571.905921312 4506714.34119218)&#39;</span><span class="p">::</span><span class="n">geometry</span>
<span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="nb">id</span>   <span class="o">|</span>    <span class="n">name</span>     <span class="o">|</span>     <span class="n">distance</span>
<span class="o">-------+-------------+-------------------</span>
 <span class="mi">17394</span> <span class="o">|</span> <span class="n">Wall</span> <span class="n">St</span>     <span class="o">|</span> <span class="mf">0.714202224374917</span>
 <span class="mi">17399</span> <span class="o">|</span> <span class="n">Broad</span> <span class="n">St</span>    <span class="o">|</span> <span class="mf">0.872022763400183</span>
 <span class="mi">17445</span> <span class="o">|</span> <span class="n">Nassau</span> <span class="n">St</span>   <span class="o">|</span>  <span class="mf">1.29928727926582</span>
 <span class="mi">17357</span> <span class="o">|</span> <span class="n">New</span> <span class="n">St</span>      <span class="o">|</span>  <span class="mf">63.9499165490674</span>
 <span class="mi">17411</span> <span class="o">|</span> <span class="n">Pine</span> <span class="n">St</span>     <span class="o">|</span>  <span class="mf">75.8461038368021</span>
 <span class="mi">17367</span> <span class="o">|</span> <span class="n">Exchange</span> <span class="n">Pl</span> <span class="o">|</span>    <span class="mf">101.6241843136</span>
 <span class="mi">17322</span> <span class="o">|</span> <span class="n">Broadway</span>    <span class="o">|</span>  <span class="mf">112.049824188021</span>
 <span class="mi">17296</span> <span class="o">|</span> <span class="n">Rector</span> <span class="n">St</span>   <span class="o">|</span>  <span class="mf">114.442000781044</span>
 <span class="mi">17478</span> <span class="o">|</span> <span class="n">William</span> <span class="n">St</span>  <span class="o">|</span>  <span class="mf">126.934064759446</span>
 <span class="mi">17354</span> <span class="o">|</span> <span class="n">Cedar</span> <span class="n">St</span>    <span class="o">|</span>  <span class="mf">133.009278387597</span>
</pre></div>
</div>
<p>Remember that all the calculations are being done using geometries. Here’s what the map looks like for the results of the query:</p>
<img alt="_images/knn0.png" src="_images/knn0.png" />
<p>We can see that the station falls right on the Wall Street line so the <strong>&lt;-&gt;</strong> operator computes the distance between geometries giving the proper answer. Moreover, the <strong class="command">ST_Distance</strong> is in alignment with the order provided by the <strong>&lt;-&gt;</strong> operator, proving the knn functionality works!</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For versions of PostgreSQL below 9.5 the <strong>&lt;-&gt;</strong> operator would compute distances using the centroid of the bounding boxes of the geometries, producing sometimes approximations that don’t match a nearest neighbour search between geometries.</p>
</div>
<p>What about the <strong>&lt;#&gt;</strong> operator? If we calculate the distance between box edges, the station would fall <strong>inside</strong> the Wall Street box, giving it a distance of zero and the first entry in the list, right?</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Closest 10 streets to Broad Street station are ?</span>
<span class="k">SELECT</span>
  <span class="n">streets</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
  <span class="n">streets</span><span class="p">.</span><span class="n">name</span>
<span class="k">FROM</span>
  <span class="n">nyc_streets</span> <span class="n">streets</span>
<span class="k">ORDER</span> <span class="k">BY</span>
  <span class="n">streets</span><span class="p">.</span><span class="n">geom</span> <span class="o">&lt;#&gt;</span>
  <span class="s1">&#39;SRID=26918;POINT(583571.905921312 4506714.34119218)&#39;</span><span class="p">::</span><span class="n">geometry</span>
<span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>
</pre></div>
</div>
<p>Unfortunately, no.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="nb">id</span>   <span class="o">|</span>                               <span class="n">name</span>
<span class="o">-------+------------------------------------------------------------------</span>
 <span class="mi">17315</span> <span class="o">|</span> <span class="n">Pearl</span> <span class="n">St</span>
 <span class="mi">17364</span> <span class="o">|</span> <span class="n">South</span> <span class="n">St</span>
 <span class="mi">17394</span> <span class="o">|</span> <span class="n">Wall</span> <span class="n">St</span>
 <span class="mi">17411</span> <span class="o">|</span> <span class="n">Pine</span> <span class="n">St</span>
 <span class="mi">17378</span> <span class="o">|</span> <span class="n">FDR</span> <span class="n">Dr</span>
 <span class="mi">17236</span> <span class="o">|</span>
 <span class="mi">17241</span> <span class="o">|</span> <span class="n">West</span> <span class="n">Side</span> <span class="n">Highway</span><span class="p">;</span> <span class="n">West</span> <span class="n">St</span><span class="p">;</span> <span class="n">West</span> <span class="n">Side</span> <span class="n">Highway</span><span class="p">;</span> <span class="n">West</span> <span class="n">Side</span> <span class="n">Highway</span>
 <span class="mi">17322</span> <span class="o">|</span> <span class="n">Broadway</span>
 <span class="mi">17382</span> <span class="o">|</span> <span class="n">FDR</span> <span class="n">Dr</span>
 <span class="mi">17399</span> <span class="o">|</span> <span class="n">Broad</span> <span class="n">St</span>
</pre></div>
</div>
<p>There are a number of large street features with big boxes that <strong>also</strong> overlap the station and yield a box distance of zero.</p>
<img alt="_images/knn3.jpg" src="_images/knn3.jpg" />
<p>This may not give the results we were expecting but since it operates on bounding boxes, it provides better performance than the query using <strong>&lt;-&gt;</strong>. In case we had a very large table we could enhance the query processing by limiting our search first using the operator <strong>&lt;#&gt;</strong> and then use the operator <strong>&lt;-&gt;</strong> in the resulting subset to get the accurate nearest neighbours:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span>  <span class="c1">-- &quot;Closest&quot; 100 streets to Broad Street station are?</span>
<span class="k">WITH</span> <span class="n">closest_candidates</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span>
    <span class="n">streets</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
    <span class="n">streets</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
    <span class="n">streets</span><span class="p">.</span><span class="n">geom</span>
  <span class="k">FROM</span>
    <span class="n">nyc_streets</span> <span class="n">streets</span>
  <span class="k">ORDER</span> <span class="k">BY</span>
    <span class="n">streets</span><span class="p">.</span><span class="n">geom</span> <span class="o">&lt;#&gt;</span>
    <span class="s1">&#39;SRID=26918;POINT(583571.905921312 4506714.34119218)&#39;</span><span class="p">::</span><span class="n">geometry</span>
  <span class="k">LIMIT</span> <span class="mi">100</span>
<span class="p">)</span>
<span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">name</span>
<span class="k">FROM</span> <span class="n">closest_candidates</span>
<span class="k">ORDER</span> <span class="k">BY</span>
  <span class="n">geom</span> <span class="o">&lt;-&gt;</span>
    <span class="s1">&#39;SRID=26918;POINT(583571.905921312 4506714.34119218)&#39;</span><span class="p">::</span><span class="n">geometry</span>
<span class="k">LIMIT</span> <span class="mi">1</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="nb">id</span>   <span class="o">|</span>  <span class="n">name</span>
<span class="o">-------+---------</span>
 <span class="mi">17394</span> <span class="o">|</span> <span class="n">Wall</span> <span class="n">St</span>
</pre></div>
</div>
<p><a class="reference external" href="http://postgis.net/docs/geometry_distance_knn.html">knn &lt;-&gt;</a>: returns the 2D distance between two geometries.</p>
<p><a class="reference external" href="http://postgis.net/docs/geometry_distance_box.html">knn &lt;#&gt;</a>: returns the distance between two bounding boxes.</p>
</div>
</div>
<div class="section" id="tracking-edit-history-using-triggers">
<span id="history-tracking"></span><h2>6.9. Tracking Edit History using Triggers<a class="headerlink" href="#tracking-edit-history-using-triggers" title="Permalink to this headline">¶</a></h2>
<p>A common requirement for production databases is the ability to track history: how has the data changed between two dates, who made the changes, and where did they occur? Some GIS systems track changes by including change management in the client interface, but that adds a lot of complexity to editing tools.</p>
<p>Using the database and the trigger system, it’s possible to add history tracking to any table, while maintaining simple “direct edit” access to the primary table.</p>
<p>History tracking works by keeping a history table that records, for every edit:</p>
<ul class="simple">
<li>If a record was created, when it was added and by whom.</li>
<li>If a record was deleted, when it was deleted and by whom.</li>
<li>If a record was updated, adding a deletion record (for the old state) and a creation record (for the new state).</li>
</ul>
<p>Using this information it is possible to reconstruct the state of the edit table at any point in time. In this example, we will add history tracking to our <strong>nyc_streets</strong> table.</p>
<ul>
<li><p class="first">First, add a new <strong>nyc_streets_history</strong> table. This is the table we will use to store all the historical edit information. In addition to all the fields from <strong>nyc_streets</strong>, we add five more fields.</p>
<ul class="simple">
<li><strong>hid</strong> the primary key for the history table</li>
<li><strong>created</strong> the date/time the history record was created</li>
<li><strong>created_by</strong> the database user that caused the record to be created</li>
<li><strong>deleted</strong> the date/time the history record was marked as deleted</li>
<li><strong>deleted_by</strong> the database user that caused the record to be marked as deleted</li>
</ul>
<p>Note that we don’t actually delete any records in the history table, we just mark the time they ceased to be part of the current state of the edit table.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">nyc_streets_history</span> <span class="p">(</span>
  <span class="n">hid</span> <span class="nb">SERIAL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
  <span class="n">id</span> <span class="n">FLOAT8</span><span class="p">,</span>
  <span class="n">name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span>
  <span class="n">oneway</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
  <span class="k">type</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span>
  <span class="n">geom</span> <span class="n">GEOMETRY</span><span class="p">(</span><span class="n">MultiLinestring</span><span class="p">,</span><span class="mi">26918</span><span class="p">),</span>
  <span class="n">created</span> <span class="k">TIMESTAMP</span><span class="p">,</span>
  <span class="n">created_by</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
  <span class="n">deleted</span> <span class="k">TIMESTAMP</span><span class="p">,</span>
  <span class="n">deleted_by</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>
</li>
<li><p class="first">Next, we import the current state of the active table, <strong>nyc_streets</strong> into the history table, so we have a starting point to trace history from. Note that we fill in the creation time and creation user, but leave the deletion records NULL.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">nyc_streets_history</span>
  <span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">oneway</span><span class="p">,</span> <span class="k">type</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">created</span><span class="p">,</span> <span class="n">created_by</span><span class="p">)</span>
   <span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">oneway</span><span class="p">,</span> <span class="k">type</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">now</span><span class="p">(),</span> <span class="k">current_user</span>
   <span class="k">FROM</span> <span class="n">nyc_streets</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p class="first">Now we need three triggers on the active table, for INSERT, DELETE and UPDATE actions. First we create the trigger functions, then bind them to the table as triggers.</p>
<p>For an insert, we just add a new record into the history table with the creation time/user:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>CREATE OR REPLACE FUNCTION nyc_streets_insert() RETURNS trigger AS
$$
  BEGIN
    INSERT INTO nyc_streets_history
      (id, name, oneway, type, geom, created, created_by)
    VALUES
      (NEW.id, NEW.name, NEW.oneway, NEW.type, NEW.geom,
       current_timestamp, current_user);
    RETURN NEW;
  END;
$$
LANGUAGE plpgsql;

CREATE TRIGGER nyc_streets_insert_trigger
AFTER INSERT ON nyc_streets
  FOR EACH ROW EXECUTE PROCEDURE nyc_streets_insert();
</pre></div>
</div>
<p>For a deletion, we just mark the currently active history record (the one with a NULL deletion time) as deleted:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>CREATE OR REPLACE FUNCTION nyc_streets_delete() RETURNS trigger AS
$$
  BEGIN
    UPDATE nyc_streets_history
      SET deleted = current_timestamp, deleted_by = current_user
      WHERE deleted IS NULL and id = OLD.id;
    RETURN NULL;
  END;
$$
LANGUAGE plpgsql;

CREATE TRIGGER nyc_streets_delete_trigger
AFTER DELETE ON nyc_streets
  FOR EACH ROW EXECUTE PROCEDURE nyc_streets_delete();
</pre></div>
</div>
<p>For an update, we first mark the active history record as deleted, then insert a new record for the updated state:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>CREATE OR REPLACE FUNCTION nyc_streets_update() RETURNS trigger AS
$$
  BEGIN

    UPDATE nyc_streets_history
      SET deleted = current_timestamp, deleted_by = current_user
      WHERE deleted IS NULL and id = OLD.id;

    INSERT INTO nyc_streets_history
      (id, name, oneway, type, geom, created, created_by)
    VALUES
      (NEW.id, NEW.name, NEW.oneway, NEW.type, NEW.geom,
       current_timestamp, current_user);

    RETURN NEW;

  END;
$$
LANGUAGE plpgsql;

CREATE TRIGGER nyc_streets_update_trigger
AFTER UPDATE ON nyc_streets
  FOR EACH ROW EXECUTE PROCEDURE nyc_streets_update();
</pre></div>
</div>
</li>
</ul>
<p>Now that the history table is enabled, we can make edits on the main table and watch the log entries appear in the history table.</p>
<p>Note the power of this database-backed approach to history: <strong>no matter what tool is used to make the edits, whether the SQL command line, a web-based JDBC tool, or a desktop tool like QGIS, the history is consistently tracked.</strong></p>
<div class="section" id="sql-edits">
<h3>6.9.1. SQL Edits<a class="headerlink" href="#sql-edits" title="Permalink to this headline">¶</a></h3>
<p>Let’s turn the two streets named “Cumberland Walk” to the more stylish “Cumberland Wynde”:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">UPDATE</span> <span class="n">nyc_streets</span>
<span class="k">SET</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Cumberland Wynde&#39;</span>
<span class="k">WHERE</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Cumberland Walk&#39;</span><span class="p">;</span>
</pre></div>
</div>
<p>Updating the two streets will cause the original streets to be marked as deleted in the history table, with a deletion time of now, and two new streets with the new name added, with an addition time of now. You can inspect the historical records:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">nyc_streets</span> <span class="k">WHERE</span> <span class="n">name</span> <span class="k">LIKE</span> <span class="s1">&#39;Cumberland W%&#39;</span><span class="p">;</span>
</pre></div>
</div>
<p>The results will look like:</p>
<blockquote>
<div><img alt="_images/history01.png" class="inline" src="_images/history01.png" />
</div></blockquote>
<div class="section" id="querying-the-history-table">
<h4>6.9.1.1. Querying the History Table<a class="headerlink" href="#querying-the-history-table" title="Permalink to this headline">¶</a></h4>
<p>Now that we have a history table, what use is it? It’s useful for time travel! To travel to a particular time <strong>T</strong>, you need to construct a query that includes:</p>
<ul class="simple">
<li>All records created before T, and not yet deleted; and also</li>
<li>All records created before T, but deleted <strong>after</strong> T.</li>
</ul>
<p>We can use this logic to create a query, or a view, of the state of the data in the past. Since presumably all your test edits have happened in the past couple minutes, let’s create a view of the history table that shows the state of the table 10 minutes ago, <strong>before you started editing</strong> (so, the original data).</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- State of history 10 minutes ago</span>
<span class="c1">-- Records must have been created at least 10 minute ago and</span>
<span class="c1">-- either be visible now (deleted is null) or deleted in the last hour</span>

<span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">VIEW</span> <span class="n">nyc_streets_ten_min_ago</span> <span class="k">AS</span>
  <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">nyc_streets_history</span>
    <span class="k">WHERE</span> <span class="n">created</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="s1">&#39;10min&#39;</span><span class="p">::</span><span class="nb">interval</span><span class="p">)</span>
    <span class="k">AND</span> <span class="p">(</span> <span class="n">deleted</span> <span class="k">IS</span> <span class="k">NULL</span> <span class="k">OR</span> <span class="n">deleted</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="s1">&#39;10min&#39;</span><span class="p">::</span><span class="nb">interval</span><span class="p">)</span> <span class="p">);</span>
</pre></div>
</div>
<p>We can also create views that show just what a particular user has added, for example:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">VIEW</span> <span class="n">nyc_streets_postgres</span> <span class="k">AS</span>
  <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">nyc_streets_history</span>
    <span class="k">WHERE</span> <span class="n">created_by</span> <span class="o">=</span> <span class="s1">&#39;postgres&#39;</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="see-also">
<h4>6.9.1.2. See Also<a class="headerlink" href="#see-also" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><a class="reference external" href="http://qgis.org">QGIS open source GIS</a></li>
<li><a class="reference external" href="http://www.postgresql.org/docs/current/static/plpgsql-trigger.html">PostgreSQL Triggers</a></li>
</ul>
</div>
</div>
</div>
<div class="section" id="advanced-geometry-constructions">
<span id="advanced-geometry-construction"></span><h2>6.10. Advanced Geometry Constructions<a class="headerlink" href="#advanced-geometry-constructions" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">nyc_subway_stations</span></code> layer has provided us with lots of interesting examples so far, but there is something striking about it:</p>
<img alt="_images/adv_geom0.png" src="_images/adv_geom0.png" />
<p>Although it is a database of all the stations, it doesn’t allow easy visualization of routes! In this chapter we will use advanced features of PostgreSQL and PostGIS to build up a new linear routes layer from the point layer of subway stations.</p>
<p>Our task is made especially difficult by two issues:</p>
<ul class="simple">
<li>The <code class="docutils literal notranslate"><span class="pre">routes</span></code> column of <code class="docutils literal notranslate"><span class="pre">nyc_subway_stations</span></code> has multiple route identifiers in each row, so a station that might appear in multiple routes appears only once in the table.</li>
<li>Related to the previous issue, there is no route ordering information in the stations table, so while it is possible to find all the stations in a particular route, it’s not possible using the attributes to determine what the order in which trains travel through the stations.</li>
</ul>
<p>The second problem is the harder one: given an unordered set of points in a route, how do we order them to match the actual route.</p>
<p>Here are the stops for the ‘Q’ train:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">s</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">geom</span>
<span class="k">FROM</span> <span class="n">nyc_subway_stations</span> <span class="n">s</span>
<span class="k">WHERE</span> <span class="p">(</span><span class="n">strpos</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">routes</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">)</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span><span class="p">);</span>
</pre></div>
</div>
<p>In this picture, the stops are labelled with their unique <code class="docutils literal notranslate"><span class="pre">id</span></code> primary key.</p>
<a class="reference internal image-reference" href="_images/adv_geom1_st.png"><img alt="_images/adv_geom1_st.png" src="_images/adv_geom1_st.png" style="height: 700px;" /></a>
<p>To do this in QGIS, import the <code class="docutils literal notranslate"><span class="pre">nyc_subway_stations</span></code> through the PostGIS connection and select <strong>Update SQL Layer…</strong>. This will allow you to filter by the above query and get the results shown in the picture.</p>
<img alt="_images/qgissql_01.png" src="_images/qgissql_01.png" />
<p>There, click <strong>Execute</strong> and <strong>Update</strong>.</p>
<img alt="_images/qgissql_02.png" src="_images/qgissql_02.png" />
<p>If we start at one of the end stations, the next station on the line seems to always be the closest. We can repeat the process each time as long as we exclude all the previously found stations from our search.</p>
<p>There are two ways to run such an iterative routine in a database:</p>
<ul class="simple">
<li>Using a procedural language, like <a class="reference external" href="http://www.postgresql.org/docs/current/static/plpgsql.html">PL/PgSQL</a>.</li>
<li>Using recursive <a class="reference external" href="http://www.postgresql.org/docs/current/static/queries-with.html">common table expressions</a>.</li>
</ul>
<p>Common table expressions (CTE) have the virtue of not requiring a function definition to run. Here’s the CTE to calculate the route line of the ‘Q’ train, starting from the northernmost stop (where <code class="docutils literal notranslate"><span class="pre">id</span></code> is 365).</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">WITH</span> <span class="k">RECURSIVE</span> <span class="n">next_stop</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">idlist</span><span class="p">)</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="p">(</span><span class="k">SELECT</span>
      <span class="n">geom</span><span class="p">,</span>
      <span class="nb">ARRAY</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="k">AS</span> <span class="n">idlist</span>
    <span class="k">FROM</span> <span class="n">nyc_subway_stations</span>
    <span class="k">WHERE</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">365</span><span class="p">)</span>
    <span class="k">UNION</span> <span class="k">ALL</span>
    <span class="p">(</span><span class="k">SELECT</span>
      <span class="n">s</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span>
      <span class="n">array_append</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">idlist</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">idlist</span>
    <span class="k">FROM</span> <span class="n">nyc_subway_stations</span> <span class="n">s</span><span class="p">,</span> <span class="n">next_stop</span> <span class="n">n</span>
    <span class="k">WHERE</span> <span class="n">strpos</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">routes</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="k">AND</span> <span class="k">NOT</span> <span class="n">n</span><span class="p">.</span><span class="n">idlist</span> <span class="o">@&gt;</span> <span class="nb">ARRAY</span><span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">id</span><span class="p">]</span>
    <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">ST_Distance</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span> <span class="k">ASC</span>
    <span class="k">LIMIT</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">SELECT</span> <span class="n">geom</span><span class="p">,</span> <span class="n">idlist</span> <span class="k">FROM</span> <span class="n">next_stop</span><span class="p">;</span>
</pre></div>
</div>
<p>The CTE consists of two halves, unioned together:</p>
<ul class="simple">
<li>The first half establishes a start point for the expression. We get the initial geometry and initialize the array of visited identifiers, using the record of “id” 365 (the end of the line).</li>
<li>The second half iterates until it finds no further records. At each iteration it takes in the value at the previous iteration via the self-reference to “next_stop”. We search every stop on the Q line (<strong>strpos(s.routes,’Q’)</strong>) that we have not already added to our visited list (<strong>NOT n.idlist &#64;&gt; ARRAY[s.gid]</strong>) and order them by their distance from the previous point, taking just the first one (the nearest).</li>
</ul>
<p>Beyond the recursive CTE itself, there are a number of advanced PostgreSQL array features being used here:</p>
<ul class="simple">
<li>We are using ARRAY! PostgreSQL supports arrays of any type. In this case we have an array of integers, but we could also build an array of geometries, or any other PostgreSQL type.</li>
<li>We are using <strong>array_append</strong> to build up our array of visited identifiers.</li>
<li>We are using the <strong>&#64;&gt;</strong> array operator (“array contains”) to find which of the Q train stations we have already visited. The <strong>&#64;&gt;</strong> operators requires ARRAY values on both sides, so we have to turn the individual “id” numbers into single-entry arrays using the ARRAY[] syntax.</li>
</ul>
<p>When you run the query, you get each geometry in the order it is found (which is the route order), as well as the list of identifiers already visited. Wrapping the geometries into the PostGIS <a class="reference external" href="http://postgis.net/docs/ST_MakeLine.html">ST_MakeLine</a> aggregate function turns the set of geometries into a single linear output, constructed in the provided order.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">WITH</span> <span class="k">RECURSIVE</span> <span class="n">next_stop</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">idlist</span><span class="p">)</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="p">(</span><span class="k">SELECT</span>
      <span class="n">geom</span><span class="p">,</span>
      <span class="nb">ARRAY</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="k">AS</span> <span class="n">idlist</span>
    <span class="k">FROM</span> <span class="n">nyc_subway_stations</span>
    <span class="k">WHERE</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">365</span><span class="p">)</span>
    <span class="k">UNION</span> <span class="k">ALL</span>
    <span class="p">(</span><span class="k">SELECT</span>
      <span class="n">s</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span>
      <span class="n">array_append</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">idlist</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">idlist</span>
    <span class="k">FROM</span> <span class="n">nyc_subway_stations</span> <span class="n">s</span><span class="p">,</span> <span class="n">next_stop</span> <span class="n">n</span>
    <span class="k">WHERE</span> <span class="n">strpos</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">routes</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="k">AND</span> <span class="k">NOT</span> <span class="n">n</span><span class="p">.</span><span class="n">idlist</span> <span class="o">@&gt;</span> <span class="nb">ARRAY</span><span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">id</span><span class="p">]</span>
    <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">ST_Distance</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span> <span class="k">ASC</span>
    <span class="k">LIMIT</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">SELECT</span> <span class="n">ST_MakeLine</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span> <span class="k">AS</span> <span class="n">geom</span> <span class="k">FROM</span> <span class="n">next_stop</span><span class="p">;</span>
</pre></div>
</div>
<p>Which looks like this:</p>
<a class="reference internal image-reference" href="_images/adv_geom3_st.png"><img alt="_images/adv_geom3_st.png" src="_images/adv_geom3_st.png" style="height: 700px;" /></a>
<p><em>Success!</em></p>
<p>Except, two problems:</p>
<ul class="simple">
<li>We are only calculating one subway route here, we want to calculate all the routes.</li>
<li>Our query includes a piece of <em>a priori</em> knowledge, the initial station identifier that serves as the seed for the search algorithm that builds the route.</li>
</ul>
<p>Let’s tackle the hard problem first, figuring out the first station on a route without manually eyeballing the set of stations that make up the route.</p>
<p>Our ‘Q’ train stops can serve as a starting point. What characterizes the end stations of the route?</p>
<a class="reference internal image-reference" href="_images/adv_geom01_st.png"><img alt="_images/adv_geom01_st.png" src="_images/adv_geom01_st.png" style="height: 700px;" /></a>
<p>One answer is “they are the most northerly and southerly stations”. However, imagine if the ‘Q’ train ran from east to west. Would the condition still hold?</p>
<p>A less directional characterization of the end stations is “they are the furthest stations from the middle of the route”. With this characterization it doesn’t matter if the route runs north/south or east/west, just that it run in more-or-less one direction, particularly at the ends.</p>
<p>Since there is no 100% heuristic to figure out the end points, let’s try this second rule out.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">An obvious failure mode of the “furthest from middle” rule is a circular line, like the Circle Line in London, UK. Fortunately, New York doesn’t have any such lines!</p>
</div>
<p>To work out the end stations of every route, we first have to work out what routes there are! We find the distinct routes.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">WITH</span> <span class="n">routes</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="k">unnest</span><span class="p">(</span><span class="n">string_to_array</span><span class="p">(</span><span class="n">routes</span><span class="p">,</span><span class="s1">&#39;,&#39;</span><span class="p">))</span> <span class="k">AS</span> <span class="n">route</span>
  <span class="k">FROM</span> <span class="n">nyc_subway_stations</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">route</span>
<span class="p">)</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">routes</span><span class="p">;</span>
</pre></div>
</div>
<p>Note the use of two advanced PostgreSQL ARRAY functions:</p>
<ul class="simple">
<li><strong>string_to_array</strong> takes in a string and splits it into an array using a separator character. <a class="reference external" href="http://www.postgresql.org/docs/current/static/arrays.html">PostgreSQL supports arrays</a> of any type, so it’s possible to build arrays of strings, as in this case, but also of geometries and geographies as we’ll see later in this example.</li>
<li><strong>unnest</strong> takes in an array and builds a new row for each entry in the array. The effect is to take a “horizontal” array embedded in a single row and turn it into a “vertical” array with a row for each value.</li>
</ul>
<p>The result is a list of all the unique subway route identifiers.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">route</span>
<span class="o">-------</span>
 <span class="mi">1</span>
 <span class="mi">2</span>
 <span class="mi">3</span>
 <span class="mi">4</span>
 <span class="mi">5</span>
 <span class="mi">6</span>
 <span class="mi">7</span>
 <span class="n">A</span>
 <span class="n">B</span>
 <span class="n">C</span>
 <span class="n">D</span>
 <span class="n">E</span>
 <span class="n">F</span>
 <span class="n">G</span>
 <span class="n">J</span>
 <span class="n">L</span>
 <span class="n">M</span>
 <span class="n">N</span>
 <span class="n">Q</span>
 <span class="n">R</span>
 <span class="n">S</span>
 <span class="n">V</span>
 <span class="n">W</span>
 <span class="n">Z</span>
<span class="p">(</span><span class="mi">24</span> <span class="n">rows</span><span class="p">)</span>
</pre></div>
</div>
<p>We can build on this result by joining it back to the <code class="docutils literal notranslate"><span class="pre">nyc_subway_stations</span></code> table to create a new table that has, for each route, a row for every station on that route.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">WITH</span> <span class="n">routes</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="k">unnest</span><span class="p">(</span><span class="n">string_to_array</span><span class="p">(</span><span class="n">routes</span><span class="p">,</span><span class="s1">&#39;,&#39;</span><span class="p">))</span> <span class="k">AS</span> <span class="n">route</span>
  <span class="k">FROM</span> <span class="n">nyc_subway_stations</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">route</span>
<span class="p">),</span>
<span class="n">stops</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="n">s</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">route</span>
  <span class="k">FROM</span> <span class="n">routes</span> <span class="n">r</span>
  <span class="k">JOIN</span> <span class="n">nyc_subway_stations</span> <span class="n">s</span>
  <span class="k">ON</span> <span class="p">(</span><span class="n">strpos</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">routes</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">route</span><span class="p">)</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">stops</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="nb">id</span>  <span class="o">|</span>                        <span class="n">geom</span>                        <span class="o">|</span> <span class="n">route</span>
<span class="o">-----+----------------------------------------------------+-------</span>
   <span class="mi">2</span> <span class="o">|</span> <span class="mi">010100002026690000</span><span class="n">CBE327F938CD21415EDBE1572D315141</span> <span class="o">|</span> <span class="mi">1</span>
   <span class="mi">1</span> <span class="o">|</span> <span class="mi">010100002026690000</span><span class="n">C676635D10CD2141A0ECDB6975305141</span> <span class="o">|</span> <span class="mi">1</span>
  <span class="mi">36</span> <span class="o">|</span> <span class="mi">010100002026690000</span><span class="n">AE59A3F82C132241D835BA14D1435141</span> <span class="o">|</span> <span class="mi">1</span>
  <span class="mi">37</span> <span class="o">|</span> <span class="mi">0101000020266900003495</span><span class="n">A303D615224116DA56527D445141</span> <span class="o">|</span> <span class="mi">1</span>

                            <span class="o">...</span><span class="n">etc</span><span class="o">...</span>
</pre></div>
</div>
<p>Now we can find the center point by collecting all the stations for each route into a single multi-point, and calculating the centroid of that multi-point.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">WITH</span> <span class="n">routes</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="k">unnest</span><span class="p">(</span><span class="n">string_to_array</span><span class="p">(</span><span class="n">routes</span><span class="p">,</span><span class="s1">&#39;,&#39;</span><span class="p">))</span> <span class="k">AS</span> <span class="n">route</span>
  <span class="k">FROM</span> <span class="n">nyc_subway_stations</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">route</span>
<span class="p">),</span>
<span class="n">stops</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="n">s</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">route</span>
  <span class="k">FROM</span> <span class="n">routes</span> <span class="n">r</span>
  <span class="k">JOIN</span> <span class="n">nyc_subway_stations</span> <span class="n">s</span>
  <span class="k">ON</span> <span class="p">(</span><span class="n">strpos</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">routes</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">route</span><span class="p">)</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">),</span>
<span class="n">centers</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="n">ST_Centroid</span><span class="p">(</span><span class="n">ST_Collect</span><span class="p">(</span><span class="n">geom</span><span class="p">))</span> <span class="k">AS</span> <span class="n">geom</span><span class="p">,</span> <span class="n">route</span>
  <span class="k">FROM</span> <span class="n">stops</span>
  <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">route</span>
<span class="p">)</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">centers</span><span class="p">;</span>
</pre></div>
</div>
<p>The center point of the collection of ‘Q’ train stops looks like this:</p>
<a class="reference internal image-reference" href="_images/adv_geom04_st.png"><img alt="_images/adv_geom04_st.png" src="_images/adv_geom04_st.png" style="height: 700px;" /></a>
<p>So the northern most stop, the end point, appears to also be the stop furthest from the center. Let’s calculate the furthest point for every route.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">WITH</span> <span class="n">routes</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="k">unnest</span><span class="p">(</span><span class="n">string_to_array</span><span class="p">(</span><span class="n">routes</span><span class="p">,</span><span class="s1">&#39;,&#39;</span><span class="p">))</span> <span class="k">AS</span> <span class="n">route</span>
  <span class="k">FROM</span> <span class="n">nyc_subway_stations</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">route</span>
<span class="p">),</span>
<span class="n">stops</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="n">s</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">route</span>
  <span class="k">FROM</span> <span class="n">routes</span> <span class="n">r</span>
  <span class="k">JOIN</span> <span class="n">nyc_subway_stations</span> <span class="n">s</span>
  <span class="k">ON</span> <span class="p">(</span><span class="n">strpos</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">routes</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">route</span><span class="p">)</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">),</span>
<span class="n">centers</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="n">ST_Centroid</span><span class="p">(</span><span class="n">ST_Collect</span><span class="p">(</span><span class="n">geom</span><span class="p">))</span> <span class="k">AS</span> <span class="n">geom</span><span class="p">,</span> <span class="n">route</span>
  <span class="k">FROM</span> <span class="n">stops</span>
  <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">route</span>
<span class="p">),</span>
<span class="n">stops_distance</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="n">s</span><span class="p">.</span><span class="o">*</span><span class="p">,</span> <span class="n">ST_Distance</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span> <span class="k">AS</span> <span class="n">distance</span>
  <span class="k">FROM</span> <span class="n">stops</span> <span class="n">s</span> <span class="k">JOIN</span> <span class="n">centers</span> <span class="k">c</span>
  <span class="k">ON</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">route</span> <span class="o">=</span> <span class="k">c</span><span class="p">.</span><span class="n">route</span><span class="p">)</span>
  <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">route</span><span class="p">,</span> <span class="n">distance</span> <span class="k">DESC</span>
<span class="p">),</span>
<span class="n">first_stops</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="k">ON</span> <span class="p">(</span><span class="n">route</span><span class="p">)</span> <span class="n">stops_distance</span><span class="p">.</span><span class="o">*</span>
  <span class="k">FROM</span> <span class="n">stops_distance</span>
<span class="p">)</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">first_stops</span><span class="p">;</span>
</pre></div>
</div>
<p>We’ve added two sub-queries this time:</p>
<ul class="simple">
<li><strong>stops_distance</strong> joins the centers points back to the stations table and calculates the distance between the stations and center for each route. The result is ordered such that the records come out in batches for each route, with the furthest station as the first record of the batch.</li>
<li><strong>first_stops</strong> filters the <strong>stops_distance</strong> output by only taking the first record for each distinct group. Because of the way we ordered <strong>stops_distance</strong> the first record is the furthest record, which means it’s the station we want to use as our starting seed to build each subway route.</li>
</ul>
<p>Now we know every route, and we know (approximately) what station each route starts from: we’re ready to generate the route lines!</p>
<p>But first, we need to turn our recursive CTE expression into a function we can call with parameters:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>CREATE OR REPLACE function walk_subway(integer, text) returns geometry AS
$$
WITH RECURSIVE next_stop(geom, idlist) AS (
    (SELECT
      geom AS geom,
      ARRAY[id] AS idlist
    FROM nyc_subway_stations
    WHERE id = $1)
    UNION ALL
    (SELECT
      s.geom AS geom,
      array_append(n.idlist, s.id) AS idlist
    FROM nyc_subway_stations s, next_stop n
    WHERE strpos(s.routes, $2) != 0
    AND NOT n.idlist @&gt; ARRAY[s.id]
    ORDER BY ST_Distance(n.geom, s.geom) ASC
    LIMIT 1)
)
SELECT ST_MakeLine(geom) AS geom
FROM next_stop;
$$
language &#39;sql&#39;;
</pre></div>
</div>
<p>And now we are ready to go!</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">nyc_subway_lines</span> <span class="k">AS</span>
<span class="c1">-- Distinct route identifiers!</span>
<span class="k">WITH</span> <span class="n">routes</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="k">unnest</span><span class="p">(</span><span class="n">string_to_array</span><span class="p">(</span><span class="n">routes</span><span class="p">,</span><span class="s1">&#39;,&#39;</span><span class="p">))</span> <span class="k">AS</span> <span class="n">route</span>
  <span class="k">FROM</span> <span class="n">nyc_subway_stations</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">route</span>
<span class="p">),</span>
<span class="c1">-- Joined back to stops! Every route has all its stops!</span>
<span class="n">stops</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="n">s</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">route</span>
  <span class="k">FROM</span> <span class="n">routes</span> <span class="n">r</span>
  <span class="k">JOIN</span> <span class="n">nyc_subway_stations</span> <span class="n">s</span>
  <span class="k">ON</span> <span class="p">(</span><span class="n">strpos</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">routes</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">route</span><span class="p">)</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">),</span>
<span class="c1">-- Collects stops by routes and calculate centroid!</span>
<span class="n">centers</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="n">ST_Centroid</span><span class="p">(</span><span class="n">ST_Collect</span><span class="p">(</span><span class="n">geom</span><span class="p">))</span> <span class="k">AS</span> <span class="n">geom</span><span class="p">,</span> <span class="n">route</span>
  <span class="k">FROM</span> <span class="n">stops</span>
  <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">route</span>
<span class="p">),</span>
<span class="c1">-- Calculate stop/center distance for each stop in each route.</span>
<span class="n">stops_distance</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="n">s</span><span class="p">.</span><span class="o">*</span><span class="p">,</span> <span class="n">ST_Distance</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span> <span class="k">AS</span> <span class="n">distance</span>
  <span class="k">FROM</span> <span class="n">stops</span> <span class="n">s</span> <span class="k">JOIN</span> <span class="n">centers</span> <span class="k">c</span>
  <span class="k">ON</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">route</span> <span class="o">=</span> <span class="k">c</span><span class="p">.</span><span class="n">route</span><span class="p">)</span>
  <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">route</span><span class="p">,</span> <span class="n">distance</span> <span class="k">DESC</span>
<span class="p">),</span>
<span class="c1">-- Filter out just the furthest stop/center pairs.</span>
<span class="n">first_stops</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="k">ON</span> <span class="p">(</span><span class="n">route</span><span class="p">)</span> <span class="n">stops_distance</span><span class="p">.</span><span class="o">*</span>
  <span class="k">FROM</span> <span class="n">stops_distance</span>
<span class="p">)</span>
<span class="c1">-- Pass the route/stop information into the linear route generation function!</span>
<span class="k">SELECT</span>
  <span class="n">ascii</span><span class="p">(</span><span class="n">route</span><span class="p">)</span> <span class="k">AS</span> <span class="n">id</span><span class="p">,</span> <span class="c1">-- QGIS likes numeric primary keys</span>
  <span class="n">route</span><span class="p">,</span>
  <span class="n">walk_subway</span><span class="p">(</span><span class="n">id</span><span class="p">::</span><span class="nb">Integer</span><span class="p">,</span> <span class="n">route</span><span class="p">)</span> <span class="k">AS</span> <span class="n">geom</span>
<span class="k">FROM</span> <span class="n">first_stops</span><span class="p">;</span>

<span class="c1">-- Do some housekeeping too</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">nyc_subway_lines</span> <span class="k">ADD</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">id</span><span class="p">);</span>
</pre></div>
</div>
<p>Here’s what our final table looks like visualized in QGIS:</p>
<img alt="_images/adv_geom6_st.png" src="_images/adv_geom6_st.png" />
<p>As usual, there are some problems with our simple understanding of the data:</p>
<ul class="simple">
<li>there are actually two ‘S’ (short distance “shuttle”) trains, one in Manhattan and one in the Rockaways, and we join them together because they are both called ‘S’;</li>
<li>the ‘4’ train (and a few others) splits at the end of one line into two terminuses, so the “follow one line” assumption breaks and the result has a funny hook on the end.</li>
</ul>
<p>Hopefully this example has provided a taste of some of the complex data manipulations that are possible combining the advanced features of PostgreSQL and PostGIS.</p>
<div class="section" id="id12">
<h3>6.10.1. See Also<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><a class="reference external" href="http://www.postgresql.org/docs/current/static/arrays.html">PostgreSQL Arrays</a></li>
<li><a class="reference external" href="http://www.postgresql.org/docs/current/static/functions-array.html">PostgreSQL Array Functions</a></li>
<li><a class="reference external" href="http://www.postgresql.org/docs/current/static/queries-with.html">PostgreSQL Recursive Common TABLE Expressions</a></li>
<li><a class="reference external" href="http://postgis.net/docs/ST_MakeLine.html">PostGIS ST_MakeLine</a></li>
</ul>
</div>
</div>
<div class="section" id="working-with-rasters">
<span id="rasters"></span><h2>6.11. Working with Rasters<a class="headerlink" href="#working-with-rasters" title="Permalink to this headline">¶</a></h2>
<p>In this section you will learn to load a raster, get basic information on the raster, process and analyze it.</p>
<p>Before going further, we should describe what a raster is and what a raster is used for. At the simplest level, a raster is a photo or image with information describing where to place the raster on the Earth’s surface. A photograph typically has three sets of values, one set for each primary color (red, green, and blue). A raster also has sets of values, often more than those found in a photograph. Each set of values is known as a band. So, a photograph typically has three bands while a raster has at least one band. As with digital photographs, rasters come in a variety of file formats. Common raster formats you may come across include PNG, JPEG, GeoTIFF, HDF5, and NetCDF. Since rasters can have many bands and even more values, they can be used to store large quantities of data in an efficient manner. Due to their efficiency, rasters are used for satellite and aerial sensors and modeled surfaces, such as weather forecasts.</p>
<p>Some definitions to consider:</p>
<ul class="simple">
<li>Raster is the PostGIS data type for storing the raster files in PostgreSQL.</li>
<li>Tile: This is a small chunk of the original raster file to be stored in one column of a table’s row. Each tile has its own set of spatial information and thus is independent of all the other tiles in the same column of the same table, even if the other tiles are from the same original raster file.</li>
</ul>
<p>For this section let’s create a new <code class="docutils literal notranslate"><span class="pre">SCHEMA</span></code> where we will keep the objects for working with rasters. On your pgAdmin <em>query editor</em> write:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">SCHEMA</span> <span class="n">rasters</span><span class="p">;</span>
</pre></div>
</div>
<p>The data that we will use in this section is world climate data for the period of 1970-2000 by 10 min resolution provided by <a class="reference external" href="http://worldclim.org/version2">worldclim</a> but you can find it in the data folder <strong>raster</strong> of this tutorial, unzip it.</p>
<ol class="arabic simple">
<li>First, let’s inspect the <code class="docutils literal notranslate"><span class="pre">wc2.0_10m_tmax_01.tif</span></code> raster file using GDAL, you can install GDAL for unix/MAC using the binaries from <a class="reference external" href="https://sandbox.idre.ucla.edu/sandbox/general/how-to-install-and-run-gdal">this site</a> or using the <a class="reference external" href="https://trac.osgeo.org/osgeo4w/">OSGeoW</a> suite for Windows, which will provide all the packages you need. You can also open the raster with QGIS and inspect its metadata.</li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Driver</span><span class="p">:</span> <span class="n">GTiff</span><span class="o">/</span><span class="n">GeoTIFF</span>
<span class="n">Files</span><span class="p">:</span> <span class="n">wc2</span><span class="o">.</span><span class="mi">0_10</span><span class="n">m_tmax_01</span><span class="o">.</span><span class="n">tif</span>
<span class="n">Size</span> <span class="ow">is</span> <span class="mi">2160</span><span class="p">,</span> <span class="mi">1080</span>
<span class="n">Coordinate</span> <span class="n">System</span> <span class="ow">is</span><span class="p">:</span>
<span class="n">GEOGCS</span><span class="p">[</span><span class="s2">&quot;WGS 84&quot;</span><span class="p">,</span>
    <span class="n">DATUM</span><span class="p">[</span><span class="s2">&quot;WGS_1984&quot;</span><span class="p">,</span>
        <span class="n">SPHEROID</span><span class="p">[</span><span class="s2">&quot;WGS 84&quot;</span><span class="p">,</span><span class="mi">6378137</span><span class="p">,</span><span class="mf">298.257223563</span><span class="p">,</span>
            <span class="n">AUTHORITY</span><span class="p">[</span><span class="s2">&quot;EPSG&quot;</span><span class="p">,</span><span class="s2">&quot;7030&quot;</span><span class="p">]],</span>
        <span class="n">AUTHORITY</span><span class="p">[</span><span class="s2">&quot;EPSG&quot;</span><span class="p">,</span><span class="s2">&quot;6326&quot;</span><span class="p">]],</span>
    <span class="n">PRIMEM</span><span class="p">[</span><span class="s2">&quot;Greenwich&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">UNIT</span><span class="p">[</span><span class="s2">&quot;degree&quot;</span><span class="p">,</span><span class="mf">0.0174532925199433</span><span class="p">],</span>
    <span class="n">AUTHORITY</span><span class="p">[</span><span class="s2">&quot;EPSG&quot;</span><span class="p">,</span><span class="s2">&quot;4326&quot;</span><span class="p">]]</span>
<span class="n">Origin</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">180.000000000000000</span><span class="p">,</span><span class="mf">90.000000000000000</span><span class="p">)</span>
<span class="n">Pixel</span> <span class="n">Size</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.166666666666667</span><span class="p">,</span><span class="o">-</span><span class="mf">0.166666666666667</span><span class="p">)</span>
<span class="n">Metadata</span><span class="p">:</span>
  <span class="n">AREA_OR_POINT</span><span class="o">=</span><span class="n">Area</span>
<span class="n">Image</span> <span class="n">Structure</span> <span class="n">Metadata</span><span class="p">:</span>
  <span class="n">COMPRESSION</span><span class="o">=</span><span class="n">DEFLATE</span>
  <span class="n">INTERLEAVE</span><span class="o">=</span><span class="n">BAND</span>
<span class="n">Corner</span> <span class="n">Coordinates</span><span class="p">:</span>
<span class="n">Upper</span> <span class="n">Left</span>  <span class="p">(</span><span class="o">-</span><span class="mf">180.0000000</span><span class="p">,</span>  <span class="mf">90.0000000</span><span class="p">)</span> <span class="p">(</span><span class="mi">180</span><span class="n">d</span> <span class="mi">0</span><span class="s1">&#39; 0.00&quot;W, 90d 0&#39;</span> <span class="mf">0.00</span><span class="s2">&quot;N)</span>
<span class="n">Lower</span> <span class="n">Left</span>  <span class="p">(</span><span class="o">-</span><span class="mf">180.0000000</span><span class="p">,</span> <span class="o">-</span><span class="mf">90.0000000</span><span class="p">)</span> <span class="p">(</span><span class="mi">180</span><span class="n">d</span> <span class="mi">0</span><span class="s1">&#39; 0.00&quot;W, 90d 0&#39;</span> <span class="mf">0.00</span><span class="s2">&quot;S)</span>
<span class="n">Upper</span> <span class="n">Right</span> <span class="p">(</span> <span class="mf">180.0000000</span><span class="p">,</span>  <span class="mf">90.0000000</span><span class="p">)</span> <span class="p">(</span><span class="mi">180</span><span class="n">d</span> <span class="mi">0</span><span class="s1">&#39; 0.00&quot;E, 90d 0&#39;</span> <span class="mf">0.00</span><span class="s2">&quot;N)</span>
<span class="n">Lower</span> <span class="n">Right</span> <span class="p">(</span> <span class="mf">180.0000000</span><span class="p">,</span> <span class="o">-</span><span class="mf">90.0000000</span><span class="p">)</span> <span class="p">(</span><span class="mi">180</span><span class="n">d</span> <span class="mi">0</span><span class="s1">&#39; 0.00&quot;E, 90d 0&#39;</span> <span class="mf">0.00</span><span class="s2">&quot;S)</span>
<span class="n">Center</span>      <span class="p">(</span>   <span class="mf">0.0000000</span><span class="p">,</span>   <span class="mf">0.0000000</span><span class="p">)</span> <span class="p">(</span>  <span class="mi">0</span><span class="n">d</span> <span class="mi">0</span><span class="s1">&#39; 0.01&quot;E,  0d 0&#39;</span> <span class="mf">0.01</span><span class="s2">&quot;N)</span>
<span class="n">Band</span> <span class="mi">1</span> <span class="n">Block</span><span class="o">=</span><span class="mi">2160</span><span class="n">x1</span> <span class="n">Type</span><span class="o">=</span><span class="n">Float32</span><span class="p">,</span> <span class="n">ColorInterp</span><span class="o">=</span><span class="n">Gray</span>
  <span class="n">Min</span><span class="o">=-</span><span class="mf">39.708</span> <span class="n">Max</span><span class="o">=</span><span class="mf">42.235</span>
  <span class="n">Minimum</span><span class="o">=-</span><span class="mf">39.708</span><span class="p">,</span> <span class="n">Maximum</span><span class="o">=</span><span class="mf">42.235</span><span class="p">,</span> <span class="n">Mean</span><span class="o">=</span><span class="mf">1.000</span><span class="p">,</span> <span class="n">StdDev</span><span class="o">=</span><span class="mf">1.000</span>
  <span class="n">NoData</span> <span class="n">Value</span><span class="o">=-</span><span class="mf">3.39999999999999996e+38</span>
  <span class="n">Metadata</span><span class="p">:</span>
    <span class="n">STATISTICS_MAXIMUM</span><span class="o">=</span><span class="mf">42.234750080109</span>
    <span class="n">STATISTICS_MEAN</span><span class="o">=</span><span class="mf">1.</span><span class="c1">#SNAN</span>
    <span class="n">STATISTICS_MINIMUM</span><span class="o">=-</span><span class="mf">39.707750263214</span>
    <span class="n">STATISTICS_STDDEV</span><span class="o">=</span><span class="mf">1.</span><span class="c1">#SNAN</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li>From this information we know the coodinate reference system of the raster, the limits, pixel size, and some statistics on the values it contains.</li>
<li>For the next steps make sure you have postgreSQL binaries added to your path if not already added, for Mac this is done by:</li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">PATH</span><span class="o">=</span><span class="s2">&quot;/Applications/Postgres.app/Contents/Versions/11/bin:$PATH&quot;</span>
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li>Now we’re ready to load the rasters of maximum temperature into our database using <code class="docutils literal notranslate"><span class="pre">raster2pgsql</span></code>.</li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">raster2pgsql</span> <span class="o">-</span><span class="n">s</span> <span class="mi">4326</span> <span class="o">-</span><span class="n">t</span> <span class="mi">100</span><span class="n">x100</span> <span class="o">-</span><span class="n">F</span> <span class="o">-</span><span class="n">I</span> <span class="o">-</span><span class="n">C</span> <span class="o">-</span><span class="n">Y</span> <span class="n">wc2</span><span class="o">.</span><span class="mi">0_10</span><span class="n">m_tmax_</span><span class="o">*.</span><span class="n">tif</span> <span class="n">rasters</span><span class="o">.</span><span class="n">worldclim_tmax</span> <span class="o">|</span> <span class="n">psql</span> <span class="o">-</span><span class="n">d</span> <span class="n">nyc</span>
</pre></div>
</div>
<ol class="arabic simple" start="5">
<li>Now let’s load the rasters of minimum temperature into our database using <code class="docutils literal notranslate"><span class="pre">raster2pgsql</span></code>.</li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">raster2pgsql</span> <span class="o">-</span><span class="n">s</span> <span class="mi">4326</span> <span class="o">-</span><span class="n">t</span> <span class="mi">100</span><span class="n">x100</span> <span class="o">-</span><span class="n">F</span> <span class="o">-</span><span class="n">I</span> <span class="o">-</span><span class="n">C</span> <span class="o">-</span><span class="n">Y</span> <span class="n">wc2</span><span class="o">.</span><span class="mi">0_10</span><span class="n">m_tmin_</span><span class="o">*.</span><span class="n">tif</span> <span class="n">rasters</span><span class="o">.</span><span class="n">worldclim_tmin</span> <span class="o">|</span> <span class="n">psql</span> <span class="o">-</span><span class="n">d</span> <span class="n">nyc</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The raster2pgsql command is called with the following flags:
-s: This flag assigns SRID 4326 to the imported rasters.
-t: This flag denotes the tile size. It chunks the imported rasters into smaller and more manageable pieces; each record added to the table will be at most 100 x 100 pixels.
-F: This flag adds a column to the table and fills it with the raster’s filename.
-I: This flag creates a GIST spatial index on the table’s raster column.
-C: This flag applies the standard set of constraints on the table. The standard set of constraints includes checks for dimension, scale, skew, upper-left coordinate, and SRID.
-Y: This flag instructs raster2pgsql to use COPY statements instead of INSERT statements. COPY is typically faster than INSERT.</p>
</div>
<ol class="arabic simple" start="6">
<li>After running ths you’ll have added the rasters to the rasters SCHEMA. The terminal output will be:</li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Processing</span> <span class="mi">1</span><span class="o">/</span><span class="mi">12</span><span class="p">:</span> <span class="n">wc2</span><span class="o">.</span><span class="mi">0_10</span><span class="n">m_tmax_01</span><span class="o">.</span><span class="n">tif</span>
<span class="n">BEGIN</span>
<span class="n">CREATE</span> <span class="n">TABLE</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">Processing</span> <span class="mi">2</span><span class="o">/</span><span class="mi">12</span><span class="p">:</span> <span class="n">wc2</span><span class="o">.</span><span class="mi">0_10</span><span class="n">m_tmax_02</span><span class="o">.</span><span class="n">tif</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">Processing</span> <span class="mi">3</span><span class="o">/</span><span class="mi">12</span><span class="p">:</span> <span class="n">wc2</span><span class="o">.</span><span class="mi">0_10</span><span class="n">m_tmax_03</span><span class="o">.</span><span class="n">tif</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">Processing</span> <span class="mi">4</span><span class="o">/</span><span class="mi">12</span><span class="p">:</span> <span class="n">wc2</span><span class="o">.</span><span class="mi">0_10</span><span class="n">m_tmax_04</span><span class="o">.</span><span class="n">tif</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">Processing</span> <span class="mi">5</span><span class="o">/</span><span class="mi">12</span><span class="p">:</span> <span class="n">wc2</span><span class="o">.</span><span class="mi">0_10</span><span class="n">m_tmax_05</span><span class="o">.</span><span class="n">tif</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">Processing</span> <span class="mi">6</span><span class="o">/</span><span class="mi">12</span><span class="p">:</span> <span class="n">wc2</span><span class="o">.</span><span class="mi">0_10</span><span class="n">m_tmax_06</span><span class="o">.</span><span class="n">tif</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">Processing</span> <span class="mi">7</span><span class="o">/</span><span class="mi">12</span><span class="p">:</span> <span class="n">wc2</span><span class="o">.</span><span class="mi">0_10</span><span class="n">m_tmax_07</span><span class="o">.</span><span class="n">tif</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">Processing</span> <span class="mi">8</span><span class="o">/</span><span class="mi">12</span><span class="p">:</span> <span class="n">wc2</span><span class="o">.</span><span class="mi">0_10</span><span class="n">m_tmax_08</span><span class="o">.</span><span class="n">tif</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">Processing</span> <span class="mi">9</span><span class="o">/</span><span class="mi">12</span><span class="p">:</span> <span class="n">wc2</span><span class="o">.</span><span class="mi">0_10</span><span class="n">m_tmax_09</span><span class="o">.</span><span class="n">tif</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">Processing</span> <span class="mi">10</span><span class="o">/</span><span class="mi">12</span><span class="p">:</span> <span class="n">wc2</span><span class="o">.</span><span class="mi">0_10</span><span class="n">m_tmax_10</span><span class="o">.</span><span class="n">tif</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">Processing</span> <span class="mi">11</span><span class="o">/</span><span class="mi">12</span><span class="p">:</span> <span class="n">wc2</span><span class="o">.</span><span class="mi">0_10</span><span class="n">m_tmax_11</span><span class="o">.</span><span class="n">tif</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">Processing</span> <span class="mi">12</span><span class="o">/</span><span class="mi">12</span><span class="p">:</span> <span class="n">wc2</span><span class="o">.</span><span class="mi">0_10</span><span class="n">m_tmax_12</span><span class="o">.</span><span class="n">tif</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">COPY</span> <span class="mi">11</span>
<span class="n">CREATE</span> <span class="n">INDEX</span>
<span class="n">ANALYZE</span>
<span class="n">NOTICE</span><span class="p">:</span>  <span class="n">Adding</span> <span class="n">SRID</span> <span class="n">constraint</span>
<span class="n">NOTICE</span><span class="p">:</span>  <span class="n">Adding</span> <span class="n">scale</span><span class="o">-</span><span class="n">X</span> <span class="n">constraint</span>
<span class="n">NOTICE</span><span class="p">:</span>  <span class="n">Adding</span> <span class="n">scale</span><span class="o">-</span><span class="n">Y</span> <span class="n">constraint</span>
<span class="n">NOTICE</span><span class="p">:</span>  <span class="n">Adding</span> <span class="n">blocksize</span><span class="o">-</span><span class="n">X</span> <span class="n">constraint</span>
<span class="n">NOTICE</span><span class="p">:</span>  <span class="n">Adding</span> <span class="n">blocksize</span><span class="o">-</span><span class="n">Y</span> <span class="n">constraint</span>
<span class="n">NOTICE</span><span class="p">:</span>  <span class="n">Adding</span> <span class="n">alignment</span> <span class="n">constraint</span>
<span class="n">NOTICE</span><span class="p">:</span>  <span class="n">Adding</span> <span class="n">number</span> <span class="n">of</span> <span class="n">bands</span> <span class="n">constraint</span>
<span class="n">NOTICE</span><span class="p">:</span>  <span class="n">Adding</span> <span class="n">pixel</span> <span class="nb">type</span> <span class="n">constraint</span>
<span class="n">NOTICE</span><span class="p">:</span>  <span class="n">Adding</span> <span class="n">nodata</span> <span class="n">value</span> <span class="n">constraint</span>
<span class="n">NOTICE</span><span class="p">:</span>  <span class="n">Adding</span> <span class="n">out</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">database</span> <span class="n">constraint</span>
<span class="n">NOTICE</span><span class="p">:</span>  <span class="n">Adding</span> <span class="n">maximum</span> <span class="n">extent</span> <span class="n">constraint</span>
 <span class="n">addrasterconstraints</span>
<span class="o">----------------------</span>
 <span class="n">t</span>
<span class="p">(</span><span class="mi">1</span> <span class="n">row</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">A similar output will be generated for the minimum temperature rasters.</p>
</div>
<ol class="arabic simple" start="7">
<li>You can now verify this on pgAdmin, the rasters have been loaded in the <code class="docutils literal notranslate"><span class="pre">worldclim</span></code> table under the rasters SCHEMA:</li>
</ol>
<img alt="_images/rasters_01.png" class="inline" src="_images/rasters_01.png" />
<ol class="arabic simple" start="8">
<li>Now let’s import two SRTM layers for New York taken from <a class="reference external" href="https://dds.cr.usgs.gov/srtm/version2_1/SRTM1/Region_06/">https://dds.cr.usgs.gov/srtm/version2_1/SRTM1/Region_06/</a> but that is included in the data bundle. New york is splitted into two SRTM raster images <code class="docutils literal notranslate"><span class="pre">N40W074.hgt</span></code> and <code class="docutils literal notranslate"><span class="pre">N40W075.hgt</span></code>.</li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">raster2pgsql</span> <span class="o">-</span><span class="n">s</span> <span class="mi">4326</span> <span class="o">-</span><span class="n">t</span> <span class="mi">100</span><span class="n">x100</span> <span class="o">-</span><span class="n">F</span> <span class="o">-</span><span class="n">I</span> <span class="o">-</span><span class="n">C</span> <span class="o">-</span><span class="n">Y</span> <span class="n">N40W074</span><span class="o">.</span><span class="n">hgt</span> <span class="n">rasters</span><span class="o">.</span><span class="n">srtm1</span>  <span class="o">|</span> <span class="n">psql</span> <span class="o">-</span><span class="n">d</span> <span class="n">nyc</span>
<span class="n">raster2pgsql</span> <span class="o">-</span><span class="n">s</span> <span class="mi">4326</span> <span class="o">-</span><span class="n">t</span> <span class="mi">100</span><span class="n">x100</span> <span class="o">-</span><span class="n">F</span> <span class="o">-</span><span class="n">I</span> <span class="o">-</span><span class="n">C</span> <span class="o">-</span><span class="n">Y</span> <span class="n">N40W075</span><span class="o">.</span><span class="n">hgt</span> <span class="n">rasters</span><span class="o">.</span><span class="n">srtm2</span>  <span class="o">|</span> <span class="n">psql</span> <span class="o">-</span><span class="n">d</span> <span class="n">nyc</span>
</pre></div>
</div>
<ol class="arabic simple" start="8">
<li>Verify that this is also reflected in pgAdmin:</li>
</ol>
<img alt="_images/rasters_02.png" class="inline" src="_images/rasters_02.png" />
<ol class="arabic simple" start="9">
<li>Now let’s obtain some information on the rasters within the database, for this, run the following SQL command:</li>
</ol>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span>
      <span class="n">r_table_name</span><span class="p">,</span>
      <span class="n">r_raster_column</span><span class="p">,</span>
      <span class="n">srid</span><span class="p">,</span>
      <span class="n">scale_x</span><span class="p">,</span>
      <span class="n">scale_y</span><span class="p">,</span>
      <span class="n">blocksize_x</span><span class="p">,</span>
      <span class="n">blocksize_y</span><span class="p">,</span>
      <span class="n">same_alignment</span><span class="p">,</span>
      <span class="n">regular_blocking</span><span class="p">,</span>
      <span class="n">num_bands</span><span class="p">,</span>
      <span class="n">pixel_types</span><span class="p">,</span>
      <span class="n">nodata_values</span><span class="p">,</span>
      <span class="n">out_db</span><span class="p">,</span>
      <span class="n">ST_AsText</span><span class="p">(</span><span class="n">extent</span><span class="p">)</span> <span class="k">AS</span> <span class="n">extent</span>
 <span class="k">FROM</span> <span class="n">raster_columns</span> <span class="k">WHERE</span> <span class="n">r_table_name</span> <span class="o">=</span> <span class="s1">&#39;worldclim_tmax&#39;</span><span class="p">;</span>
</pre></div>
</div>
<p>Only some of the results of this query are shown on the below table (because there are too many attributes):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">r_table_name</span>  <span class="o">|</span> <span class="n">r_raster_column</span> <span class="o">|</span> <span class="n">srid</span> <span class="o">|</span>   <span class="n">scale_x</span>    <span class="o">|</span>    <span class="n">scale_y</span>    <span class="o">|</span> <span class="n">blocksize_x</span> <span class="o">|</span> <span class="n">blocksize_y</span>
<span class="o">----------------+-----------------+------+--------------+---------------+-------------+-------------</span>
<span class="n">worldclim_tmax</span>  <span class="o">|</span> <span class="n">rast</span>            <span class="o">|</span> <span class="mi">4326</span> <span class="o">|</span> <span class="mf">0.1666666667</span> <span class="o">|</span> <span class="o">-</span><span class="mf">0.1666666667</span> <span class="o">|</span> <span class="mi">100</span>         <span class="o">|</span> <span class="mi">100</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Seeing this, the blocksize specified for <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code> while loading the data worked!</p>
</div>
<ol class="arabic simple" start="10">
<li>Now let’s use the <a class="reference external" href="https://postgis.net/docs/RT_ST_MetaData.html">ST_Metadata()</a> to see the metadata for a single raster:</li>
</ol>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span>  <span class="n">rid</span><span class="p">,</span>  <span class="p">(</span><span class="n">ST_Metadata</span><span class="p">(</span><span class="n">rast</span><span class="p">)).</span><span class="o">*</span>
<span class="k">FROM</span> <span class="n">rasters</span><span class="p">.</span><span class="n">worldclim_tmax</span>
<span class="k">WHERE</span> <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;wc2.0_10m_tmax_01.tif&#39;</span>
<span class="k">LIMIT</span> <span class="mi">1</span><span class="p">;</span>
</pre></div>
</div>
<p>The output will be for the average maximun temperature of the first month (January).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">rid</span> <span class="o">|</span> <span class="n">upperleftx</span> <span class="o">|</span> <span class="n">upperlefty</span> <span class="o">|</span> <span class="n">width</span> <span class="o">|</span> <span class="n">height</span> <span class="o">|</span>      <span class="n">scalex</span>       <span class="o">|</span>       <span class="n">scaley</span>       <span class="o">|</span> <span class="n">skewx</span> <span class="o">|</span> <span class="n">skewy</span> <span class="o">|</span> <span class="n">srid</span> <span class="o">|</span> <span class="n">numbands</span>
<span class="o">-----+------------+------------+-------+--------+-------------------+--------------------+-------+-------+------+----------</span>
   <span class="mi">1</span> <span class="o">|</span>       <span class="o">-</span><span class="mi">180</span> <span class="o">|</span>         <span class="mi">90</span> <span class="o">|</span>   <span class="mi">100</span> <span class="o">|</span>    <span class="mi">100</span> <span class="o">|</span> <span class="mf">0.166666666666667</span> <span class="o">|</span> <span class="o">-</span><span class="mf">0.166666666666667</span> <span class="o">|</span>     <span class="mi">0</span> <span class="o">|</span>     <span class="mi">0</span> <span class="o">|</span> <span class="mi">4326</span> <span class="o">|</span>        <span class="mi">1</span>
</pre></div>
</div>
<ol class="arabic simple" start="11">
<li>Now with <a class="reference external" href="https://postgis.net/docs/RT_ST_BandMetaData.html">ST_BandMetadata()</a> let’s obtain some metadata on the raster’s tile only band at the record 23.</li>
</ol>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span>  <span class="n">rid</span><span class="p">,</span>  <span class="p">(</span><span class="n">ST_BandMetadata</span><span class="p">(</span><span class="n">rast</span><span class="p">,</span> <span class="mi">1</span><span class="p">)).</span><span class="o">*</span>
<span class="k">FROM</span> <span class="n">rasters</span><span class="p">.</span><span class="n">worldclim_tmax</span>
<span class="k">WHERE</span> <span class="n">rid</span> <span class="o">=</span> <span class="mi">23</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">rid</span> <span class="o">|</span> <span class="n">pixeltype</span> <span class="o">|</span>      <span class="n">nodatavalue</span>      <span class="o">|</span> <span class="n">isoutdb</span> <span class="o">|</span> <span class="n">path</span> <span class="o">|</span> <span class="n">outdbbandnum</span> <span class="o">|</span> <span class="n">filesize</span> <span class="o">|</span> <span class="n">filetimestamp</span>
<span class="o">-----+-----------+-----------------------+---------+------+--------------+----------+---------------</span>
  <span class="mi">23</span> <span class="o">|</span> <span class="mi">32</span><span class="n">BF</span>      <span class="o">|</span> <span class="o">-</span><span class="mf">3.39999995214436e+38</span> <span class="o">|</span> <span class="n">f</span>       <span class="o">|</span>      <span class="o">|</span>              <span class="o">|</span>          <span class="o">|</span>
</pre></div>
</div>
<ol class="arabic simple" start="12">
<li>Results for worldclim_tmin:</li>
</ol>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span>  <span class="n">rid</span><span class="p">,</span>  <span class="p">(</span><span class="n">ST_BandMetadata</span><span class="p">(</span><span class="n">rast</span><span class="p">,</span> <span class="mi">1</span><span class="p">)).</span><span class="o">*</span>
<span class="k">FROM</span> <span class="n">rasters</span><span class="p">.</span><span class="n">worldclim_tmin</span>
<span class="k">WHERE</span> <span class="n">rid</span> <span class="o">=</span> <span class="mi">23</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">rid</span> <span class="o">|</span> <span class="n">pixeltype</span> <span class="o">|</span>      <span class="n">nodatavalue</span>      <span class="o">|</span> <span class="n">isoutdb</span> <span class="o">|</span> <span class="n">path</span> <span class="o">|</span> <span class="n">outdbbandnum</span> <span class="o">|</span> <span class="n">filesize</span> <span class="o">|</span> <span class="n">filetimestamp</span>
<span class="o">-----+-----------+-----------------------+---------+------+--------------+----------+---------------</span>
  <span class="mi">23</span> <span class="o">|</span> <span class="mi">32</span><span class="n">BF</span>      <span class="o">|</span> <span class="o">-</span><span class="mf">3.39999995214436e+38</span> <span class="o">|</span> <span class="n">f</span>       <span class="o">|</span>      <span class="o">|</span>              <span class="o">|</span>          <span class="o">|</span>
</pre></div>
</div>
<ol class="arabic simple" start="13">
<li>Now let’s use <a class="reference external" href="https://postgis.net/docs/RT_ST_SummaryStats.html">ST_SummaryStats()</a> to compute a summary of statistics comprising: count, sum, mean, stddev, min, max for the given raster band (worldclim_tmax and then wordclim_tmin).</li>
</ol>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">WITH</span> <span class="n">stats</span> <span class="k">AS</span> <span class="p">(</span>
<span class="k">SELECT</span>    <span class="p">(</span><span class="n">ST_SummaryStats</span><span class="p">(</span><span class="n">rast</span><span class="p">,</span> <span class="mi">1</span><span class="p">)).</span><span class="o">*</span>  <span class="k">FROM</span> <span class="n">rasters</span><span class="p">.</span><span class="n">worldclim_tmax</span>  <span class="k">WHERE</span> <span class="n">rid</span> <span class="o">=</span> <span class="mi">23</span>
<span class="p">)</span>
<span class="k">SELECT</span>  <span class="k">count</span><span class="p">,</span>  <span class="k">sum</span><span class="p">,</span>  <span class="n">round</span><span class="p">(</span><span class="n">mean</span><span class="p">::</span><span class="nb">numeric</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">AS</span> <span class="n">mean</span><span class="p">,</span>  <span class="n">round</span><span class="p">(</span><span class="n">stddev</span><span class="p">::</span><span class="nb">numeric</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">AS</span> <span class="n">stddev</span><span class="p">,</span>  <span class="k">min</span><span class="p">,</span>  <span class="k">max</span>
<span class="k">FROM</span> <span class="n">stats</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">count</span> <span class="o">|</span>        <span class="nb">sum</span>        <span class="o">|</span>  <span class="n">mean</span>  <span class="o">|</span> <span class="n">stddev</span> <span class="o">|</span>        <span class="nb">min</span>        <span class="o">|</span> <span class="nb">max</span>
<span class="o">-------+-------------------+--------+--------+-------------------+-----</span>
  <span class="mi">1818</span> <span class="o">|</span> <span class="o">-</span><span class="mf">26097.0808352232</span> <span class="o">|</span> <span class="o">-</span><span class="mf">14.35</span> <span class="o">|</span>   <span class="mf">4.14</span> <span class="o">|</span> <span class="o">-</span><span class="mf">25.9260864257812</span> <span class="o">|</span>   <span class="mi">0</span>
</pre></div>
</div>
<ol class="arabic simple" start="14">
<li>And for worldclim_tmin (remember to included the SCHEMA before the table - rasters.wordlclim_tmin):</li>
</ol>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">WITH</span> <span class="n">stats</span> <span class="k">AS</span> <span class="p">(</span>
<span class="k">SELECT</span>    <span class="p">(</span><span class="n">ST_SummaryStats</span><span class="p">(</span><span class="n">rast</span><span class="p">,</span> <span class="mi">1</span><span class="p">)).</span><span class="o">*</span>  <span class="k">FROM</span> <span class="n">rasters</span><span class="p">.</span><span class="n">worldclim_tmin</span>  <span class="k">WHERE</span> <span class="n">rid</span> <span class="o">=</span> <span class="mi">23</span>
<span class="p">)</span>
<span class="k">SELECT</span>  <span class="k">count</span><span class="p">,</span>  <span class="k">sum</span><span class="p">,</span>  <span class="n">round</span><span class="p">(</span><span class="n">mean</span><span class="p">::</span><span class="nb">numeric</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">AS</span> <span class="n">mean</span><span class="p">,</span>  <span class="n">round</span><span class="p">(</span><span class="n">stddev</span><span class="p">::</span><span class="nb">numeric</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">AS</span> <span class="n">stddev</span><span class="p">,</span>  <span class="k">min</span><span class="p">,</span>  <span class="k">max</span>
<span class="k">FROM</span> <span class="n">stats</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">count</span> <span class="o">|</span>       <span class="nb">sum</span>        <span class="o">|</span>  <span class="n">mean</span>  <span class="o">|</span> <span class="n">stddev</span> <span class="o">|</span>        <span class="nb">min</span>        <span class="o">|</span> <span class="nb">max</span>
<span class="o">-------+------------------+--------+--------+-------------------+-----</span>
  <span class="mi">1818</span> <span class="o">|</span> <span class="o">-</span><span class="mf">39561.697756052</span> <span class="o">|</span> <span class="o">-</span><span class="mf">21.76</span> <span class="o">|</span>   <span class="mf">4.19</span> <span class="o">|</span> <span class="o">-</span><span class="mf">30.7347507476807</span> <span class="o">|</span>   <span class="mi">0</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In the summary statistics, the count indicates that the raster tile is about 80 percent NODATA. Remember the rasters we are analyzing show the average monthly min/max from 1970-2000, therefore the values may not match recent years.</p>
</div>
<ol class="arabic simple" start="15">
<li>Now let’s use <a class="reference external" href="https://postgis.net/docs/RT_ST_Histogram.html">ST_Histogram()</a> to see how the values are distributed:</li>
</ol>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">WITH</span> <span class="n">hist</span> <span class="k">AS</span> <span class="p">(</span>
     <span class="k">SELECT</span>
             <span class="p">(</span><span class="n">ST_Histogram</span><span class="p">(</span><span class="n">rast</span><span class="p">,</span> <span class="mi">1</span><span class="p">)).</span><span class="o">*</span>
     <span class="k">FROM</span> <span class="n">rasters</span><span class="p">.</span><span class="n">worldclim_tmax</span>
     <span class="k">WHERE</span> <span class="n">rid</span> <span class="o">=</span> <span class="mi">23</span>
<span class="p">)</span>
<span class="k">SELECT</span>
        <span class="n">round</span><span class="p">(</span><span class="k">min</span><span class="p">::</span><span class="nb">numeric</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">AS</span> <span class="k">min</span><span class="p">,</span>
        <span class="n">round</span><span class="p">(</span><span class="k">max</span><span class="p">::</span><span class="nb">numeric</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">AS</span> <span class="k">max</span><span class="p">,</span>
        <span class="k">count</span><span class="p">,</span>
        <span class="n">round</span><span class="p">(</span><span class="n">percent</span><span class="p">::</span><span class="nb">numeric</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">AS</span> <span class="n">percent</span>
<span class="k">FROM</span> <span class="n">hist</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="k">min</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="nb">min</span>   <span class="o">|</span>  <span class="nb">max</span>   <span class="o">|</span> <span class="n">count</span> <span class="o">|</span> <span class="n">percent</span>
<span class="o">--------+--------+-------+---------</span>
 <span class="o">-</span><span class="mf">25.93</span> <span class="o">|</span> <span class="o">-</span><span class="mf">23.77</span> <span class="o">|</span>    <span class="mi">25</span> <span class="o">|</span>    <span class="mf">0.01</span>
 <span class="o">-</span><span class="mf">23.77</span> <span class="o">|</span> <span class="o">-</span><span class="mf">21.61</span> <span class="o">|</span>    <span class="mi">50</span> <span class="o">|</span>    <span class="mf">0.03</span>
 <span class="o">-</span><span class="mf">21.61</span> <span class="o">|</span> <span class="o">-</span><span class="mf">19.44</span> <span class="o">|</span>   <span class="mi">132</span> <span class="o">|</span>    <span class="mf">0.07</span>
 <span class="o">-</span><span class="mf">19.44</span> <span class="o">|</span> <span class="o">-</span><span class="mf">17.28</span> <span class="o">|</span>   <span class="mi">214</span> <span class="o">|</span>    <span class="mf">0.12</span>
 <span class="o">-</span><span class="mf">17.28</span> <span class="o">|</span> <span class="o">-</span><span class="mf">15.12</span> <span class="o">|</span>   <span class="mi">347</span> <span class="o">|</span>    <span class="mf">0.19</span>
 <span class="o">-</span><span class="mf">15.12</span> <span class="o">|</span> <span class="o">-</span><span class="mf">12.96</span> <span class="o">|</span>   <span class="mi">403</span> <span class="o">|</span>    <span class="mf">0.22</span>
 <span class="o">-</span><span class="mf">12.96</span> <span class="o">|</span> <span class="o">-</span><span class="mf">10.80</span> <span class="o">|</span>   <span class="mi">247</span> <span class="o">|</span>    <span class="mf">0.14</span>
 <span class="o">-</span><span class="mf">10.80</span> <span class="o">|</span>  <span class="o">-</span><span class="mf">8.64</span> <span class="o">|</span>   <span class="mi">280</span> <span class="o">|</span>    <span class="mf">0.15</span>
  <span class="o">-</span><span class="mf">8.64</span> <span class="o">|</span>  <span class="o">-</span><span class="mf">6.48</span> <span class="o">|</span>    <span class="mi">77</span> <span class="o">|</span>    <span class="mf">0.04</span>
  <span class="o">-</span><span class="mf">6.48</span> <span class="o">|</span>  <span class="o">-</span><span class="mf">4.32</span> <span class="o">|</span>    <span class="mi">29</span> <span class="o">|</span>    <span class="mf">0.02</span>
  <span class="o">-</span><span class="mf">4.32</span> <span class="o">|</span>  <span class="o">-</span><span class="mf">2.16</span> <span class="o">|</span>     <span class="mi">1</span> <span class="o">|</span>    <span class="mf">0.00</span>
  <span class="o">-</span><span class="mf">2.16</span> <span class="o">|</span>   <span class="mf">0.00</span> <span class="o">|</span>    <span class="mi">13</span> <span class="o">|</span>    <span class="mf">0.01</span>
</pre></div>
</div>
<ol class="arabic simple" start="16">
<li>Another way to see how the pixel values are distributed is to use <a class="reference external" href="https://postgis.net/docs/RT_ST_Quantile.html">ST_Quantile()</a>.</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Looks like 78 percent of all values are at -12.96 or below.</p>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span>
     <span class="p">(</span><span class="n">ST_Quantile</span><span class="p">(</span><span class="n">rast</span><span class="p">,</span> <span class="mi">1</span><span class="p">)).</span><span class="o">*</span>
<span class="k">FROM</span> <span class="n">rasters</span><span class="p">.</span><span class="n">worldclim_tmax</span>
<span class="k">WHERE</span> <span class="n">rid</span> <span class="o">=</span> <span class="mi">23</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">quantile</span> <span class="o">|</span>       <span class="n">value</span>
<span class="o">----------+-------------------</span>
        <span class="mi">0</span> <span class="o">|</span> <span class="o">-</span><span class="mf">25.9260864257812</span>
     <span class="mf">0.25</span> <span class="o">|</span>  <span class="o">-</span><span class="mf">16.999062538147</span>
      <span class="mf">0.5</span> <span class="o">|</span>  <span class="o">-</span><span class="mf">14.526111125946</span>
     <span class="mf">0.75</span> <span class="o">|</span> <span class="o">-</span><span class="mf">11.1928572654724</span>
        <span class="mi">1</span> <span class="o">|</span>                 <span class="mi">0</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This shows againg that 75 percent of the values align with wath previouly seen, that they are below of -16.99.</p>
</div>
<ol class="arabic simple" start="17">
<li>Let’s check the 10 top occurring values in the raster tile with <a class="reference external" href="https://postgis.net/docs/RT_ST_ValueCount.html">ST_ValueCount()</a>. You can do this also for <code class="docutils literal notranslate"><span class="pre">worldclim_tmin</span></code>.</li>
</ol>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span>
  <span class="p">(</span><span class="n">ST_ValueCount</span><span class="p">(</span><span class="n">rast</span><span class="p">,</span> <span class="mi">1</span><span class="p">)).</span><span class="o">*</span>
<span class="k">FROM</span> <span class="n">rasters</span><span class="p">.</span><span class="n">worldclim_tmax</span>
<span class="k">WHERE</span> <span class="n">rid</span> <span class="o">=</span> <span class="mi">23</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="k">count</span> <span class="k">DESC</span><span class="p">,</span> <span class="n">value</span>
<span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>       <span class="n">value</span>       <span class="o">|</span> <span class="n">count</span>
<span class="o">-------------------+-------</span>
                 <span class="mi">0</span> <span class="o">|</span>     <span class="mi">6</span>
 <span class="o">-</span><span class="mf">21.2382507324219</span> <span class="o">|</span>     <span class="mi">2</span>
               <span class="o">-</span><span class="mi">17</span> <span class="o">|</span>     <span class="mi">2</span>
 <span class="o">-</span><span class="mf">16.8117504119873</span> <span class="o">|</span>     <span class="mi">2</span>
 <span class="o">-</span><span class="mf">16.7112503051758</span> <span class="o">|</span>     <span class="mi">2</span>
 <span class="o">-</span><span class="mf">16.7000007629395</span> <span class="o">|</span>     <span class="mi">2</span>
 <span class="o">-</span><span class="mf">16.0542507171631</span> <span class="o">|</span>     <span class="mi">2</span>
 <span class="o">-</span><span class="mf">14.7344999313354</span> <span class="o">|</span>     <span class="mi">2</span>
   <span class="o">-</span><span class="mf">14.66100025177</span> <span class="o">|</span>     <span class="mi">2</span>
 <span class="o">-</span><span class="mf">14.6262502670288</span> <span class="o">|</span>     <span class="mi">2</span>
</pre></div>
</div>
<ol class="arabic simple" start="18">
<li>Since we are to look at rasters in the context of New York, an easy question to ask is: what was the mean max/min temperature for 1970-2000 in New York? Let’s import a shapefile containing just the boundaries of the city <code class="docutils literal notranslate"><span class="pre">borough_boundaries</span></code>, this is contained in the data bundle for this course. To import it let’s leave the EPSG: 4326 to match our rasters and follow the next screenshots to import it with QGIS:</li>
<li>Selecting the public SCHEMA (since this one is not a raster) using the DB Manager, click on <code class="docutils literal notranslate"><span class="pre">ìmport</span> <span class="pre">layer/File..</span></code></li>
</ol>
<img alt="_images/rasters_03.png" class="inline" src="_images/rasters_03.png" />
<ol class="arabic simple" start="20">
<li>Select the <a href="#id13"><span class="problematic" id="id14">``</span></a>borough_boundaries``from the rasters data bundle directory.</li>
</ol>
<img alt="_images/rasters_04.png" class="inline" src="_images/rasters_04.png" />
<ol class="arabic simple" start="21">
<li>Let’s select EPSG:4326 for compatibility with our rasters.</li>
</ol>
<img alt="_images/rasters_05.png" class="inline" src="_images/rasters_05.png" />
<ol class="arabic simple" start="22">
<li>Now let’s run the following SQL query to see the mean maximum temperature in January for the period of 1970-2000:</li>
</ol>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="p">(</span>
     <span class="n">ST_SummaryStats</span><span class="p">(</span>
             <span class="n">ST_Union</span><span class="p">(</span>
                     <span class="n">ST_Clip</span><span class="p">(</span><span class="n">tmax</span><span class="p">.</span><span class="n">rast</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ny</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">)</span>
             <span class="p">),</span>
             <span class="mi">1</span>
           <span class="p">)</span>
   <span class="p">).</span><span class="n">mean</span>
   <span class="k">FROM</span> <span class="n">rasters</span><span class="p">.</span><span class="n">worldclim_tmax</span> <span class="k">as</span> <span class="n">tmax</span>
   <span class="k">JOIN</span> <span class="n">borough_boundaries</span> <span class="n">ny</span>
           <span class="k">ON</span> <span class="n">ST_Intersects</span><span class="p">(</span><span class="n">tmax</span><span class="p">.</span><span class="n">rast</span><span class="p">,</span> <span class="n">ny</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span>
   <span class="k">WHERE</span> <span class="n">tmax</span><span class="p">.</span><span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;wc2.0_10m_tmax_01.tif&#39;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>       <span class="n">mean</span>
<span class="o">------------------</span>
 <span class="mf">5.22810506820679</span>
</pre></div>
</div>
<ol class="arabic simple" start="23">
<li>We can run the same for the minimum temperature as well for January and you are encouraged to try different months by changing the filename:</li>
</ol>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="p">(</span>
     <span class="n">ST_SummaryStats</span><span class="p">(</span>
             <span class="n">ST_Union</span><span class="p">(</span>
                     <span class="n">ST_Clip</span><span class="p">(</span><span class="n">tmin</span><span class="p">.</span><span class="n">rast</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ST_Transform</span><span class="p">(</span><span class="n">ny</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="mi">4326</span><span class="p">),</span> <span class="k">TRUE</span><span class="p">)</span>
             <span class="p">),</span>
             <span class="mi">1</span>
           <span class="p">)</span>
   <span class="p">).</span><span class="n">mean</span>
   <span class="k">FROM</span> <span class="n">rasters</span><span class="p">.</span><span class="n">worldclim_tmin</span> <span class="k">as</span> <span class="n">tmin</span>
   <span class="k">JOIN</span> <span class="n">borough_boundaries</span> <span class="n">ny</span>
           <span class="k">ON</span> <span class="n">ST_Intersects</span><span class="p">(</span><span class="n">tmin</span><span class="p">.</span><span class="n">rast</span><span class="p">,</span> <span class="n">ST_Transform</span><span class="p">(</span><span class="n">ny</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="mi">4326</span><span class="p">))</span>
   <span class="k">WHERE</span> <span class="n">tmin</span><span class="p">.</span><span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;wc2.0_10m_tmin_01.tif&#39;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>       <span class="n">mean</span>
<span class="o">-------------------</span>
 <span class="o">-</span><span class="mf">5.88770508766174</span>
</pre></div>
</div>
<ol class="arabic simple" start="24">
<li>Since we are working with two rasters to cover the extent of New York, let’s first create a single raster table to work with:</li>
</ol>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">rasters</span><span class="p">.</span><span class="n">srtm</span> <span class="k">AS</span>
<span class="k">SELECT</span> <span class="n">ST_Union</span><span class="p">(</span><span class="n">rast</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">rast</span>
<span class="k">FROM</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">rast</span> <span class="k">FROM</span> <span class="n">rasters</span><span class="p">.</span><span class="n">srtm1</span>
    <span class="k">UNION</span> <span class="k">ALL</span>
    <span class="k">SELECT</span> <span class="n">rast</span> <span class="k">FROM</span> <span class="n">rasters</span><span class="p">.</span><span class="n">srtm2</span><span class="p">)</span> <span class="n">foo</span>
</pre></div>
</div>
<ol class="arabic simple" start="25">
<li>Since the geometries of the shapefile of New York are also seperate let’s create a unified one for further processsing:</li>
</ol>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">singleny</span> <span class="k">AS</span>
<span class="k">SELECT</span> <span class="n">ST_Union</span><span class="p">(</span><span class="n">ny</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span> <span class="k">AS</span> <span class="n">geom</span>
<span class="k">FROM</span> <span class="n">borough_boundaries</span> <span class="n">ny</span>
</pre></div>
</div>
<p>26. We will use the SRTM rasters, loaded as 100 x 100 tiles, at the begining. With it, we will generate slope and hillshade rasters using New York as our area of interest.
The two queries below use variants of <a class="reference external" href="https://postgis.net/docs/RT_ST_Slope.html">ST_Slope()</a> and <a class="reference external" href="https://postgis.net/docs/RT_ST_HillShade.html">ST_HillShade()</a> that are only available in PostGIS 2.1 or higher versions. They permit the specification of a custom extent to constrain the processing area of the input raster. Let’s generate a slope raster from a subset of our SRTM raster tiles using ST_Slope(). A slope raster computes the rate of elevation change from one pixel to a neighboring pixel. Let’s use EPSG:26918 as the projection that best fits our purpose and to be able to use <a class="reference external" href="https://postgis.net/docs/ST_DWithin.html">ST_DWithin</a>.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">WITH</span> <span class="n">r</span> <span class="k">AS</span> <span class="p">(</span> <span class="c1">-- union of filtered tiles</span>
  <span class="k">SELECT</span>
          <span class="n">ST_Transform</span><span class="p">(</span><span class="n">ST_Union</span><span class="p">(</span><span class="n">srtm</span><span class="p">.</span><span class="n">rast</span><span class="p">),</span> <span class="mi">26918</span><span class="p">)</span> <span class="k">AS</span> <span class="n">rast</span>
  <span class="k">FROM</span> <span class="n">rasters</span><span class="p">.</span><span class="n">srtm</span> <span class="k">as</span> <span class="n">srtm</span>
  <span class="k">JOIN</span> <span class="n">singleny</span> <span class="n">ny</span>
          <span class="k">ON</span> <span class="n">ST_DWithin</span><span class="p">(</span><span class="n">ST_Transform</span><span class="p">(</span><span class="n">srtm</span><span class="p">.</span><span class="n">rast</span><span class="p">::</span><span class="n">geometry</span><span class="p">,</span> <span class="mi">26918</span><span class="p">),</span> <span class="n">ST_Transform</span><span class="p">(</span><span class="n">ny</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="mi">26918</span><span class="p">),</span> <span class="mi">1000</span><span class="p">)</span>
<span class="p">),</span> <span class="n">cx</span> <span class="k">AS</span> <span class="p">(</span> <span class="c1">-- custom extent</span>
        <span class="k">SELECT</span>
                <span class="n">ST_AsRaster</span><span class="p">(</span><span class="n">ST_Transform</span><span class="p">(</span><span class="n">ny</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="mi">26918</span><span class="p">),</span> <span class="n">r</span><span class="p">.</span><span class="n">rast</span><span class="p">)</span> <span class="k">AS</span> <span class="n">rast</span>
        <span class="k">FROM</span> <span class="n">singleny</span> <span class="n">ny</span>
        <span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">r</span>
<span class="p">)</span>
<span class="k">SELECT</span>
        <span class="n">ST_Clip</span><span class="p">(</span><span class="n">ST_Slope</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">rast</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cx</span><span class="p">.</span><span class="n">rast</span><span class="p">),</span> <span class="n">ST_Transform</span><span class="p">(</span><span class="n">ny</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="mi">26918</span><span class="p">))</span> <span class="k">AS</span> <span class="n">rast</span>
<span class="k">FROM</span> <span class="n">r</span>
<span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">cx</span>
<span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">singleny</span> <span class="n">ny</span><span class="p">;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">These queries may take a few seconds/minutes to finish for the raster calculations it’s doing, be patient. You can create a table to visualize it then in QGIS.</p>
</div>
<ol class="arabic simple" start="27">
<li>You will notice that QGIS does not show your raster layers as it does with the vector ones. There’s a workaround this. Go to the DB Manager and there will be listed all your raster tables, click on the desired one to and and select <strong>Add to Canvas</strong>.</li>
</ol>
<img alt="_images/rasters_06.png" class="inline" src="_images/rasters_06.png" />
<p>The following image shows the two SRTM covering New York already unioned.</p>
<img alt="_images/rasters_07.png" class="inline" src="_images/rasters_07.png" />
<p>This is how the slope looks with the Magma style applied to it, we can se how areas like Manhattan have higher elevation than others:</p>
<img alt="_images/rasters_08.png" class="inline" src="_images/rasters_08.png" />
<ol class="arabic simple" start="27">
<li>We can reuse the ST_Slope() query and substitute ST_HillShade() for ST_Slope() to create a hillshade raster showing how the sun would illuminate the terrain of the SRTM raster.</li>
</ol>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">WITH</span> <span class="n">r</span> <span class="k">AS</span> <span class="p">(</span> <span class="c1">-- union of filtered tiles</span>
  <span class="k">SELECT</span>
          <span class="n">ST_Transform</span><span class="p">(</span><span class="n">ST_Union</span><span class="p">(</span><span class="n">srtm</span><span class="p">.</span><span class="n">rast</span><span class="p">),</span> <span class="mi">26918</span><span class="p">)</span> <span class="k">AS</span> <span class="n">rast</span>
  <span class="k">FROM</span> <span class="n">rasters</span><span class="p">.</span><span class="n">srtm</span> <span class="n">srtm</span>
  <span class="k">JOIN</span> <span class="n">singleny</span> <span class="n">ny</span>
          <span class="k">ON</span> <span class="n">ST_DWithin</span><span class="p">(</span><span class="n">ST_Transform</span><span class="p">(</span><span class="n">srtm</span><span class="p">.</span><span class="n">rast</span><span class="p">::</span><span class="n">geometry</span><span class="p">,</span> <span class="mi">26918</span><span class="p">),</span> <span class="n">ST_Transform</span><span class="p">(</span><span class="n">ny</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="mi">26918</span><span class="p">),</span> <span class="mi">1000</span><span class="p">)</span>
<span class="p">),</span> <span class="n">cx</span> <span class="k">AS</span> <span class="p">(</span> <span class="c1">-- custom extent</span>
        <span class="k">SELECT</span>
                <span class="n">ST_AsRaster</span><span class="p">(</span><span class="n">ST_Transform</span><span class="p">(</span><span class="n">ny</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="mi">26918</span><span class="p">),</span> <span class="n">r</span><span class="p">.</span><span class="n">rast</span><span class="p">)</span> <span class="k">AS</span> <span class="n">rast</span>
        <span class="k">FROM</span> <span class="n">singleny</span> <span class="n">ny</span>
        <span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">r</span>
<span class="p">)</span>
<span class="k">SELECT</span>
        <span class="n">ST_Clip</span><span class="p">(</span><span class="n">ST_HillShade</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">rast</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cx</span><span class="p">.</span><span class="n">rast</span><span class="p">),</span> <span class="n">ST_Transform</span><span class="p">(</span><span class="n">ny</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="mi">26918</span><span class="p">))</span> <span class="k">AS</span> <span class="n">rast</span>
<span class="k">FROM</span> <span class="n">r</span>
<span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">cx</span>
<span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">singleny</span> <span class="n">ny</span><span class="p">;</span>
</pre></div>
</div>
<p>The output visualized looks like this:</p>
<img alt="_images/rasters_09.png" class="inline" src="_images/rasters_09.png" />
<p>For this course some instructions were taken from the <a class="reference external" href="https://www.amazon.com/PostGIS-Cookbook-organize-manipulate-analyze-ebook/dp/B075V94LS6/ref=dp_ob_image_def">PostGIS Cookbook 2nd Edition</a>, you’re welcome to go further into it.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="index.html">Table of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="welcome.html">1. Welcome</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">2. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="instructions.html">3. Learning Outcomes</a></li>
<li class="toctree-l1"><a class="reference internal" href="setup.html">4. Setup Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="basic.html">5. PostGIS - Basics</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">6. Advanced PostGIS</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#more-spatial-joins">6.1. More Spatial Joins</a></li>
<li class="toctree-l2"><a class="reference internal" href="#validity">6.2. Validity</a></li>
<li class="toctree-l2"><a class="reference internal" href="#equality">6.3. Equality</a></li>
<li class="toctree-l2"><a class="reference internal" href="#linear-referencing">6.4. Linear Referencing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dimensionally-extended-9-intersection-model">6.5. Dimensionally Extended 9-Intersection Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#clustering-on-indices">6.6. Clustering on Indices</a></li>
<li class="toctree-l2"><a class="reference internal" href="#d">6.7. 3-D</a></li>
<li class="toctree-l2"><a class="reference internal" href="#nearest-neighbour-searching">6.8. Nearest-Neighbour Searching</a></li>
<li class="toctree-l2"><a class="reference internal" href="#tracking-edit-history-using-triggers">6.9. Tracking Edit History using Triggers</a></li>
<li class="toctree-l2"><a class="reference internal" href="#advanced-geometry-constructions">6.10. Advanced Geometry Constructions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#working-with-rasters">6.11. Working with Rasters</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="maintenance.html">7. Maintenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="postgis-functions.html">8. Appendix A: PostGIS Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">9. Appendix B: Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">10. Appendix C: License</a></li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="basic.html"
                        title="previous chapter">5. PostGIS - Basics</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="maintenance.html"
                        title="next chapter">7. Maintenance</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="maintenance.html" title="7. Maintenance"
             >next</a></li>
        <li class="right" >
          <a href="basic.html" title="5. PostGIS - Basics"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Introduction to PostGIS</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2019 Mayra Zurbaran and 2015, Paul Ramsey, Boundless | Mark Leslie, LISAsoft.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5.
    </div>
  </body>
</html>