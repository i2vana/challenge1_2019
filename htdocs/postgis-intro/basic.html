
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>5. PostGIS - Basics &#8212; Introduction to PostGIS</title>
    <link rel="stylesheet" href="_static/pyramid.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="6. Advanced PostGIS" href="advanced.html" />
    <link rel="prev" title="4.1.3. Linux (Ubuntu 18.04 / Debian 10 Linux distribution)" href="installation_linux.html" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Neuton&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nobile:regular,italic,bold,bolditalic&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->

  </head><body>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="advanced.html" title="6. Advanced PostGIS"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="installation_linux.html" title="4.1.3. Linux (Ubuntu 18.04 / Debian 10 Linux distribution)"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Introduction to PostGIS</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="postgis-basics">
<h1>5. PostGIS - Basics<a class="headerlink" href="#postgis-basics" title="Permalink to this headline">¶</a></h1>
<div class="section" id="simple-sql">
<span id="id1"></span><h2>5.1. Simple SQL<a class="headerlink" href="#simple-sql" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="glossary.html#term-sql"><span class="xref std std-term">SQL</span></a>, or “Structured Query Language”, is a means of asking questions of, and updating data in, relational databases. You have already seen SQL when we created our first database.  Recall:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">postgis_full_version</span><span class="p">();</span>
</pre></div>
</div>
<p>But that was a question about the database.  Now that we’ve loaded data into our database, let’s use SQL to ask questions of the data! For example,</p>
<blockquote>
<div>“What are the names of all the neighborhoods in New York City?”</div></blockquote>
<p>Open up the SQL query window in pgAdmin by clicking the SQL button</p>
<img alt="_images/pgadmin_05.png" src="_images/pgadmin_05.png" />
<p>then enter the following query in to the query window</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">name</span> <span class="k">FROM</span> <span class="n">nyc_neighborhoods</span><span class="p">;</span>
</pre></div>
</div>
<p>and click the <strong>Execute Query</strong> button (again the thunder).</p>
<img alt="_images/pgadmin_05.png" src="_images/pgadmin_05.png" />
<p>The query will run for a few (milli)seconds and return the 129 results.</p>
<img alt="_images/pgadmin_09.png" src="_images/pgadmin_09.png" />
<p>But what exactly happened here?  To understand, let’s begin with the four “verbs” of SQL,</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">SELECT</span></code>, returns rows in response to a query</li>
<li><code class="docutils literal notranslate"><span class="pre">INSERT</span></code>, adds new rows to a table</li>
<li><code class="docutils literal notranslate"><span class="pre">UPDATE</span></code>, alters existing rows in a table</li>
<li><code class="docutils literal notranslate"><span class="pre">DELETE</span></code>, removes rows from a table</li>
</ul>
<p>We will be working almost exclusively with <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> in order to ask questions of tables using spatial functions.</p>
<div class="section" id="select-queries">
<h3>5.1.1. SELECT queries<a class="headerlink" href="#select-queries" title="Permalink to this headline">¶</a></h3>
<p>A select query is generally of the form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">some_columns</span> <span class="n">FROM</span> <span class="n">some_data_source</span> <span class="n">WHERE</span> <span class="n">some_condition</span><span class="p">;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For a synopsis of all <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> parameters, see the <a class="reference external" href="http://www.postgresql.org/docs/current/interactive/sql-select.html">PostgresSQL documentation</a>.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">some_columns</span></code> are either column names or functions of column values. The <code class="docutils literal notranslate"><span class="pre">some_data_source</span></code> is either a single table, or a composite table created by joining two tables on a key or condition. The <code class="docutils literal notranslate"><span class="pre">some_condition</span></code> is a filter that restricts the number of rows to be returned.</p>
<blockquote>
<div>“What are the names of all the neighborhoods in Brooklyn?”</div></blockquote>
<p>We return to our <code class="docutils literal notranslate"><span class="pre">nyc_neighborhoods</span></code> table with a filter in hand.  The table contains all the neighborhoods in New York, but we only want the ones in Brooklyn.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">name</span>
  <span class="k">FROM</span> <span class="n">nyc_neighborhoods</span>
  <span class="k">WHERE</span> <span class="n">boroname</span> <span class="o">=</span> <span class="s1">&#39;Brooklyn&#39;</span><span class="p">;</span>
</pre></div>
</div>
<p>The query will run for even fewer (milli)seconds and return the 23 results.</p>
<p>Sometimes we will need to apply a function to the results of our query. For example,</p>
<blockquote>
<div>“What is the number of letters in the names of all the neighborhoods in Brooklyn?”</div></blockquote>
<p>Fortunately, PostgreSQL has a string length function, <strong class="command">char_length(string)</strong>.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="k">char_length</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
  <span class="k">FROM</span> <span class="n">nyc_neighborhoods</span>
  <span class="k">WHERE</span> <span class="n">boroname</span> <span class="o">=</span> <span class="s1">&#39;Brooklyn&#39;</span><span class="p">;</span>
</pre></div>
</div>
<p>Often, we are less interested in the individual rows than in a statistic that applies to all of them. So knowing the lengths of the neighborhood names might be less interesting than knowing the average length of the names. Functions that take in multiple rows and return a single result are called “aggregate” functions.</p>
<p>PostgreSQL has a series of built-in aggregate functions, including the general purpose <strong class="command">avg()</strong> for average values and <strong class="command">stddev()</strong> for standard deviations.</p>
<blockquote>
<div>“What is the average number of letters and standard deviation of number of letters in the names of all the neighborhoods in Brooklyn?”</div></blockquote>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="k">avg</span><span class="p">(</span><span class="k">char_length</span><span class="p">(</span><span class="n">name</span><span class="p">)),</span> <span class="n">stddev</span><span class="p">(</span><span class="k">char_length</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
  <span class="k">FROM</span> <span class="n">nyc_neighborhoods</span>
  <span class="k">WHERE</span> <span class="n">boroname</span> <span class="o">=</span> <span class="s1">&#39;Brooklyn&#39;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>         <span class="n">avg</span>         <span class="o">|</span>       <span class="n">stddev</span>
<span class="o">---------------------+--------------------</span>
 <span class="mf">11.7391304347826087</span> <span class="o">|</span> <span class="mf">3.9105613559407395</span>
</pre></div>
</div>
<p>The aggregate functions in our last example were applied to every row in the result set. What if we want the summaries to be carried out over smaller groups within the overall result set? For that we add a <code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code> clause. Aggregate functions often need an added <code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code> statement to group the result-set by one or more columns.</p>
<blockquote>
<div>“What is the average number of letters in the names of all the neighborhoods in New York City, reported by borough?”</div></blockquote>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">boroname</span><span class="p">,</span> <span class="k">avg</span><span class="p">(</span><span class="k">char_length</span><span class="p">(</span><span class="n">name</span><span class="p">)),</span> <span class="n">stddev</span><span class="p">(</span><span class="k">char_length</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
  <span class="k">FROM</span> <span class="n">nyc_neighborhoods</span>
  <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">boroname</span><span class="p">;</span>
</pre></div>
</div>
<p>We include the <code class="docutils literal notranslate"><span class="pre">boroname</span></code> column in the output result so we can determine which statistic applies to which borough. In an aggregate query, you can only output columns that are either (a) members of the grouping clause or (b) aggregate functions.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   <span class="n">boroname</span>    <span class="o">|</span>         <span class="n">avg</span>         <span class="o">|</span>       <span class="n">stddev</span>
<span class="o">---------------+---------------------+--------------------</span>
 <span class="n">Brooklyn</span>      <span class="o">|</span> <span class="mf">11.7391304347826087</span> <span class="o">|</span> <span class="mf">3.9105613559407395</span>
 <span class="n">Manhattan</span>     <span class="o">|</span> <span class="mf">11.8214285714285714</span> <span class="o">|</span> <span class="mf">4.3123729948325257</span>
 <span class="n">The</span> <span class="n">Bronx</span>     <span class="o">|</span> <span class="mf">12.0416666666666667</span> <span class="o">|</span> <span class="mf">3.6651017740975152</span>
 <span class="n">Queens</span>        <span class="o">|</span> <span class="mf">11.6666666666666667</span> <span class="o">|</span> <span class="mf">5.0057438272815975</span>
 <span class="n">Staten</span> <span class="n">Island</span> <span class="o">|</span> <span class="mf">12.2916666666666667</span> <span class="o">|</span> <span class="mf">5.2043390480959474</span>
</pre></div>
</div>
</div>
<div class="section" id="function-list">
<h3>5.1.2. Function List<a class="headerlink" href="#function-list" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://www.postgresql.org/docs/current/static/functions-aggregate.html#FUNCTIONS-AGGREGATE-TABLE">avg(expression)</a>: PostgreSQL aggregate function that returns the average value of a numeric column.</p>
<p><a class="reference external" href="http://www.postgresql.org/docs/current/static/functions-string.html">char_length(string)</a>: PostgreSQL string function that returns the number of character in a string.</p>
<p><a class="reference external" href="http://www.postgresql.org/docs/current/static/functions-aggregate.html#FUNCTIONS-AGGREGATE-STATISTICS-TABLE">stddev(expression)</a>: PostgreSQL aggregate function that returns the standard deviation of input values.</p>
</div>
</div>
<div class="section" id="simple-sql-exercises">
<span id="id2"></span><h2>5.2. Simple SQL Exercises<a class="headerlink" href="#simple-sql-exercises" title="Permalink to this headline">¶</a></h2>
<p>Using the <code class="docutils literal notranslate"><span class="pre">nyc_census_blocks</span></code> table, answer the following questions (don’t peak at the answers!).</p>
<p>Here is some helpful information to get started.  Recall from the <a class="reference internal" href="setup/about_data.html#about-data"><span class="std std-ref">About Our Data</span></a> section our <code class="docutils literal notranslate"><span class="pre">nyc_census_blocks</span></code> table definition.</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="20%" />
<col width="80%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><strong>blkid</strong></td>
<td>A 15-digit code that uniquely identifies every census <strong>block</strong>. (“360050001009000”)</td>
</tr>
<tr class="row-even"><td><strong>popn_total</strong></td>
<td>Total number of people in the census block</td>
</tr>
<tr class="row-odd"><td><strong>popn_white</strong></td>
<td>Number of people self-identifying as “white” in the block</td>
</tr>
<tr class="row-even"><td><strong>popn_black</strong></td>
<td>Number of people self-identifying as “black” in the block</td>
</tr>
<tr class="row-odd"><td><strong>popn_nativ</strong></td>
<td>Number of people self-identifying as “native american” in the block</td>
</tr>
<tr class="row-even"><td><strong>popn_asian</strong></td>
<td>Number of people self-identifying as “asias” in the block</td>
</tr>
<tr class="row-odd"><td><strong>popn_other</strong></td>
<td>Number of people self-identifying with other categories in the block</td>
</tr>
<tr class="row-even"><td><strong>hous_total</strong></td>
<td>Number of housing units in the block</td>
</tr>
<tr class="row-odd"><td><strong>hous_own</strong></td>
<td>Number of owner-occupied housing units in the block</td>
</tr>
<tr class="row-even"><td><strong>hous_rent</strong></td>
<td>Number of renter-occupied housing units in the block</td>
</tr>
<tr class="row-odd"><td><strong>boroname</strong></td>
<td>Name of the New York borough. Manhattan, The Bronx, Brooklyn, Staten Island, Queens</td>
</tr>
<tr class="row-even"><td><strong>geom</strong></td>
<td>Polygon boundary of the block</td>
</tr>
</tbody>
</table>
<p>And, here are some common SQL aggregation functions you might find useful:</p>
<ul class="simple">
<li>avg() - the average (mean) of the values in a set of records</li>
<li>sum() - the sum of the values in a set of records</li>
<li>count() - the number of records in a set of records</li>
</ul>
<p>Now the questions:</p>
<ul>
<li><p class="first"><strong>“What is the geometry value for the street named ‘Atlantic Commons’?”</strong></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">ST_AsText</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
  <span class="k">FROM</span> <span class="n">nyc_streets</span>
  <span class="k">WHERE</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Atlantic Commons&#39;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MULTILINESTRING</span><span class="p">((</span><span class="mf">586781.701577724</span> <span class="mf">4504202.15314339</span><span class="p">,</span><span class="mf">586863.51964484</span> <span class="mf">4504215.9881701</span><span class="p">))</span>
</pre></div>
</div>
</li>
<li><p class="first"><strong>“What neighborhood and borough is Atlantic Commons in?”</strong></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">name</span><span class="p">,</span> <span class="n">boroname</span>
<span class="k">FROM</span> <span class="n">nyc_neighborhoods</span>
<span class="k">WHERE</span> <span class="n">ST_Intersects</span><span class="p">(</span>
  <span class="n">geom</span><span class="p">,</span>
  <span class="n">ST_GeomFromText</span><span class="p">(</span><span class="s1">&#39;LINESTRING(586782 4504202,586864 4504216)&#39;</span><span class="p">,</span> <span class="mi">26918</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">name</span>    <span class="o">|</span> <span class="n">boroname</span>
<span class="o">------------+----------</span>
 <span class="n">Fort</span> <span class="n">Green</span> <span class="o">|</span> <span class="n">Brooklyn</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>“Hey, why did you change from a ‘MULTILINESTRING’ to a ‘LINESTRING’?” Spatially they describe the same shape, so going from a single-item multi-geometry to a singleton saves a few keystrokes.</p>
<p class="last">More importantly, we also rounded the coordinates to make them easier to read, which does actually change results: we couldn’t use the ST_Touches() predicate to find out which roads join Atlantic Commons, because the coordinates are not exactly the same anymore.</p>
</div>
</li>
<li><p class="first"><strong>“What streets does Atlantic Commons join with?”</strong></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">name</span>
<span class="k">FROM</span> <span class="n">nyc_streets</span>
<span class="k">WHERE</span> <span class="n">ST_DWithin</span><span class="p">(</span>
  <span class="n">geom</span><span class="p">,</span>
  <span class="n">ST_GeomFromText</span><span class="p">(</span><span class="s1">&#39;LINESTRING(586782 4504202,586864 4504216)&#39;</span><span class="p">,</span> <span class="mi">26918</span><span class="p">),</span>
  <span class="mi">0</span><span class="p">.</span><span class="mi">1</span>
<span class="p">);</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>     <span class="n">name</span>
<span class="o">------------------</span>
 <span class="n">Cumberland</span> <span class="n">St</span>
 <span class="n">Atlantic</span> <span class="n">Commons</span>
</pre></div>
</div>
<img alt="_images/atlantic_commons.jpg" src="_images/atlantic_commons.jpg" />
</li>
<li><p class="first"><strong>“Approximately how many people live on (within 50 meters of) Atlantic Commons?”</strong></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="k">Sum</span><span class="p">(</span><span class="n">popn_total</span><span class="p">)</span>
  <span class="k">FROM</span> <span class="n">nyc_census_blocks</span>
  <span class="k">WHERE</span> <span class="n">ST_DWithin</span><span class="p">(</span>
   <span class="n">geom</span><span class="p">,</span>
   <span class="n">ST_GeomFromText</span><span class="p">(</span><span class="s1">&#39;LINESTRING(586782 4504202,586864 4504216)&#39;</span><span class="p">,</span> <span class="mi">26918</span><span class="p">),</span>
   <span class="mi">50</span>
  <span class="p">);</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">1438</span>
</pre></div>
</div>
</li>
</ul>
<div class="section" id="id3">
<h3>5.2.1. Function List<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://www.postgresql.org/docs/current/static/functions-aggregate.html#FUNCTIONS-AGGREGATE-TABLE">avg(expression)</a>: PostgreSQL aggregate function that returns the average value of a numeric column.</p>
<p><a class="reference external" href="http://www.postgresql.org/docs/current/static/functions-aggregate.html#FUNCTIONS-AGGREGATE-TABLE">count(expression)</a>: PostgreSQL aggregate function that returns the number of records in a set of records.</p>
<p><a class="reference external" href="http://www.postgresql.org/docs/current/static/functions-aggregate.html#FUNCTIONS-AGGREGATE-TABLE">sum(expression)</a>: PostgreSQL aggregate function that returns the sum of records in a set of records.</p>
</div>
</div>
<div class="section" id="geometries">
<span id="id5"></span><h2>5.3. Geometries<a class="headerlink" href="#geometries" title="Permalink to this headline">¶</a></h2>
<div class="section" id="introduction">
<h3>5.3.1. Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h3>
<p>In the previous <a class="reference internal" href="setup/loading_data.html#loading-data"><span class="std std-ref">section</span></a>, we loaded a variety of data.  Before we start playing with our data lets have a look at some simpler examples.  In pgAdmin, once again select the <strong>nyc</strong> database and open the SQL query tool.  Paste this example SQL code into the pgAdmin SQL Editor window (removing any text that may be there by default) and then execute.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">geometries</span> <span class="p">(</span><span class="n">name</span> <span class="nb">varchar</span><span class="p">,</span> <span class="n">geom</span> <span class="n">geometry</span><span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">geometries</span> <span class="k">VALUES</span>
  <span class="p">(</span><span class="s1">&#39;Point&#39;</span><span class="p">,</span> <span class="s1">&#39;POINT(0 0)&#39;</span><span class="p">),</span>
  <span class="p">(</span><span class="s1">&#39;Linestring&#39;</span><span class="p">,</span> <span class="s1">&#39;LINESTRING(0 0, 1 1, 2 1, 2 2)&#39;</span><span class="p">),</span>
  <span class="p">(</span><span class="s1">&#39;Polygon&#39;</span><span class="p">,</span> <span class="s1">&#39;POLYGON((0 0, 1 0, 1 1, 0 1, 0 0))&#39;</span><span class="p">),</span>
  <span class="p">(</span><span class="s1">&#39;PolygonWithHole&#39;</span><span class="p">,</span> <span class="s1">&#39;POLYGON((0 0, 10 0, 10 10, 0 10, 0 0),(1 1, 1 2, 2 2, 2 1, 1 1))&#39;</span><span class="p">),</span>
  <span class="p">(</span><span class="s1">&#39;Collection&#39;</span><span class="p">,</span> <span class="s1">&#39;GEOMETRYCOLLECTION(POINT(2 0),POLYGON((0 0, 1 0, 1 1, 0 1, 0 0)))&#39;</span><span class="p">);</span>

<span class="k">SELECT</span> <span class="n">name</span><span class="p">,</span> <span class="n">ST_AsText</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">geometries</span><span class="p">;</span>
</pre></div>
</div>
<img alt="_images/start01.png" src="_images/start01.png" />
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In versions of PostGIS &gt;= 2.0 the behavior to add geometry columns changed and it is now possible to specify the type of geometry and srid while creating a table as done in the previous query. Before, the <a class="reference external" href="https://postgis.net/docs/AddGeometryColumn.html">AddGeometryColumn</a> function had to be used to specify the geometry column after the creation of the table, both ways are now possible.</p>
</div>
<p>The above example CREATEs a table (<strong>geometries</strong>) then INSERTs five geometries: a point, a line, a polygon, a polygon with a hole, and a collection. Finally, the inserted rows are SELECTed and displayed in the Output pane.</p>
</div>
<div class="section" id="metadata-tables">
<h3>5.3.2. Metadata Tables<a class="headerlink" href="#metadata-tables" title="Permalink to this headline">¶</a></h3>
<p>In conformance with the Simple Features for SQL (<a class="reference internal" href="glossary.html#term-sfsql"><span class="xref std std-term">SFSQL</span></a>) specification, PostGIS provides two tables to track and report on the geometry types available in a given database.</p>
<ul class="simple">
<li>The first table, <code class="docutils literal notranslate"><span class="pre">spatial_ref_sys</span></code>, defines all the spatial reference systems known to the database and will be described in greater detail later.</li>
<li>The second table (actually, a view), <code class="docutils literal notranslate"><span class="pre">geometry_columns</span></code>, provides a listing of all “features” (defined as an object with geometric attributes), and the basic details of those features.</li>
</ul>
<img alt="_images/table01.png" class="inline" src="_images/table01.png" />
<p>Let’s have a look at the <code class="docutils literal notranslate"><span class="pre">geometry_columns</span></code> table in our database.  Paste this command in the Query Tool as before:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">geometry_columns</span><span class="p">;</span>
</pre></div>
</div>
<img alt="_images/start08.png" class="inline" src="_images/start08.png" />
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">f_table_catalog</span></code> together with <code class="docutils literal notranslate"><span class="pre">f_table_schema</span></code>, and <code class="docutils literal notranslate"><span class="pre">f_table_name</span></code>, the fully qualified name of the featured table containing the geometry column. Where the <code class="docutils literal notranslate"><span class="pre">f_table_catalog</span></code> contains detailed information (sometimes called <strong>descriptor information</strong> or <strong>metadata</strong>) regarding the various objects that are of interest to the system itself. The catalog is the place where–among other things–all of the various schemas (<code class="docutils literal notranslate"><span class="pre">f_table_schema</span></code>) (external, conceptual, internal) and all of the corresponding mappings (external/conceptual, conceptual/internal) are kept.</li>
<li><code class="docutils literal notranslate"><span class="pre">f_table_name</span></code> is the table schema that is implementing the geometry column.</li>
<li><a href="#id6"><span class="problematic" id="id7">``</span></a>g_table_name``is the table name that is implementing the geometry column.</li>
<li><code class="docutils literal notranslate"><span class="pre">f_geometry_column</span></code> is the name of the column that contains a geometry – for feature tables with multiple geometry columns, there will be one record for each.</li>
<li><code class="docutils literal notranslate"><span class="pre">coord_dimension</span></code> and <code class="docutils literal notranslate"><span class="pre">srid</span></code> define the the dimension of the geometry (2-, 3- or 4-dimensional) and the Spatial Reference system identifier that refers to the <code class="docutils literal notranslate"><span class="pre">spatial_ref_sys</span></code> table respectively.</li>
<li>The <code class="docutils literal notranslate"><span class="pre">type</span></code> column defines the type of geometry as described below; we’ve seen Point and Linestring types so far.</li>
</ul>
<p>By querying this table, GIS clients and libraries can determine what to expect when retrieving data and can perform any necessary projection, processing or rendering without needing to inspect each geometry.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Do some or all of your <code class="docutils literal notranslate"><span class="pre">nyc</span></code> tables not have an <code class="docutils literal notranslate"><span class="pre">srid</span></code> of 26918? It’s easy to fix by updating the table</p>
<div class="last highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">UpdateGeometrySRID</span><span class="p">(</span><span class="s1">&#39;nyc_neighborhoods&#39;</span><span class="p">,</span><span class="s1">&#39;geom&#39;</span><span class="p">,</span><span class="mi">26918</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="representing-real-world-objects">
<h3>5.3.3. Representing Real World Objects<a class="headerlink" href="#representing-real-world-objects" title="Permalink to this headline">¶</a></h3>
<p>The Simple Features for SQL (<a class="reference internal" href="glossary.html#term-sfsql"><span class="xref std std-term">SFSQL</span></a>) specification, the original guiding standard for PostGIS development, defines how a real world object is represented.  By taking a continuous shape and digitizing it at a fixed resolution we achieve a passable representation of the object.  SFSQL only handled 2-dimensional representations.  PostGIS has extended that to include 3- and 4-dimensional representations; more recently the SQL-Multimedia Part 3 (<a class="reference internal" href="glossary.html#term-sql-mm"><span class="xref std std-term">SQL/MM</span></a>) specification has officially defined their own representation.</p>
<p>Our example table contains a mixture of different geometry types. We can collect general information about each object using functions that read the geometry metadata.</p>
<ul class="simple">
<li><strong class="command">ST_GeometryType(geometry)</strong> returns the type of the geometry</li>
<li><strong class="command">ST_NDims(geometry)</strong> returns the number of dimensions of the geometry</li>
<li><strong class="command">ST_SRID(geometry)</strong> returns the spatial reference identifier number of the geometry</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">name</span><span class="p">,</span> <span class="n">ST_GeometryType</span><span class="p">(</span><span class="n">geom</span><span class="p">),</span> <span class="n">ST_NDims</span><span class="p">(</span><span class="n">geom</span><span class="p">),</span> <span class="n">ST_SRID</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
  <span class="k">FROM</span> <span class="n">geometries</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>      <span class="n">name</span>       <span class="o">|</span>    <span class="n">st_geometrytype</span>    <span class="o">|</span> <span class="n">st_ndims</span> <span class="o">|</span> <span class="n">st_srid</span>
<span class="o">-----------------+-----------------------+----------+---------</span>
 <span class="n">Point</span>           <span class="o">|</span> <span class="n">ST_Point</span>              <span class="o">|</span>        <span class="mi">2</span> <span class="o">|</span>       <span class="mi">0</span>
 <span class="n">Polygon</span>         <span class="o">|</span> <span class="n">ST_Polygon</span>            <span class="o">|</span>        <span class="mi">2</span> <span class="o">|</span>       <span class="mi">0</span>
 <span class="n">PolygonWithHole</span> <span class="o">|</span> <span class="n">ST_Polygon</span>            <span class="o">|</span>        <span class="mi">2</span> <span class="o">|</span>       <span class="mi">0</span>
 <span class="n">Collection</span>      <span class="o">|</span> <span class="n">ST_GeometryCollection</span> <span class="o">|</span>        <span class="mi">2</span> <span class="o">|</span>       <span class="mi">0</span>
 <span class="n">Linestring</span>      <span class="o">|</span> <span class="n">ST_LineString</span>         <span class="o">|</span>        <span class="mi">2</span> <span class="o">|</span>       <span class="mi">0</span>
</pre></div>
</div>
<div class="section" id="points">
<h4>5.3.3.1. Points<a class="headerlink" href="#points" title="Permalink to this headline">¶</a></h4>
<img alt="_images/points.png" class="inline align-center" src="_images/points.png" />
<p>A spatial <strong>point</strong> represents a single location on the Earth.  This point is represented by a single coordinate (including either 2-, 3- or 4-dimensions).  Points are used to represent objects when the exact details, such as shape and size, are not important at the target scale.  For example, cities on a map of the world can be described as points, while a map of a single state might represent cities as polygons.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">ST_AsText</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
  <span class="k">FROM</span> <span class="n">geometries</span>
  <span class="k">WHERE</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Point&#39;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">POINT</span><span class="p">(</span><span class="mi">0</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>Some of the specific spatial functions for working with points are:</p>
<ul class="simple">
<li><strong class="command">ST_X(geometry)</strong> returns the X ordinate</li>
<li><strong class="command">ST_Y(geometry)</strong> returns the Y ordinate</li>
</ul>
<p>So, we can read the ordinates from a point like this:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">ST_X</span><span class="p">(</span><span class="n">geom</span><span class="p">),</span> <span class="n">ST_Y</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
  <span class="k">FROM</span> <span class="n">geometries</span>
  <span class="k">WHERE</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Point&#39;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">st_x</span> <span class="o">|</span> <span class="n">st_y</span>
<span class="o">------+------</span>
    <span class="mi">0</span> <span class="o">|</span>    <span class="mi">0</span>
</pre></div>
</div>
<p>The New York City subway stations (<code class="docutils literal notranslate"><span class="pre">nyc_subway_stations</span></code>) table is a data set represented as points. The following SQL query will return the geometry associated with one point (in the <strong class="command">ST_AsText</strong> column).</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">name</span><span class="p">,</span> <span class="n">ST_AsText</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
  <span class="k">FROM</span> <span class="n">nyc_subway_stations</span>
  <span class="k">LIMIT</span> <span class="mi">1</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="linestrings">
<h4>5.3.3.2. Linestrings<a class="headerlink" href="#linestrings" title="Permalink to this headline">¶</a></h4>
<img alt="_images/lines.png" class="inline align-center" src="_images/lines.png" />
<p>A <strong>linestring</strong> is a path between locations.  It takes the form of an ordered series of two or more points.  Roads and rivers are typically represented as linestrings.  A linestring is said to be <strong>closed</strong> if it starts and ends on the same point.  It is said to be <strong>simple</strong> if it does not cross or touch itself (except at its endpoints if it is closed).  A linestring can be both <strong>closed</strong> and <strong>simple</strong>.</p>
<p>The street network for New York (<code class="docutils literal notranslate"><span class="pre">nyc_streets</span></code>) was loaded earlier in the course.  This dataset contains details such as name, and type.  A single real world street may consist of many linestrings, each representing a segment of road with different attributes.</p>
<p>The following SQL query will return the geometry associated with one linestring (in the <strong class="command">ST_AsText</strong> column).</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">ST_AsText</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
  <span class="k">FROM</span> <span class="n">geometries</span>
  <span class="k">WHERE</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Linestring&#39;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LINESTRING</span><span class="p">(</span><span class="mi">0</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>Some of the specific spatial functions for working with linestrings are:</p>
<ul class="simple">
<li><strong class="command">ST_Length(geometry)</strong> returns the length of the linestring</li>
<li><strong class="command">ST_StartPoint(geometry)</strong> returns the first coordinate as a point</li>
<li><strong class="command">ST_EndPoint(geometry)</strong> returns the last coordinate as a point</li>
<li><strong class="command">ST_NPoints(geometry)</strong> returns the number of coordinates in the linestring</li>
</ul>
<p>So, the length of our linestring is:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">ST_Length</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
  <span class="k">FROM</span> <span class="n">geometries</span>
  <span class="k">WHERE</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Linestring&#39;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">3.41421356237309</span>
</pre></div>
</div>
</div>
<div class="section" id="polygons">
<h4>5.3.3.3. Polygons<a class="headerlink" href="#polygons" title="Permalink to this headline">¶</a></h4>
<img alt="_images/polygons.png" class="inline align-center" src="_images/polygons.png" />
<p>A polygon is a representation of an area.  The outer boundary of the polygon is represented by a ring.  This ring is a linestring that is both closed and simple as defined above.  Holes within the polygon are also represented by rings.</p>
<p>Polygons are used to represent objects whose size and shape are important.  City limits, parks, building footprints or bodies of water are all commonly represented as polygons when the scale is sufficiently high to see their area.  Roads and rivers can sometimes be represented as polygons.</p>
<p>The following SQL query will return the geometry associated with one linestring (in the <strong class="command">ST_AsText</strong> column).</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">ST_AsText</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
  <span class="k">FROM</span> <span class="n">geometries</span>
  <span class="k">WHERE</span> <span class="n">name</span> <span class="k">LIKE</span> <span class="s1">&#39;Polygon%&#39;</span><span class="p">;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Rather than using an <code class="docutils literal notranslate"><span class="pre">=</span></code> sign in our <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> clause, we are using the <code class="docutils literal notranslate"><span class="pre">LIKE</span></code> operator to carry out a string matching operation. <strong>You may be used to the ``*`` symbol as a “glob” for pattern matching, but in SQL the ``%`` symbol is used</strong>, along with the <code class="docutils literal notranslate"><span class="pre">LIKE</span></code> operator to tell the system to do globbing.</p>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">POLYGON</span><span class="p">((</span><span class="mi">0</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">POLYGON</span><span class="p">((</span><span class="mi">0</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">),(</span><span class="mi">1</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
<p>The first polygon has only one ring. The second one has an interior “hole”. Most graphics systems include the concept of a “polygon”, but GIS systems are relatively unique in allowing polygons to explicitly have holes.</p>
<img alt="_images/polygons1.png" class="inline align-center" src="_images/polygons1.png" />
<p>Some of the specific spatial functions for working with polygons are:</p>
<ul class="simple">
<li><strong class="command">ST_Area(geometry)</strong> returns the area of the polygons</li>
<li><strong class="command">ST_NRings(geometry)</strong> returns the number of rings (usually 1, more of there are holes)</li>
<li><strong class="command">ST_ExteriorRing(geometry)</strong> returns the outer ring as a linestring</li>
<li><strong class="command">ST_InteriorRingN(geometry,n)</strong> returns a specified interior ring as a linestring</li>
<li><strong class="command">ST_Perimeter(geometry)</strong> returns the length of all the rings</li>
</ul>
<p>We can calculate the area of our polygons using the area function:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">name</span><span class="p">,</span> <span class="n">ST_Area</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
  <span class="k">FROM</span> <span class="n">geometries</span>
  <span class="k">WHERE</span> <span class="n">name</span> <span class="k">LIKE</span> <span class="s1">&#39;Polygon%&#39;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Polygon</span>            <span class="mi">1</span>
<span class="n">PolygonWithHole</span>    <span class="mi">99</span>
</pre></div>
</div>
<p>Note that the polygon with a hole has an area that is the area of the outer shell (a 10x10 square) minus the area of the hole (a 1x1 square).</p>
</div>
<div class="section" id="collections">
<h4>5.3.3.4. Collections<a class="headerlink" href="#collections" title="Permalink to this headline">¶</a></h4>
<p>There are four collection types, which group multiple simple geometries into sets.</p>
<ul class="simple">
<li><strong>MultiPoint</strong>, a collection of points</li>
<li><strong>MultiLineString</strong>, a collection of linestrings</li>
<li><strong>MultiPolygon</strong>, a collection of polygons</li>
<li><strong>GeometryCollection</strong>, a heterogeneous collection of any geometry (including other collections)</li>
</ul>
<p>Collections are another concept that shows up in GIS software more than in generic graphics software. They are useful for directly modeling real world objects as spatial objects. For example, how to model a lot that is split by a right-of-way? As a <strong>MultiPolygon</strong>, with a part on either side of the right-of-way.</p>
<img alt="_images/collection2.png" class="inline align-center" src="_images/collection2.png" />
<p>Our example collection contains a polygon and a point:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">name</span><span class="p">,</span> <span class="n">ST_AsText</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
  <span class="k">FROM</span> <span class="n">geometries</span>
  <span class="k">WHERE</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Collection&#39;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">GEOMETRYCOLLECTION</span><span class="p">(</span><span class="n">POINT</span><span class="p">(</span><span class="mi">2</span> <span class="mi">0</span><span class="p">),</span><span class="n">POLYGON</span><span class="p">((</span><span class="mi">0</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">)))</span>
</pre></div>
</div>
<img alt="_images/collection.png" class="inline align-center" src="_images/collection.png" />
<p>Some of the specific spatial functions for working with collections are:</p>
<ul class="simple">
<li><strong class="command">ST_NumGeometries(geometry)</strong> returns the number of parts in the collection</li>
<li><strong class="command">ST_GeometryN(geometry,n)</strong> returns the specified part</li>
<li><strong class="command">ST_Area(geometry)</strong> returns the total area of all polygonal parts</li>
<li><strong class="command">ST_Length(geometry)</strong> returns the total length of all linear parts</li>
</ul>
</div>
</div>
<div class="section" id="geometry-input-and-output">
<h3>5.3.4. Geometry Input and Output<a class="headerlink" href="#geometry-input-and-output" title="Permalink to this headline">¶</a></h3>
<p>Within the database, geometries are stored on disk in a format only used by the PostGIS program. In order for external programs to insert and retrieve useful geometries, they need to be converted into a format that other applications can understand. Fortunately, PostGIS supports emitting and consuming geometries in a large number of formats:</p>
<ul class="simple">
<li>Well-known text (<a class="reference internal" href="glossary.html#term-wkt"><span class="xref std std-term">WKT</span></a>)<ul>
<li><strong class="command">ST_GeomFromText(text, srid)</strong> returns <code class="docutils literal notranslate"><span class="pre">geometry</span></code></li>
<li><strong class="command">ST_AsText(geometry)</strong> returns <code class="docutils literal notranslate"><span class="pre">text</span></code></li>
<li><strong class="command">ST_AsEWKT(geometry)</strong> returns <code class="docutils literal notranslate"><span class="pre">text</span></code></li>
</ul>
</li>
<li>Well-known binary (<a class="reference internal" href="glossary.html#term-wkb"><span class="xref std std-term">WKB</span></a>)<ul>
<li><strong class="command">ST_GeomFromWKB(bytea)</strong> returns <code class="docutils literal notranslate"><span class="pre">geometry</span></code></li>
<li><strong class="command">ST_AsBinary(geometry)</strong> returns <code class="docutils literal notranslate"><span class="pre">bytea</span></code></li>
<li><strong class="command">ST_AsEWKB(geometry)</strong> returns <code class="docutils literal notranslate"><span class="pre">bytea</span></code></li>
</ul>
</li>
<li>Geographic Mark-up Language (<a class="reference internal" href="glossary.html#term-gml"><span class="xref std std-term">GML</span></a>)<ul>
<li><strong class="command">ST_GeomFromGML(text)</strong> returns <code class="docutils literal notranslate"><span class="pre">geometry</span></code></li>
<li><strong class="command">ST_AsGML(geometry)</strong> returns <code class="docutils literal notranslate"><span class="pre">text</span></code></li>
</ul>
</li>
<li>Keyhole Mark-up Language (<a class="reference internal" href="glossary.html#term-kml"><span class="xref std std-term">KML</span></a>)<ul>
<li><strong class="command">ST_GeomFromKML(text)</strong> returns <code class="docutils literal notranslate"><span class="pre">geometry</span></code></li>
<li><strong class="command">ST_AsKML(geometry)</strong> returns <code class="docutils literal notranslate"><span class="pre">text</span></code></li>
</ul>
</li>
<li><a class="reference internal" href="glossary.html#term-geojson"><span class="xref std std-term">GeoJSON</span></a><ul>
<li><strong class="command">ST_AsGeoJSON(geometry)</strong> returns <code class="docutils literal notranslate"><span class="pre">text</span></code></li>
</ul>
</li>
<li>Scalable Vector Graphics (<a class="reference internal" href="glossary.html#term-svg"><span class="xref std std-term">SVG</span></a>)<ul>
<li><strong class="command">ST_AsSVG(geometry)</strong> returns <code class="docutils literal notranslate"><span class="pre">text</span></code></li>
</ul>
</li>
</ul>
<p>The most common use of a constructor is to turn a text representation of a geometry into an internal representation:</p>
<p>Note that in addition to a text parameter with a geometry representation, we also have a numeric parameter providing the <a class="reference internal" href="glossary.html#term-srid"><span class="xref std std-term">SRID</span></a> of the geometry.</p>
<p>The following SQL query shows an example of <a class="reference internal" href="glossary.html#term-wkb"><span class="xref std std-term">WKB</span></a> representation (the call to <strong class="command">encode()</strong> is required to convert the binary output into an ASCII form for printing):</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">encode</span><span class="p">(</span>
  <span class="n">ST_AsBinary</span><span class="p">(</span><span class="n">ST_GeometryFromText</span><span class="p">(</span><span class="s1">&#39;LINESTRING(0 0,1 0)&#39;</span><span class="p">)),</span>
  <span class="s1">&#39;hex&#39;</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">01020000000200000000000000000000000000000000000000000000000000</span><span class="n">f03f0000000000000000</span>
</pre></div>
</div>
<p>For the purposes of this course we will continue to use WKT to ensure you can read and understand the geometries we’re viewing.  However, most actual processes, such as viewing data in a GIS application, transferring data to a web service, or processing data remotely, WKB is the binary equivalent and is format of choice as they were originally defined by the Open Geospatial Consortium (OGC) and described in their <a class="reference external" href="https://www.opengeospatial.org/standards/sfa">Simple Feature Access</a>.</p>
<p>Since WKT and WKB were defined in the  <a class="reference internal" href="glossary.html#term-sfsql"><span class="xref std std-term">SFSQL</span></a> specification, they do not handle 3- or 4-dimensional geometries.  For these cases PostGIS has defined the Extended Well Known Text (EWKT) and Extended Well Known Binary (EWKB) formats.  These provide the same formatting capabilities of WKT and WKB with the added dimensionality and will be explored in a further section of this course <a class="reference internal" href="advanced.html#d"><span class="std std-ref">section</span></a>.</p>
<p>Here is an example of a 3D linestring in WKT:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">ST_AsText</span><span class="p">(</span><span class="n">ST_GeometryFromText</span><span class="p">(</span><span class="s1">&#39;LINESTRING(0 0 0,1 0 0,1 1 2)&#39;</span><span class="p">));</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LINESTRING</span> <span class="n">Z</span> <span class="p">(</span><span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span> <span class="mi">1</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that the text representation changes! This is because the text input routine for PostGIS is liberal in what it consumes. It will consume</p>
<ul class="simple">
<li>hex-encoded EWKB,</li>
<li>extended well-known text, and</li>
<li>ISO standard well-known text.</li>
</ul>
<p>On the output side, the <strong class="command">ST_AsText</strong> function is conservative, and only emits ISO standard well-known text.</p>
<p>In addition to the <strong class="command">ST_GeometryFromText</strong> function, there are many other ways to create geometries from well-known text or similar formatted inputs:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Using ST_GeomFromText with the SRID parameter</span>
<span class="k">SELECT</span> <span class="n">ST_GeomFromText</span><span class="p">(</span><span class="s1">&#39;POINT(2 2)&#39;</span><span class="p">,</span><span class="mi">4326</span><span class="p">);</span>

<span class="c1">-- Using ST_GeomFromText without the SRID parameter</span>
<span class="k">SELECT</span> <span class="n">ST_SetSRID</span><span class="p">(</span><span class="n">ST_GeomFromText</span><span class="p">(</span><span class="s1">&#39;POINT(2 2)&#39;</span><span class="p">),</span><span class="mi">4326</span><span class="p">);</span>

<span class="c1">-- Using a ST_Make* function</span>
<span class="k">SELECT</span> <span class="n">ST_SetSRID</span><span class="p">(</span><span class="n">ST_MakePoint</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">4326</span><span class="p">);</span>

<span class="c1">-- Using PostgreSQL casting syntax and ISO WKT</span>
<span class="k">SELECT</span> <span class="n">ST_SetSRID</span><span class="p">(</span><span class="s1">&#39;POINT(2 2)&#39;</span><span class="p">::</span><span class="n">geometry</span><span class="p">,</span> <span class="mi">4326</span><span class="p">);</span>

<span class="c1">-- Using PostgreSQL casting syntax and extended WKT</span>
<span class="k">SELECT</span> <span class="s1">&#39;SRID=4326;POINT(2 2)&#39;</span><span class="p">::</span><span class="n">geometry</span><span class="p">;</span>
</pre></div>
</div>
<p>In addition to emitters for the various forms (WKT, WKB, GML, KML, JSON, SVG), PostGIS also has consumers for four (WKT, WKB, GML, KML). Most applications use the WKT or WKB geometry creation functions, but the others work too. Here’s an example that consumes GML and output JSON:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">ST_AsGeoJSON</span><span class="p">(</span><span class="n">ST_GeomFromGML</span><span class="p">(</span><span class="s1">&#39;&lt;gml:Point&gt;&lt;gml:coordinates&gt;1,1&lt;/gml:coordinates&gt;&lt;/gml:Point&gt;&#39;</span><span class="p">));</span>
</pre></div>
</div>
<img alt="_images/represent-07.png" class="inline align-center" src="_images/represent-07.png" />
</div>
<div class="section" id="casting-from-text">
<h3>5.3.5. Casting from Text<a class="headerlink" href="#casting-from-text" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference internal" href="glossary.html#term-wkt"><span class="xref std std-term">WKT</span></a> strings we’ve see so far have been of type ‘text’ and we have been converting them to type ‘geometry’ using PostGIS functions like <strong class="command">ST_GeomFromText()</strong>.</p>
<p>PostgreSQL includes a short form syntax that allows data to be converted from one type to another, the casting syntax, <cite>oldata::newtype</cite>. So for example, this SQL converts a double into a text string.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="mi">0</span><span class="p">.</span><span class="mi">9</span><span class="p">::</span><span class="nb">text</span><span class="p">;</span>
</pre></div>
</div>
<p>Less trivially, this SQL converts a <a class="reference internal" href="glossary.html#term-wkt"><span class="xref std std-term">WKT</span></a> string into a geometry:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="s1">&#39;POINT(0 0)&#39;</span><span class="p">::</span><span class="n">geometry</span><span class="p">;</span>
</pre></div>
</div>
<p>One thing to note about using casting to create geometries: unless you specify the SRID, you will get a geometry with an unknown SRID. You can specify the SRID using the “extended” well-known text form, which includes an SRID block at the front:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="s1">&#39;SRID=4326;POINT(0 0)&#39;</span><span class="p">::</span><span class="n">geometry</span><span class="p">;</span>
</pre></div>
</div>
<p>It’s very common to use the casting notation when working with <a class="reference internal" href="glossary.html#term-wkt"><span class="xref std std-term">WKT</span></a>, as well as <cite>geometry</cite> and <cite>geography</cite> columns (see <a class="reference internal" href="geography.html#geography"><span class="std std-ref">Geography</span></a>).</p>
</div>
<div class="section" id="id8">
<h3>5.3.6. Function List<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://postgis.net/docs/ST_Area.html">ST_Area</a>: Returns the area of the surface if it is a polygon or multi-polygon. For “geometry” type area is in SRID units. For “geography” area is in square meters.</p>
<p><a class="reference external" href="http://postgis.net/docs/ST_AsText.html">ST_AsText</a>: Returns the Well-Known Text (WKT) representation of the geometry/geography without SRID metadata.</p>
<p><a class="reference external" href="http://postgis.net/docs/ST_AsBinary.html">ST_AsBinary</a>: Returns the Well-Known Binary (WKB) representation of the geometry/geography without SRID meta data.</p>
<p><a class="reference external" href="http://postgis.net/docs/ST_EndPoint.html">ST_EndPoint</a>: Returns the last point of a LINESTRING geometry as a POINT.</p>
<p><a class="reference external" href="http://postgis.net/docs/ST_AsEWKB.html">ST_AsEWKB</a>: Returns the Well-Known Binary (WKB) representation of the geometry with SRID meta data.</p>
<p><a class="reference external" href="http://postgis.net/docs/ST_AsEWKT.html">ST_AsEWKT</a>: Returns the Well-Known Text (WKT) representation of the geometry with SRID meta data.</p>
<p><a class="reference external" href="http://postgis.net/docs/ST_AsGeoJSON.html">ST_AsGeoJSON</a>: Returns the geometry as a GeoJSON element.</p>
<p><a class="reference external" href="http://postgis.net/docs/ST_AsGML.html">ST_AsGML</a>: Returns the geometry as a GML version 2 or 3 element.</p>
<p><a class="reference external" href="http://postgis.net/docs/ST_AsKML.html">ST_AsKML</a>: Returns the geometry as a KML element. Several variants. Default version=2, default precision=15.</p>
<p><a class="reference external" href="http://postgis.net/docs/ST_AsSVG.html">ST_AsSVG</a>: Returns a Geometry in SVG path data given a geometry or geography object.</p>
<p><a class="reference external" href="http://postgis.net/docs/ST_ExteriorRing.html">ST_ExteriorRing</a>: Returns a line string representing the exterior ring of the POLYGON geometry. Return NULL if the geometry is not a polygon.</p>
<p><a class="reference external" href="https://postgis.net/docs/ST_GeometryN.html">ST_GeometryN</a>: Returns the 1-based Nth geometry if the geometry is a GEOMETRYCOLLECTION, (MULTI)POINT, (MULTI)LINESTRING, (MULTI)CURVE, (MULTI)POLYGON or POLYHEDRALSURFACE. Otherwise, return NULL.</p>
<p><a class="reference external" href="http://postgis.net/docs/ST_GeomFromGML.html">ST_GeomFromGML</a>: Takes as input GML representation of geometry and outputs a PostGIS geometry object.</p>
<p><a class="reference external" href="http://postgis.net/docs/ST_GeomFromKML.html">ST_GeomFromKML</a>: Takes as input KML representation of geometry and outputs a PostGIS geometry object</p>
<p><a class="reference external" href="http://postgis.net/docs/ST_GeomFromText.html">ST_GeomFromText</a>: Returns a specified ST_Geometry value from Well-Known Text representation (WKT).</p>
<p><a class="reference external" href="http://postgis.net/docs/ST_GeomFromWKB.html">ST_GeomFromWKB</a>: Creates a geometry instance from a Well-Known Binary geometry representation (WKB) and optional SRID.</p>
<p><a class="reference external" href="http://postgis.net/docs/ST_GeometryType.html">ST_GeometryType</a>: Returns the geometry type of the ST_Geometry value.</p>
<p><a class="reference external" href="http://postgis.net/docs/ST_InteriorRingN.html">ST_InteriorRingN</a>: Returns the Nth interior linestring ring of the polygon geometry. Return NULL if the geometry is not a polygon or the given N is out of range. index starts at 1.</p>
<p><a class="reference external" href="http://postgis.net/docs/ST_Length.html">ST_Length</a>: Returns the 2d length of the geometry if it is a linestring or multilinestring. geometry are in units of spatial reference and geography are in meters (default spheroid)</p>
<p><a class="reference external" href="http://postgis.net/docs/ST_NDims.html">ST_NDims</a>: Returns coordinate dimension of the geometry. Values are: 2,3 or 4.</p>
<p><a class="reference external" href="http://postgis.net/docs/ST_NPoints.html">ST_NPoints</a>: Returns the number of points (vertexes) in a geometry.</p>
<p><a class="reference external" href="http://postgis.net/docs/ST_NRings.html">ST_NRings</a>: If the geometry is a polygon or multi-polygon returns the number of rings. Unlike :command: <cite>NumInteriorRings</cite>, it counts the outer rings as well.</p>
<p><a class="reference external" href="http://postgis.net/docs/ST_NumGeometries.html">ST_NumGeometries</a>: If geometry is a GEOMETRYCOLLECTION (or MULTI*) returns the number of geometries, for single geometries will return 1, otherwise return NULL.</p>
<p><a class="reference external" href="http://postgis.net/docs/ST_Perimeter.html">ST_Perimeter</a>: Returns the length measurement of the boundary of an ST_Surface or ST_MultiSurface value. (Polygon, Multipolygon)</p>
<p><a class="reference external" href="http://postgis.net/docs/ST_SRID.html">ST_SRID</a>: Returns the spatial reference identifier for the ST_Geometry as defined in spatial_ref_sys table.</p>
<p><a class="reference external" href="http://postgis.net/docs/ST_StartPoint.html">ST_StartPoint</a>: Returns the first point of a LINESTRING or CIRCULARLINESTRIING geometry as a POINT.</p>
<p><a class="reference external" href="http://postgis.net/docs/ST_X.html">ST_X</a>: Returns the X coordinate of the point, or NULL if not available. Input must be a point.</p>
<p><a class="reference external" href="http://postgis.net/docs/ST_Y.html">ST_Y</a>: Returns the Y coordinate of the point, or NULL if not available. Input must be a point.</p>
</div>
</div>
<div class="section" id="geometry-exercises">
<span id="geometries-exercises"></span><h2>5.4. Geometry Exercises<a class="headerlink" href="#geometry-exercises" title="Permalink to this headline">¶</a></h2>
<p>Here’s a reminder of all the functions we have seen so far. They should be useful for the exercises!</p>
<ul class="simple">
<li><strong class="command">sum(expression)</strong> aggregate to return a sum for a set of records</li>
<li><strong class="command">count(expression)</strong> aggregate to return the size of a set of records</li>
<li><strong class="command">ST_GeometryType(geometry)</strong> returns the type of the geometry</li>
<li><strong class="command">ST_NDims(geometry)</strong> returns the number of dimensions of the geometry</li>
<li><strong class="command">ST_SRID(geometry)</strong> returns the spatial reference identifier number of the geometry</li>
<li><strong class="command">ST_X(point)</strong> returns the X ordinate</li>
<li><strong class="command">ST_Y(point)</strong> returns the Y ordinate</li>
<li><strong class="command">ST_Length(linestring)</strong> returns the length of the linestring</li>
<li><strong class="command">ST_StartPoint(geometry)</strong> returns the first coordinate as a point</li>
<li><strong class="command">ST_EndPoint(geometry)</strong> returns the last coordinate as a point</li>
<li><strong class="command">ST_NPoints(geometry)</strong> returns the number of coordinates in the linestring</li>
<li><strong class="command">ST_Area(geometry)</strong> returns the area of the polygons</li>
<li><strong class="command">ST_NRings(geometry)</strong> returns the number of rings (usually 1, more if there are holes)</li>
<li><strong class="command">ST_ExteriorRing(polygon)</strong> returns the outer ring as a linestring</li>
<li><strong class="command">ST_InteriorRingN(polygon, integer)</strong> returns a specified interior ring as a linestring</li>
<li><strong class="command">ST_Perimeter(geometry)</strong> returns the length of all the rings</li>
<li><strong class="command">ST_NumGeometries(multi/geomcollection)</strong> returns the number of parts in the collection</li>
<li><strong class="command">ST_GeometryN(geometry, integer)</strong> returns the specified part of the collection</li>
<li><strong class="command">ST_GeomFromText(text)</strong> returns <code class="docutils literal notranslate"><span class="pre">geometry</span></code></li>
<li><strong class="command">ST_AsText(geometry)</strong> returns WKT <code class="docutils literal notranslate"><span class="pre">text</span></code></li>
<li><strong class="command">ST_AsEWKT(geometry)</strong> returns EWKT <code class="docutils literal notranslate"><span class="pre">text</span></code></li>
<li><strong class="command">ST_GeomFromWKB(bytea)</strong> returns <code class="docutils literal notranslate"><span class="pre">geometry</span></code></li>
<li><strong class="command">ST_AsBinary(geometry)</strong> returns WKB <code class="docutils literal notranslate"><span class="pre">bytea</span></code></li>
<li><strong class="command">ST_AsEWKB(geometry)</strong> returns EWKB <code class="docutils literal notranslate"><span class="pre">bytea</span></code></li>
<li><strong class="command">ST_GeomFromGML(text)</strong> returns <code class="docutils literal notranslate"><span class="pre">geometry</span></code></li>
<li><strong class="command">ST_AsGML(geometry)</strong> returns GML <code class="docutils literal notranslate"><span class="pre">text</span></code></li>
<li><strong class="command">ST_GeomFromKML(text)</strong> returns <code class="docutils literal notranslate"><span class="pre">geometry</span></code></li>
<li><strong class="command">ST_AsKML(geometry)</strong> returns KML <code class="docutils literal notranslate"><span class="pre">text</span></code></li>
<li><strong class="command">ST_AsGeoJSON(geometry)</strong> returns JSON <code class="docutils literal notranslate"><span class="pre">text</span></code></li>
<li><strong class="command">ST_AsSVG(geometry)</strong> returns SVG <code class="docutils literal notranslate"><span class="pre">text</span></code></li>
</ul>
<p>Also remember the tables we have available:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">nyc_census_blocks</span></code><ul>
<li>blkid, popn_total, boroname, geom</li>
</ul>
</li>
<li><code class="docutils literal notranslate"><span class="pre">nyc_streets</span></code><ul>
<li>name, type, geom</li>
</ul>
</li>
<li><code class="docutils literal notranslate"><span class="pre">nyc_subway_stations</span></code><ul>
<li>name, geom</li>
</ul>
</li>
<li><code class="docutils literal notranslate"><span class="pre">nyc_neighborhoods</span></code><ul>
<li>name, boroname, geom</li>
</ul>
</li>
</ul>
<div class="section" id="exercises">
<h3>5.4.1. Exercises<a class="headerlink" href="#exercises" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p class="first"><strong>“What is the area of the ‘West Village’ neighborhood?”</strong></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">ST_Area</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
  <span class="k">FROM</span> <span class="n">nyc_neighborhoods</span>
  <span class="k">WHERE</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;West Village&#39;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">1044614.5296486</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The area is given in square meters. To get an area in hectares, divide by 10000. To get an area in acres, divide by 4047.</p>
</div>
</li>
<li><p class="first"><strong>“What is the area of Manhattan in acres?”</strong> (Hint: both <code class="docutils literal notranslate"><span class="pre">nyc_census_blocks</span></code> and <code class="docutils literal notranslate"><span class="pre">nyc_neighborhoods</span></code> have a <code class="docutils literal notranslate"><span class="pre">boroname</span></code> in them.)</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="k">Sum</span><span class="p">(</span><span class="n">ST_Area</span><span class="p">(</span><span class="n">geom</span><span class="p">))</span> <span class="o">/</span> <span class="mi">4047</span>
  <span class="k">FROM</span> <span class="n">nyc_neighborhoods</span>
  <span class="k">WHERE</span> <span class="n">boroname</span> <span class="o">=</span> <span class="s1">&#39;Manhattan&#39;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">13965.3201224118</span>
</pre></div>
</div>
<p>or…</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="k">Sum</span><span class="p">(</span><span class="n">ST_Area</span><span class="p">(</span><span class="n">geom</span><span class="p">))</span> <span class="o">/</span> <span class="mi">4047</span>
  <span class="k">FROM</span> <span class="n">nyc_census_blocks</span>
  <span class="k">WHERE</span> <span class="n">boroname</span> <span class="o">=</span> <span class="s1">&#39;Manhattan&#39;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">14601.3987215548</span>
</pre></div>
</div>
</li>
<li><p class="first"><strong>“How many census blocks in New York City have a hole in them?”</strong></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="k">Count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
  <span class="k">FROM</span> <span class="n">nyc_census_blocks</span>
  <span class="k">WHERE</span> <span class="n">ST_NumInteriorRings</span><span class="p">(</span><span class="n">ST_GeometryN</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The ST_NRings() functions might be tempting, but it also counts the exterior rings of multi-polygons as well as interior rings.  In order to run ST_NumInteriorRings() we need to convert the MultiPolygon geometries of the blocks into simple polygons, so we extract the first polygon from each collection using ST_GeometryN(). Yuck!</p>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">43</span>
</pre></div>
</div>
</li>
<li><p class="first"><strong>“What is the total length of streets (in kilometers) in New York City?”</strong> (Hint: The units of measurement of the spatial data are meters, there are 1000 meters in a kilometer.)</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="k">Sum</span><span class="p">(</span><span class="n">ST_Length</span><span class="p">(</span><span class="n">geom</span><span class="p">))</span> <span class="o">/</span> <span class="mi">1000</span>
  <span class="k">FROM</span> <span class="n">nyc_streets</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">10418.9047172</span>
</pre></div>
</div>
</li>
<li><p class="first"><strong>“How long is ‘Columbus Cir’ (Columbus Circle)?</strong></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">ST_Length</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
  <span class="k">FROM</span> <span class="n">nyc_streets</span>
  <span class="k">WHERE</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Columbus Cir&#39;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">308.34199</span>
</pre></div>
</div>
</li>
<li><p class="first"><strong>“What is the JSON representation of the boundary of the ‘West Village’?”</strong></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">ST_AsGeoJSON</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
  <span class="k">FROM</span> <span class="n">nyc_neighborhoods</span>
  <span class="k">WHERE</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;West Village&#39;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;MultiPolygon&quot;</span><span class="p">,</span><span class="s2">&quot;coordinates&quot;</span><span class="p">:</span>
 <span class="p">[[[[</span><span class="mf">583263.2776595836</span><span class="p">,</span><span class="mf">4509242.6260239873</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">583276.81990686338</span><span class="p">,</span><span class="mf">4509378.825446927</span><span class="p">],</span> <span class="o">...</span>
    <span class="p">[</span><span class="mf">583263.2776595836</span><span class="p">,</span><span class="mf">4509242.6260239873</span><span class="p">]]]]}</span>
</pre></div>
</div>
<p>The geometry type is “MultiPolygon”, interesting!</p>
</li>
<li><p class="first"><strong>“How many polygons are in the ‘West Village’ multipolygon?”</strong></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">ST_NumGeometries</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
  <span class="k">FROM</span> <span class="n">nyc_neighborhoods</span>
  <span class="k">WHERE</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;West Village&#39;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It is not uncommon to find single-element MultiPolygons in spatial tables. Using MultiPolygons allows a table with only one geometry type to store both single- and multi-geometries without using mixed types.</p>
</div>
</li>
<li><p class="first"><strong>“What is the length of streets in New York City, summarized by type?”</strong></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="k">type</span><span class="p">,</span> <span class="k">Sum</span><span class="p">(</span><span class="n">ST_Length</span><span class="p">(</span><span class="n">geom</span><span class="p">))</span> <span class="k">AS</span> <span class="k">length</span>
<span class="k">FROM</span> <span class="n">nyc_streets</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="k">type</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="k">length</span> <span class="k">DESC</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                       <span class="nb">type</span>                       <span class="o">|</span>      <span class="n">length</span>
<span class="o">--------------------------------------------------+------------------</span>
 <span class="n">residential</span>                                      <span class="o">|</span> <span class="mf">8629870.33786606</span>
 <span class="n">motorway</span>                                         <span class="o">|</span> <span class="mf">403622.478126363</span>
 <span class="n">tertiary</span>                                         <span class="o">|</span> <span class="mf">360394.879051303</span>
 <span class="n">motorway_link</span>                                    <span class="o">|</span> <span class="mf">294261.419479668</span>
 <span class="n">secondary</span>                                        <span class="o">|</span> <span class="mf">276264.303897926</span>
 <span class="n">unclassified</span>                                     <span class="o">|</span> <span class="mf">166936.371604458</span>
 <span class="n">primary</span>                                          <span class="o">|</span> <span class="mf">135034.233017947</span>
 <span class="n">footway</span>                                          <span class="o">|</span> <span class="mf">71798.4878378096</span>
 <span class="n">service</span>                                          <span class="o">|</span>  <span class="mf">28337.635038596</span>
 <span class="n">trunk</span>                                            <span class="o">|</span> <span class="mf">20353.5819826076</span>
 <span class="n">cycleway</span>                                         <span class="o">|</span> <span class="mf">8863.75144825929</span>
 <span class="n">pedestrian</span>                                       <span class="o">|</span> <span class="mf">4867.05032825026</span>
 <span class="n">construction</span>                                     <span class="o">|</span> <span class="mf">4803.08162103562</span>
 <span class="n">residential</span><span class="p">;</span> <span class="n">motorway_link</span>                       <span class="o">|</span> <span class="mf">3661.57506293745</span>
 <span class="n">trunk_link</span>                                       <span class="o">|</span> <span class="mf">3202.18981240201</span>
 <span class="n">primary_link</span>                                     <span class="o">|</span> <span class="mf">2492.57457083536</span>
 <span class="n">living_street</span>                                    <span class="o">|</span> <span class="mf">1894.63905457332</span>
 <span class="n">primary</span><span class="p">;</span> <span class="n">residential</span><span class="p">;</span> <span class="n">motorway_link</span><span class="p">;</span> <span class="n">residential</span> <span class="o">|</span> <span class="mf">1367.76576941335</span>
 <span class="n">undefined</span>                                        <span class="o">|</span>  <span class="mf">380.53861910346</span>
 <span class="n">steps</span>                                            <span class="o">|</span> <span class="mf">282.745221342127</span>
 <span class="n">motorway_link</span><span class="p">;</span> <span class="n">residential</span>                       <span class="o">|</span>  <span class="mf">215.07778911517</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <code class="docutils literal notranslate"><span class="pre">ORDER</span> <span class="pre">BY</span> <span class="pre">length</span> <span class="pre">DESC</span></code> clause sorts the result by length in descending order. The result is that most prevalent types are first in the list.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="section" id="spatial-relationships">
<span id="id9"></span><h2>5.5. Spatial Relationships<a class="headerlink" href="#spatial-relationships" title="Permalink to this headline">¶</a></h2>
<p>So far we have only used spatial functions that measure (<strong class="command">ST_Area</strong>, <strong class="command">ST_Length</strong>), serialize (<strong class="command">ST_AsGML</strong>), and deserialize (<strong class="command">ST_GeomFromText</strong>) geometries. What these functions have in common is that they only work on one geometry at a time.</p>
<p>Spatial databases are powerful because they not only store geometry, they also have the ability to compare <em>relationships between geometries</em>.</p>
<p>Questions like “Which are the closest bike racks to a park?” or “Where are the intersections of subway lines and streets?” can only be answered by comparing geometries representing the bike racks, streets, and subway lines.</p>
<p>The OGC standard defines the following set of methods to compare geometries.</p>
<div class="section" id="st-equals">
<h3>5.5.1. ST_Equals<a class="headerlink" href="#st-equals" title="Permalink to this headline">¶</a></h3>
<p><strong class="command">ST_Equals(geometry A, geometry B)</strong> tests the spatial equality of two geometries.</p>
<div class="figure align-center">
<img alt="_images/st_equals.png" src="_images/st_equals.png" />
</div>
<p>ST_Equals returns TRUE if two geometries of the same type have identical x,y coordinate values, i.e. if the second shape is equal (identical) to the first shape.</p>
<p>First, let’s retrieve a representation of a point from our <code class="docutils literal notranslate"><span class="pre">nyc_subway_stations</span></code> table. We’ll take just the entry for ‘Broad St’.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">name</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">ST_AsText</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">nyc_subway_stations</span>
<span class="k">WHERE</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Broad St&#39;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   <span class="n">name</span>   <span class="o">|</span>                      <span class="n">geom</span>                          <span class="o">|</span>      <span class="n">st_astext</span>
<span class="o">----------+----------------------------------------------------+-----------------------</span>
 <span class="n">Broad</span> <span class="n">St</span> <span class="o">|</span> <span class="mi">0101000020266900000</span><span class="n">EEBD4CF27CF2141BC17D69516315141</span> <span class="o">|</span> <span class="n">POINT</span><span class="p">(</span><span class="mi">583571</span> <span class="mi">4506714</span><span class="p">)</span>
</pre></div>
</div>
<p>Then, plug the geometry representation back into an <strong class="command">ST_Equals</strong> test:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">name</span>
<span class="k">FROM</span> <span class="n">nyc_subway_stations</span>
<span class="k">WHERE</span> <span class="n">ST_Equals</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="s1">&#39;0101000020266900000EEBD4CF27CF2141BC17D69516315141&#39;</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Broad</span> <span class="n">St</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The representation of the point was not very human readable (<code class="docutils literal notranslate"><span class="pre">0101000020266900000EEBD4CF27CF2141BC17D69516315141</span></code>) but it was an exact representation of the coordinate values. For a test like equality, using the exact coordinates is necessary.</p>
</div>
</div>
<div class="section" id="st-intersects-st-disjoint-st-crosses-and-st-overlaps">
<h3>5.5.2. ST_Intersects, ST_Disjoint, ST_Crosses and ST_Overlaps<a class="headerlink" href="#st-intersects-st-disjoint-st-crosses-and-st-overlaps" title="Permalink to this headline">¶</a></h3>
<p><strong class="command">ST_Intersects</strong>, <strong class="command">ST_Crosses</strong>, and <strong class="command">ST_Overlaps</strong> test whether the interiors of the geometries intersect.</p>
<div class="figure align-center">
<img alt="_images/st_intersects.png" src="_images/st_intersects.png" />
</div>
<p><strong class="command">ST_Intersects(geometry A, geometry B)</strong> returns t (TRUE) if the two shapes have any space in common, i.e., if their boundaries or interiors intersect.</p>
<div class="figure align-center">
<img alt="_images/st_disjoint.png" src="_images/st_disjoint.png" />
</div>
<p>The opposite of ST_Intersects is <strong class="command">ST_Disjoint(geometry A , geometry B)</strong>. If two geometries are disjoint, they do not intersect, and vice-versa. In fact, it is often more efficient to test “not intersects” than to test “disjoint” because the intersects tests can be spatially indexed, while the disjoint test cannot.</p>
<div class="figure align-center">
<img alt="_images/st_crosses.png" src="_images/st_crosses.png" />
</div>
<p>For multipoint/polygon, multipoint/linestring, linestring/linestring, linestring/polygon, and linestring/multipolygon comparisons, <strong class="command">ST_Crosses(geometry A, geometry B)</strong> returns t (TRUE) if the intersection results in a geometry whose dimension is one less than the maximum dimension of the two source geometries and the intersection set is interior to both source geometries.</p>
<div class="figure align-center">
<img alt="_images/st_overlaps.png" src="_images/st_overlaps.png" />
</div>
<p><strong class="command">ST_Overlaps(geometry A, geometry B)</strong> compares two geometries of the same dimension and returns TRUE if their intersection set results in a geometry different from both but of the same dimension.</p>
<p>Let’s take our Broad Street subway station and determine its neighborhood using the <strong class="command">ST_Intersects</strong> function:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">name</span><span class="p">,</span> <span class="n">ST_AsText</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">nyc_subway_stations</span>
<span class="k">WHERE</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Broad St&#39;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">POINT</span><span class="p">(</span><span class="mi">583571</span> <span class="mi">4506714</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">name</span><span class="p">,</span> <span class="n">boroname</span>
<span class="k">FROM</span> <span class="n">nyc_neighborhoods</span>
<span class="k">WHERE</span> <span class="n">ST_Intersects</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">ST_GeomFromText</span><span class="p">(</span><span class="s1">&#39;POINT(583571 4506714)&#39;</span><span class="p">,</span><span class="mi">26918</span><span class="p">));</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>        <span class="n">name</span>        <span class="o">|</span> <span class="n">boroname</span>
<span class="o">--------------------+-----------</span>
 <span class="n">Financial</span> <span class="n">District</span> <span class="o">|</span> <span class="n">Manhattan</span>
</pre></div>
</div>
</div>
<div class="section" id="st-touches">
<h3>5.5.3. ST_Touches<a class="headerlink" href="#st-touches" title="Permalink to this headline">¶</a></h3>
<p><strong class="command">ST_Touches</strong> tests whether two geometries touch at their boundaries, but do not intersect in their interiors</p>
<div class="figure align-center">
<img alt="_images/st_touches.png" src="_images/st_touches.png" />
</div>
<p><strong class="command">ST_Touches(geometry A, geometry B)</strong> returns TRUE if either of the geometries’ boundaries intersect or if only one of the geometry’s interiors intersects the other’s boundary.</p>
</div>
<div class="section" id="st-within-and-st-contains">
<h3>5.5.4. ST_Within and ST_Contains<a class="headerlink" href="#st-within-and-st-contains" title="Permalink to this headline">¶</a></h3>
<p><strong class="command">ST_Within</strong> and <strong class="command">ST_Contains</strong> test whether one geometry is fully within the other.</p>
<div class="figure align-center">
<img alt="_images/st_within.png" src="_images/st_within.png" />
</div>
<p><strong class="command">ST_Within(geometry A , geometry B)</strong> returns TRUE if the first geometry is completely within the second geometry. ST_Within tests for the exact opposite result of ST_Contains.</p>
<p><strong class="command">ST_Contains(geometry A, geometry B)</strong> returns TRUE if the second geometry is completely contained by the first geometry.</p>
</div>
<div class="section" id="st-distance-and-st-dwithin">
<h3>5.5.5. ST_Distance and ST_DWithin<a class="headerlink" href="#st-distance-and-st-dwithin" title="Permalink to this headline">¶</a></h3>
<p>An extremely common GIS question is “find all the stuff within distance X of this other stuff”.</p>
<p>The <strong class="command">ST_Distance(geometry A, geometry B)</strong> calculates the <em>shortest</em> distance between two geometries and returns it as a float. This is useful for actually reporting back the distance between objects.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">ST_Distance</span><span class="p">(</span>
  <span class="n">ST_GeometryFromText</span><span class="p">(</span><span class="s1">&#39;POINT(0 5)&#39;</span><span class="p">),</span>
  <span class="n">ST_GeometryFromText</span><span class="p">(</span><span class="s1">&#39;LINESTRING(-2 2, 2 2)&#39;</span><span class="p">));</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">3</span>
</pre></div>
</div>
<p>For testing whether two objects are within a distance of one another, the <strong class="command">ST_DWithin</strong> function provides an index-accelerated true/false test. This is useful for questions like “how many trees are within a 500 meter buffer of the road?”. You don’t have to calculate an actual buffer, you just have to test the distance relationship.</p>
<div class="figure align-center">
<img alt="_images/st_dwithin.png" src="_images/st_dwithin.png" />
</div>
<p>Using our Broad Street subway station again, we can find the streets nearby (within 10 meters of) the subway stop:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">name</span>
<span class="k">FROM</span> <span class="n">nyc_streets</span>
<span class="k">WHERE</span> <span class="n">ST_DWithin</span><span class="p">(</span>
        <span class="n">geom</span><span class="p">,</span>
        <span class="n">ST_GeomFromText</span><span class="p">(</span><span class="s1">&#39;POINT(583571 4506714)&#39;</span><span class="p">,</span><span class="mi">26918</span><span class="p">),</span>
        <span class="mi">10</span>
      <span class="p">);</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>     <span class="n">name</span>
<span class="o">--------------</span>
   <span class="n">Wall</span> <span class="n">St</span>
   <span class="n">Broad</span> <span class="n">St</span>
   <span class="n">Nassau</span> <span class="n">St</span>
</pre></div>
</div>
<p>And we can verify the answer on a map. The Broad St station is actually at the intersection of Wall, Broad and Nassau Streets.</p>
<img alt="_images/broad_st.jpg" src="_images/broad_st.jpg" />
</div>
<div class="section" id="id10">
<h3>5.5.6. Function List<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://postgis.net/docs/manual-2.1/ST_Contains.html">ST_Contains(geometry A, geometry B)</a>: Returns true if and only if no points of B lie in the exterior of A, and at least one point of the interior of B lies in the interior of A.</p>
<p><a class="reference external" href="http://postgis.net/docs/manual-2.1/ST_Crosses.html">ST_Crosses(geometry A, geometry B)</a>: Returns TRUE if the supplied geometries have some, but not all, interior points in common.</p>
<p><a class="reference external" href="http://postgis.net/docs/manual-2.1/ST_Disjoint.html">ST_Disjoint(geometry A , geometry B)</a>: Returns TRUE if the Geometries do not “spatially intersect” - if they do not share any space together.</p>
<p><a class="reference external" href="http://postgis.net/docs/manual-2.1/ST_Distance.html">ST_Distance(geometry A, geometry B)</a>: Returns the 2-dimensional cartesian minimum distance (based on spatial ref) between two geometries in projected units.</p>
<p><a class="reference external" href="http://postgis.net/docs/manual-2.1/ST_DWithin.html">ST_DWithin(geometry A, geometry B, radius)</a>: Returns true if the geometries are within the specified distance (radius) of one another.</p>
<p><a class="reference external" href="http://postgis.net/docs/manual-2.1/ST_Equals.html">ST_Equals(geometry A, geometry B)</a>: Returns true if the given geometries represent the same geometry. Directionality is ignored.</p>
<p><a class="reference external" href="http://postgis.net/docs/manual-2.1/ST_Intersects.html">ST_Intersects(geometry A, geometry B)</a>: Returns TRUE if the Geometries/Geography “spatially intersect” - (share any portion of space) and FALSE if they don’t (they are Disjoint).</p>
<p><a class="reference external" href="http://postgis.net/docs/manual-2.1/ST_Overlaps.html">ST_Overlaps(geometry A, geometry B)</a>: Returns TRUE if the Geometries share space, are of the same dimension, but are not completely contained by each other.</p>
<p><a class="reference external" href="http://postgis.net/docs/manual-2.1/ST_Touches.html">ST_Touches(geometry A, geometry B)</a>: Returns TRUE if the geometries have at least one point in common, but their interiors do not intersect.</p>
<p><a class="reference external" href="http://postgis.net/docs/manual-2.1/ST_Within.html">ST_Within(geometry A , geometry B)</a>: Returns true if the geometry A is completely inside geometry B</p>
</div>
</div>
<div class="section" id="spatial-relationships-exercises">
<span id="id11"></span><h2>5.6. Spatial Relationships Exercises<a class="headerlink" href="#spatial-relationships-exercises" title="Permalink to this headline">¶</a></h2>
<p>Here’s a reminder of the functions we saw in the last section. They should be useful for the exercises!</p>
<ul class="simple">
<li><strong class="command">sum(expression)</strong> aggregate to return a sum for a set of records</li>
<li><strong class="command">count(expression)</strong> aggregate to return the size of a set of records</li>
<li><strong class="command">ST_Contains(geometry A, geometry B)</strong> returns true if geometry A contains geometry B</li>
<li><strong class="command">ST_Crosses(geometry A, geometry B)</strong> returns true if geometry A crosses geometry B</li>
<li><strong class="command">ST_Disjoint(geometry A , geometry B)</strong> returns true if the geometries do not “spatially intersect”</li>
<li><strong class="command">ST_Distance(geometry A, geometry B)</strong> returns the minimum distance between geometry A and geometry B</li>
<li><strong class="command">ST_DWithin(geometry A, geometry B, radius)</strong> returns true if geometry A is radius distance or less from geometry B</li>
<li><strong class="command">ST_Equals(geometry A, geometry B)</strong> returns true if geometry A is the same as geometry B</li>
<li><strong class="command">ST_Intersects(geometry A, geometry B)</strong> returns true if geometry A intersects geometry B</li>
<li><strong class="command">ST_Overlaps(geometry A, geometry B)</strong> returns true if geometry A and geometry B share space, but are not completely contained by each other.</li>
<li><strong class="command">ST_Touches(geometry A, geometry B)</strong> returns true if the boundary of geometry A touches geometry B</li>
<li><strong class="command">ST_Within(geometry A, geometry B)</strong> returns true if geometry A is within geometry B</li>
</ul>
<p>Also remember the tables we have available:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">nyc_census_blocks</span></code><ul>
<li>blkid, popn_total, boroname, geom</li>
</ul>
</li>
<li><code class="docutils literal notranslate"><span class="pre">nyc_streets</span></code><ul>
<li>name, type, geom</li>
</ul>
</li>
<li><code class="docutils literal notranslate"><span class="pre">nyc_subway_stations</span></code><ul>
<li>name, geom</li>
</ul>
</li>
<li><code class="docutils literal notranslate"><span class="pre">nyc_neighborhoods</span></code><ul>
<li>name, boroname, geom</li>
</ul>
</li>
</ul>
<div class="section" id="id12">
<h3>5.6.1. Exercises<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p class="first"><strong>“What is the geometry value for the street named ‘Atlantic Commons’?”</strong></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">ST_AsText</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
  <span class="k">FROM</span> <span class="n">nyc_streets</span>
  <span class="k">WHERE</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Atlantic Commons&#39;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MULTILINESTRING</span><span class="p">((</span><span class="mf">586781.701577724</span> <span class="mf">4504202.15314339</span><span class="p">,</span><span class="mf">586863.51964484</span> <span class="mf">4504215.9881701</span><span class="p">))</span>
</pre></div>
</div>
</li>
<li><p class="first"><strong>“What neighborhood and borough is Atlantic Commons in?”</strong></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">name</span><span class="p">,</span> <span class="n">boroname</span>
<span class="k">FROM</span> <span class="n">nyc_neighborhoods</span>
<span class="k">WHERE</span> <span class="n">ST_Intersects</span><span class="p">(</span>
  <span class="n">geom</span><span class="p">,</span>
  <span class="n">ST_GeomFromText</span><span class="p">(</span><span class="s1">&#39;LINESTRING(586782 4504202,586864 4504216)&#39;</span><span class="p">,</span> <span class="mi">26918</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">name</span>    <span class="o">|</span> <span class="n">boroname</span>
<span class="o">------------+----------</span>
 <span class="n">Fort</span> <span class="n">Green</span> <span class="o">|</span> <span class="n">Brooklyn</span>
</pre></div>
</div>
</li>
<li><p class="first"><strong>“What streets does Atlantic Commons join with?”</strong></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">name</span>
<span class="k">FROM</span> <span class="n">nyc_streets</span>
<span class="k">WHERE</span> <span class="n">ST_DWithin</span><span class="p">(</span>
  <span class="n">geom</span><span class="p">,</span>
  <span class="n">ST_GeomFromText</span><span class="p">(</span><span class="s1">&#39;LINESTRING(586782 4504202,586864 4504216)&#39;</span><span class="p">,</span> <span class="mi">26918</span><span class="p">),</span>
  <span class="mi">0</span><span class="p">.</span><span class="mi">1</span>
<span class="p">);</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>     <span class="n">name</span>
<span class="o">------------------</span>
 <span class="n">Cumberland</span> <span class="n">St</span>
 <span class="n">Atlantic</span> <span class="n">Commons</span>
</pre></div>
</div>
<img alt="_images/atlantic_commons.jpg" src="_images/atlantic_commons.jpg" />
</li>
<li><p class="first"><strong>“Approximately how many people live on (within 50 meters of) Atlantic Commons?”</strong></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="k">Sum</span><span class="p">(</span><span class="n">popn_total</span><span class="p">)</span>
  <span class="k">FROM</span> <span class="n">nyc_census_blocks</span>
  <span class="k">WHERE</span> <span class="n">ST_DWithin</span><span class="p">(</span>
   <span class="n">geom</span><span class="p">,</span>
   <span class="n">ST_GeomFromText</span><span class="p">(</span><span class="s1">&#39;LINESTRING(586782 4504202,586864 4504216)&#39;</span><span class="p">,</span> <span class="mi">26918</span><span class="p">),</span>
   <span class="mi">50</span>
  <span class="p">);</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">1438</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<div class="section" id="spatial-joins">
<span id="joins"></span><h2>5.7. Spatial Joins<a class="headerlink" href="#spatial-joins" title="Permalink to this headline">¶</a></h2>
<p>Spatial joins are the bread-and-butter of spatial databases.  They allow you to combine information from different tables by using spatial relationships as the join key.  Much of what we think of as “standard GIS analysis” can be expressed as spatial joins.</p>
<p>To review how joins work, here’s a step-by-step look at joining the neighborhoods and subway stations tables and then subsequently adding a simple where clause.  Joining two small tables effectively multiplies the number of rows into a much larger dataset with all possible combinations of the two tables.  Then we use a where clause (or two) to narrow our focus.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">--129 neighborhoods</span>
<span class="k">SELECT</span> <span class="n">name</span><span class="p">,</span> <span class="n">boroname</span> <span class="k">FROM</span> <span class="n">nyc_neighborhoods</span>

<span class="c1">--491 subway stations</span>
<span class="k">SELECT</span> <span class="n">name</span><span class="p">,</span> <span class="n">borough</span> <span class="k">FROM</span> <span class="n">nyc_subway_stations</span>

<span class="c1">--join produces 63339 rows (129 * 491)</span>
<span class="k">SELECT</span> <span class="n">n</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">n</span><span class="p">.</span><span class="n">boroname</span><span class="p">,</span>
       <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">borough</span>
  <span class="k">FROM</span> <span class="n">nyc_neighborhoods</span> <span class="n">n</span><span class="p">,</span> <span class="n">nyc_subway_stations</span> <span class="n">s</span>

<span class="c1">--a simple where clause narrows this to 11058 rows</span>
<span class="k">SELECT</span> <span class="n">n</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">n</span><span class="p">.</span><span class="n">boroname</span><span class="p">,</span>
       <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">borough</span>
  <span class="k">FROM</span> <span class="n">nyc_neighborhoods</span> <span class="n">n</span><span class="p">,</span> <span class="n">nyc_subway_stations</span> <span class="n">s</span>
 <span class="k">WHERE</span> <span class="n">n</span><span class="p">.</span><span class="n">boroname</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">borough</span>
</pre></div>
</div>
<p>In the previous section, we explored spatial relationships using a two-step process: first we extracted a subway station point for ‘Broad St’; then, we used that point to ask further questions such as “what neighborhood is the ‘Broad St’ station in?”</p>
<p>Using a spatial join, we can answer the question in one step, retrieving information about the subway station and the neighborhood that contains it:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span>
  <span class="n">subways</span><span class="p">.</span><span class="n">name</span> <span class="k">AS</span> <span class="n">subway_name</span><span class="p">,</span>
  <span class="n">neighborhoods</span><span class="p">.</span><span class="n">name</span> <span class="k">AS</span> <span class="n">neighborhood_name</span><span class="p">,</span>
  <span class="n">neighborhoods</span><span class="p">.</span><span class="n">boroname</span> <span class="k">AS</span> <span class="n">borough</span>
<span class="k">FROM</span> <span class="n">nyc_neighborhoods</span> <span class="k">AS</span> <span class="n">neighborhoods</span>
<span class="k">JOIN</span> <span class="n">nyc_subway_stations</span> <span class="k">AS</span> <span class="n">subways</span>
<span class="k">ON</span> <span class="n">ST_Contains</span><span class="p">(</span><span class="n">neighborhoods</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">subways</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span>
<span class="k">WHERE</span> <span class="n">subways</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Broad St&#39;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">subway_name</span> <span class="o">|</span> <span class="n">neighborhood_name</span>  <span class="o">|</span>  <span class="n">borough</span>
<span class="o">-------------+--------------------+-----------</span>
 <span class="n">Broad</span> <span class="n">St</span>    <span class="o">|</span> <span class="n">Financial</span> <span class="n">District</span> <span class="o">|</span> <span class="n">Manhattan</span>
</pre></div>
</div>
<p>We could have joined every subway station to its containing neighborhood, but in this case we wanted information about just one.  Any function that provides a true/false relationship between two tables can be used to drive a spatial join, but the most commonly used ones are: <strong class="command">ST_Intersects</strong>, <strong class="command">ST_Contains</strong>, and <strong class="command">ST_DWithin</strong>.</p>
<div class="section" id="join-and-summarize">
<h3>5.7.1. Join and Summarize<a class="headerlink" href="#join-and-summarize" title="Permalink to this headline">¶</a></h3>
<p>The combination of a <code class="docutils literal notranslate"><span class="pre">JOIN</span></code> with a <code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code> provides the kind of analysis that is usually done in a GIS system.</p>
<p>For example: <strong>“What is the population and racial make-up of the neighborhoods of Manhattan?”</strong> Here we have a question that combines information from about population from the census with the boundaries of neighborhoods, with a restriction to just one borough of Manhattan.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span>
  <span class="n">neighborhoods</span><span class="p">.</span><span class="n">name</span> <span class="k">AS</span> <span class="n">neighborhood_name</span><span class="p">,</span>
  <span class="k">Sum</span><span class="p">(</span><span class="n">census</span><span class="p">.</span><span class="n">popn_total</span><span class="p">)</span> <span class="k">AS</span> <span class="n">population</span><span class="p">,</span>
  <span class="mi">100</span><span class="p">.</span><span class="mi">0</span> <span class="o">*</span> <span class="k">Sum</span><span class="p">(</span><span class="n">census</span><span class="p">.</span><span class="n">popn_white</span><span class="p">)</span> <span class="o">/</span> <span class="k">Sum</span><span class="p">(</span><span class="n">census</span><span class="p">.</span><span class="n">popn_total</span><span class="p">)</span> <span class="k">AS</span> <span class="n">white_pct</span><span class="p">,</span>
  <span class="mi">100</span><span class="p">.</span><span class="mi">0</span> <span class="o">*</span> <span class="k">Sum</span><span class="p">(</span><span class="n">census</span><span class="p">.</span><span class="n">popn_black</span><span class="p">)</span> <span class="o">/</span> <span class="k">Sum</span><span class="p">(</span><span class="n">census</span><span class="p">.</span><span class="n">popn_total</span><span class="p">)</span> <span class="k">AS</span> <span class="n">black_pct</span>
<span class="k">FROM</span> <span class="n">nyc_neighborhoods</span> <span class="k">AS</span> <span class="n">neighborhoods</span>
<span class="k">JOIN</span> <span class="n">nyc_census_blocks</span> <span class="k">AS</span> <span class="n">census</span>
<span class="k">ON</span> <span class="n">ST_Intersects</span><span class="p">(</span><span class="n">neighborhoods</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">census</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span>
<span class="k">WHERE</span> <span class="n">neighborhoods</span><span class="p">.</span><span class="n">boroname</span> <span class="o">=</span> <span class="s1">&#39;Manhattan&#39;</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">neighborhoods</span><span class="p">.</span><span class="n">name</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">white_pct</span> <span class="k">DESC</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">neighborhood_name</span>  <span class="o">|</span> <span class="n">population</span> <span class="o">|</span> <span class="n">white_pct</span> <span class="o">|</span> <span class="n">black_pct</span>
<span class="o">---------------------+------------+-----------+-----------</span>
 <span class="n">Carnegie</span> <span class="n">Hill</span>       <span class="o">|</span>      <span class="mi">18763</span> <span class="o">|</span>      <span class="mf">90.1</span> <span class="o">|</span>       <span class="mf">1.4</span>
 <span class="n">North</span> <span class="n">Sutton</span> <span class="n">Area</span>   <span class="o">|</span>      <span class="mi">22460</span> <span class="o">|</span>      <span class="mf">87.6</span> <span class="o">|</span>       <span class="mf">1.6</span>
 <span class="n">West</span> <span class="n">Village</span>        <span class="o">|</span>      <span class="mi">26718</span> <span class="o">|</span>      <span class="mf">87.6</span> <span class="o">|</span>       <span class="mf">2.2</span>
 <span class="n">Upper</span> <span class="n">East</span> <span class="n">Side</span>     <span class="o">|</span>     <span class="mi">203741</span> <span class="o">|</span>      <span class="mf">85.0</span> <span class="o">|</span>       <span class="mf">2.7</span>
 <span class="n">Soho</span>                <span class="o">|</span>      <span class="mi">15436</span> <span class="o">|</span>      <span class="mf">84.6</span> <span class="o">|</span>       <span class="mf">2.2</span>
 <span class="n">Greenwich</span> <span class="n">Village</span>   <span class="o">|</span>      <span class="mi">57224</span> <span class="o">|</span>      <span class="mf">82.0</span> <span class="o">|</span>       <span class="mf">2.4</span>
 <span class="n">Central</span> <span class="n">Park</span>        <span class="o">|</span>      <span class="mi">46600</span> <span class="o">|</span>      <span class="mf">79.5</span> <span class="o">|</span>       <span class="mf">8.0</span>
 <span class="n">Tribeca</span>             <span class="o">|</span>      <span class="mi">20908</span> <span class="o">|</span>      <span class="mf">79.1</span> <span class="o">|</span>       <span class="mf">3.5</span>
 <span class="n">Gramercy</span>            <span class="o">|</span>     <span class="mi">104876</span> <span class="o">|</span>      <span class="mf">75.5</span> <span class="o">|</span>       <span class="mf">4.7</span>
 <span class="n">Murray</span> <span class="n">Hill</span>         <span class="o">|</span>      <span class="mi">29655</span> <span class="o">|</span>      <span class="mf">75.0</span> <span class="o">|</span>       <span class="mf">2.5</span>
 <span class="n">Chelsea</span>             <span class="o">|</span>      <span class="mi">61340</span> <span class="o">|</span>      <span class="mf">74.8</span> <span class="o">|</span>       <span class="mf">6.4</span>
 <span class="n">Upper</span> <span class="n">West</span> <span class="n">Side</span>     <span class="o">|</span>     <span class="mi">214761</span> <span class="o">|</span>      <span class="mf">74.6</span> <span class="o">|</span>       <span class="mf">9.2</span>
 <span class="n">Midtown</span>             <span class="o">|</span>      <span class="mi">76840</span> <span class="o">|</span>      <span class="mf">72.6</span> <span class="o">|</span>       <span class="mf">5.2</span>
 <span class="n">Battery</span> <span class="n">Park</span>        <span class="o">|</span>      <span class="mi">17153</span> <span class="o">|</span>      <span class="mf">71.8</span> <span class="o">|</span>       <span class="mf">3.4</span>
 <span class="n">Financial</span> <span class="n">District</span>  <span class="o">|</span>      <span class="mi">34807</span> <span class="o">|</span>      <span class="mf">69.9</span> <span class="o">|</span>       <span class="mf">3.8</span>
 <span class="n">Clinton</span>             <span class="o">|</span>      <span class="mi">32201</span> <span class="o">|</span>      <span class="mf">65.3</span> <span class="o">|</span>       <span class="mf">7.9</span>
 <span class="n">East</span> <span class="n">Village</span>        <span class="o">|</span>      <span class="mi">82266</span> <span class="o">|</span>      <span class="mf">63.3</span> <span class="o">|</span>       <span class="mf">8.8</span>
 <span class="n">Garment</span> <span class="n">District</span>    <span class="o">|</span>      <span class="mi">10539</span> <span class="o">|</span>      <span class="mf">55.2</span> <span class="o">|</span>       <span class="mf">7.1</span>
 <span class="n">Morningside</span> <span class="n">Heights</span> <span class="o">|</span>      <span class="mi">42844</span> <span class="o">|</span>      <span class="mf">52.7</span> <span class="o">|</span>      <span class="mf">19.4</span>
 <span class="n">Little</span> <span class="n">Italy</span>        <span class="o">|</span>      <span class="mi">12568</span> <span class="o">|</span>      <span class="mf">49.0</span> <span class="o">|</span>       <span class="mf">1.8</span>
 <span class="n">Yorkville</span>           <span class="o">|</span>      <span class="mi">58450</span> <span class="o">|</span>      <span class="mf">35.6</span> <span class="o">|</span>      <span class="mf">29.7</span>
 <span class="n">Inwood</span>              <span class="o">|</span>      <span class="mi">50047</span> <span class="o">|</span>      <span class="mf">35.2</span> <span class="o">|</span>      <span class="mf">16.8</span>
 <span class="n">Washington</span> <span class="n">Heights</span>  <span class="o">|</span>     <span class="mi">169013</span> <span class="o">|</span>      <span class="mf">34.9</span> <span class="o">|</span>      <span class="mf">16.8</span>
 <span class="n">Lower</span> <span class="n">East</span> <span class="n">Side</span>     <span class="o">|</span>      <span class="mi">96156</span> <span class="o">|</span>      <span class="mf">33.5</span> <span class="o">|</span>       <span class="mf">9.1</span>
 <span class="n">East</span> <span class="n">Harlem</span>         <span class="o">|</span>      <span class="mi">60576</span> <span class="o">|</span>      <span class="mf">26.4</span> <span class="o">|</span>      <span class="mf">40.4</span>
 <span class="n">Hamilton</span> <span class="n">Heights</span>    <span class="o">|</span>      <span class="mi">67432</span> <span class="o">|</span>      <span class="mf">23.9</span> <span class="o">|</span>      <span class="mf">35.8</span>
 <span class="n">Chinatown</span>           <span class="o">|</span>      <span class="mi">16209</span> <span class="o">|</span>      <span class="mf">15.2</span> <span class="o">|</span>       <span class="mf">3.8</span>
 <span class="n">Harlem</span>              <span class="o">|</span>     <span class="mi">134955</span> <span class="o">|</span>      <span class="mf">15.1</span> <span class="o">|</span>      <span class="mf">67.1</span>
</pre></div>
</div>
<p>What’s going on here? Notionally (the actual evaluation order is optimized under the covers by the database) this is what happens:</p>
<ol class="arabic simple">
<li>The <code class="docutils literal notranslate"><span class="pre">JOIN</span></code> clause creates a virtual table that includes columns from both the neighborhoods and census tables.</li>
<li>The <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> clause filters our virtual table to just rows in Manhattan.</li>
<li>The remaining rows are grouped by the neighborhood name and fed through the aggregation function to <strong class="command">Sum()</strong> the population values.</li>
<li>After a little arithmetic and formatting (e.g., <code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code>, <code class="docutils literal notranslate"><span class="pre">ORDER</span> <span class="pre">BY</span></code>) on the final numbers, our query spits out the percentages.</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <code class="docutils literal notranslate"><span class="pre">JOIN</span></code> clause combines two <code class="docutils literal notranslate"><span class="pre">FROM</span></code> items.  By default, we are using an <code class="docutils literal notranslate"><span class="pre">INNER</span> <span class="pre">JOIN</span></code>, but there are four other types of joins. For further information see the <a class="reference external" href="http://www.postgresql.org/docs/9.1/interactive/sql-select.html#SQL-FROM">join_type</a> definition in the PostgreSQL documentation.</p>
</div>
<p>We can also use distance tests as a join key, to create summarized “all items within a radius” queries. Let’s explore the racial geography of New York using distance queries.</p>
<p>First, let’s get the baseline racial make-up of the city.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span>
  <span class="mi">100</span><span class="p">.</span><span class="mi">0</span> <span class="o">*</span> <span class="k">Sum</span><span class="p">(</span><span class="n">popn_white</span><span class="p">)</span> <span class="o">/</span> <span class="k">Sum</span><span class="p">(</span><span class="n">popn_total</span><span class="p">)</span> <span class="k">AS</span> <span class="n">white_pct</span><span class="p">,</span>
  <span class="mi">100</span><span class="p">.</span><span class="mi">0</span> <span class="o">*</span> <span class="k">Sum</span><span class="p">(</span><span class="n">popn_black</span><span class="p">)</span> <span class="o">/</span> <span class="k">Sum</span><span class="p">(</span><span class="n">popn_total</span><span class="p">)</span> <span class="k">AS</span> <span class="n">black_pct</span><span class="p">,</span>
  <span class="k">Sum</span><span class="p">(</span><span class="n">popn_total</span><span class="p">)</span> <span class="k">AS</span> <span class="n">popn_total</span>
<span class="k">FROM</span> <span class="n">nyc_census_blocks</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">white_pct</span>     <span class="o">|</span>    <span class="n">black_pct</span>     <span class="o">|</span> <span class="n">popn_total</span>
<span class="o">------------------+------------------+------------</span>
 <span class="mf">44.0039500762811</span> <span class="o">|</span> <span class="mf">25.5465789002416</span> <span class="o">|</span>    <span class="mi">8175032</span>
</pre></div>
</div>
<p>So, of the 8M people in New York, about 44% are recorded as “white” and 26% are recorded as “black”.</p>
<p>Duke Ellington once sang that “You / must take the A-train / To / go to Sugar Hill way up in Harlem.” As we saw earlier, Harlem has far and away the highest African-American population in Manhattan (80.5%). Is the same true of Duke’s A-train?</p>
<p>First, note that the contents of the <code class="docutils literal notranslate"><span class="pre">nyc_subway_stations</span></code> table <code class="docutils literal notranslate"><span class="pre">routes</span></code> field is what we are interested in to find the A-train. The values in there are a little complex.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="n">routes</span> <span class="k">FROM</span> <span class="n">nyc_subway_stations</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>      <span class="n">routes</span>
<span class="o">----------------</span>
<span class="mi">4</span><span class="p">,</span><span class="mi">5</span>

<span class="n">N</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">W</span>
<span class="n">J</span>
<span class="n">B</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">R</span>
<span class="n">D</span><span class="p">,</span><span class="n">F</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">Q</span>
<span class="n">J</span><span class="p">,</span><span class="n">M</span>
<span class="n">E</span><span class="p">,</span><span class="n">F</span>
<span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span>
<span class="n">N</span>
<span class="n">N</span><span class="p">,</span><span class="n">W</span>
<span class="n">B</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">E</span>
<span class="n">B</span><span class="p">,</span><span class="n">D</span>
<span class="n">J</span><span class="p">,</span><span class="n">Z</span>
<span class="mi">6</span>
<span class="mi">2</span>
<span class="n">M</span><span class="p">,</span><span class="n">D</span>
<span class="n">N</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">W</span>
<span class="n">L</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">W</span>
<span class="n">F</span><span class="p">,</span><span class="n">V</span>
<span class="n">M</span>
<span class="mi">4</span>
<span class="n">B</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="mi">4</span>
<span class="n">D</span><span class="p">,</span><span class="n">M</span>
<span class="n">N</span><span class="p">,</span><span class="n">R</span>
<span class="n">N</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">W</span><span class="p">,</span><span class="mi">7</span>
<span class="n">D</span>
<span class="mi">3</span><span class="p">,</span><span class="mi">4</span>
<span class="n">F</span><span class="p">,</span><span class="n">Q</span>
<span class="n">D</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">R</span>
<span class="n">Q</span>
<span class="n">E</span>
<span class="n">E</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">V</span>
<span class="n">E</span><span class="p">,</span><span class="n">F</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">V</span>
<span class="n">A</span><span class="p">,</span><span class="n">C</span>
<span class="mi">2</span><span class="p">,</span><span class="mi">5</span>
<span class="n">B</span><span class="p">,</span><span class="n">C</span>
<span class="n">E</span><span class="p">,</span><span class="n">J</span><span class="p">,</span><span class="n">Z</span>
<span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span>
<span class="mi">7</span>
<span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">D</span>
<span class="n">G</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">V</span>
<span class="n">N</span><span class="p">,</span><span class="n">W</span><span class="p">,</span><span class="mi">7</span>
<span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span>
<span class="mi">5</span>
<span class="n">B</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">F</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">V</span><span class="p">,</span><span class="n">W</span>
<span class="n">B</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">S</span>
<span class="n">A</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">E</span><span class="p">,</span><span class="n">L</span>
<span class="n">A</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">F</span>
<span class="mi">2</span><span class="p">,</span><span class="mi">3</span>
<span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">C</span>
<span class="n">M</span><span class="p">,</span><span class="n">R</span>
<span class="n">R</span>
<span class="n">A</span><span class="p">,</span><span class="n">S</span>
<span class="n">B</span><span class="p">,</span><span class="n">Q</span>
<span class="n">C</span>
<span class="n">F</span><span class="p">,</span><span class="n">J</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">Z</span>
<span class="n">C</span><span class="p">,</span><span class="n">E</span>
<span class="mi">1</span>
<span class="n">F</span>
<span class="n">J</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">Z</span>
<span class="n">G</span>
<span class="n">A</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">E</span>
<span class="mi">3</span>
<span class="n">B</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">F</span><span class="p">,</span><span class="n">V</span>
<span class="n">R</span><span class="p">,</span><span class="n">W</span>
<span class="n">S</span>
<span class="n">E</span><span class="p">,</span><span class="n">V</span>
<span class="n">F</span><span class="p">,</span><span class="n">G</span>
<span class="n">A</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">G</span>
<span class="n">A</span>
<span class="n">F</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">V</span>
<span class="n">L</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <code class="docutils literal notranslate"><span class="pre">DISTINCT</span></code> keyword eliminates duplicate rows from the result.  Without the <code class="docutils literal notranslate"><span class="pre">DISTINCT</span></code> keyword, the query above identifies 491 results instead of 73.</p>
</div>
<p>So to find the A-train, we will want any row in <code class="docutils literal notranslate"><span class="pre">routes</span></code> that has an ‘A’ in it. We can do this a number of ways, but today we will use the fact that <strong class="command">strpos(routes,'A')</strong> will return a non-zero number only if ‘A’ is in the <code class="docutils literal notranslate"><span class="pre">routes</span></code> field.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="n">routes</span>
<span class="k">FROM</span> <span class="n">nyc_subway_stations</span> <span class="k">AS</span> <span class="n">subways</span>
<span class="k">WHERE</span> <span class="n">strpos</span><span class="p">(</span><span class="n">subways</span><span class="p">.</span><span class="n">routes</span><span class="p">,</span><span class="s1">&#39;A&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">A</span><span class="p">,</span><span class="n">C</span>
<span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">D</span>
<span class="n">A</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">E</span><span class="p">,</span><span class="n">L</span>
<span class="n">A</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">F</span>
<span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">C</span>
<span class="n">A</span><span class="p">,</span><span class="n">S</span>
<span class="n">A</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">E</span>
<span class="n">A</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">G</span>
<span class="n">A</span>
</pre></div>
</div>
<p>Let’s summarize the racial make-up of within 200 meters of the A-train line.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span>
  <span class="mi">100</span><span class="p">.</span><span class="mi">0</span> <span class="o">*</span> <span class="k">Sum</span><span class="p">(</span><span class="n">popn_white</span><span class="p">)</span> <span class="o">/</span> <span class="k">Sum</span><span class="p">(</span><span class="n">popn_total</span><span class="p">)</span> <span class="k">AS</span> <span class="n">white_pct</span><span class="p">,</span>
  <span class="mi">100</span><span class="p">.</span><span class="mi">0</span> <span class="o">*</span> <span class="k">Sum</span><span class="p">(</span><span class="n">popn_black</span><span class="p">)</span> <span class="o">/</span> <span class="k">Sum</span><span class="p">(</span><span class="n">popn_total</span><span class="p">)</span> <span class="k">AS</span> <span class="n">black_pct</span><span class="p">,</span>
  <span class="k">Sum</span><span class="p">(</span><span class="n">popn_total</span><span class="p">)</span> <span class="k">AS</span> <span class="n">popn_total</span>
<span class="k">FROM</span> <span class="n">nyc_census_blocks</span> <span class="k">AS</span> <span class="n">census</span>
<span class="k">JOIN</span> <span class="n">nyc_subway_stations</span> <span class="k">AS</span> <span class="n">subways</span>
<span class="k">ON</span> <span class="n">ST_DWithin</span><span class="p">(</span><span class="n">census</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">subways</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="k">WHERE</span> <span class="n">strpos</span><span class="p">(</span><span class="n">subways</span><span class="p">.</span><span class="n">routes</span><span class="p">,</span><span class="s1">&#39;A&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">white_pct</span>     <span class="o">|</span>    <span class="n">black_pct</span>     <span class="o">|</span> <span class="n">popn_total</span>
<span class="o">------------------+------------------+------------</span>
 <span class="mf">45.5901255900202</span> <span class="o">|</span> <span class="mf">22.0936235670937</span> <span class="o">|</span>     <span class="mi">189824</span>
</pre></div>
</div>
<p>So the racial make-up along the A-train isn’t radically different from the make-up of New York City as a whole.</p>
</div>
<div class="section" id="advanced-join">
<h3>5.7.2. Advanced Join<a class="headerlink" href="#advanced-join" title="Permalink to this headline">¶</a></h3>
<p>In the last section we saw that the A-train didn’t serve a population that differed much from the racial make-up of the rest of the city. Are there any trains that have a non-average racial make-up?</p>
<p>To answer that question, we’ll add another join to our query, so that we can simultaneously calculate the make-up of many subway lines at once. To do that, we’ll need to create a new table that enumerates all the lines we want to summarize.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">subway_lines</span> <span class="p">(</span> <span class="n">route</span> <span class="nb">char</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">subway_lines</span> <span class="p">(</span><span class="n">route</span><span class="p">)</span> <span class="k">VALUES</span>
  <span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">),(</span><span class="s1">&#39;B&#39;</span><span class="p">),(</span><span class="s1">&#39;C&#39;</span><span class="p">),(</span><span class="s1">&#39;D&#39;</span><span class="p">),(</span><span class="s1">&#39;E&#39;</span><span class="p">),(</span><span class="s1">&#39;F&#39;</span><span class="p">),(</span><span class="s1">&#39;G&#39;</span><span class="p">),</span>
  <span class="p">(</span><span class="s1">&#39;J&#39;</span><span class="p">),(</span><span class="s1">&#39;L&#39;</span><span class="p">),(</span><span class="s1">&#39;M&#39;</span><span class="p">),(</span><span class="s1">&#39;N&#39;</span><span class="p">),(</span><span class="s1">&#39;Q&#39;</span><span class="p">),(</span><span class="s1">&#39;R&#39;</span><span class="p">),(</span><span class="s1">&#39;S&#39;</span><span class="p">),</span>
  <span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">),(</span><span class="s1">&#39;1&#39;</span><span class="p">),(</span><span class="s1">&#39;2&#39;</span><span class="p">),(</span><span class="s1">&#39;3&#39;</span><span class="p">),(</span><span class="s1">&#39;4&#39;</span><span class="p">),(</span><span class="s1">&#39;5&#39;</span><span class="p">),(</span><span class="s1">&#39;6&#39;</span><span class="p">),</span>
  <span class="p">(</span><span class="s1">&#39;7&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>Now we can join the table of subway lines onto our original query.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span>
  <span class="n">lines</span><span class="p">.</span><span class="n">route</span><span class="p">,</span>
  <span class="mi">100</span><span class="p">.</span><span class="mi">0</span> <span class="o">*</span> <span class="k">Sum</span><span class="p">(</span><span class="n">popn_white</span><span class="p">)</span> <span class="o">/</span> <span class="k">Sum</span><span class="p">(</span><span class="n">popn_total</span><span class="p">)</span> <span class="k">AS</span> <span class="n">white_pct</span><span class="p">,</span>
  <span class="mi">100</span><span class="p">.</span><span class="mi">0</span> <span class="o">*</span> <span class="k">Sum</span><span class="p">(</span><span class="n">popn_black</span><span class="p">)</span> <span class="o">/</span> <span class="k">Sum</span><span class="p">(</span><span class="n">popn_total</span><span class="p">)</span> <span class="k">AS</span> <span class="n">black_pct</span><span class="p">,</span>
  <span class="k">Sum</span><span class="p">(</span><span class="n">popn_total</span><span class="p">)</span> <span class="k">AS</span> <span class="n">popn_total</span>
<span class="k">FROM</span> <span class="n">nyc_census_blocks</span> <span class="k">AS</span> <span class="n">census</span>
<span class="k">JOIN</span> <span class="n">nyc_subway_stations</span> <span class="k">AS</span> <span class="n">subways</span>
<span class="k">ON</span> <span class="n">ST_DWithin</span><span class="p">(</span><span class="n">census</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">subways</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="k">JOIN</span> <span class="n">subway_lines</span> <span class="k">AS</span> <span class="n">lines</span>
<span class="k">ON</span> <span class="n">strpos</span><span class="p">(</span><span class="n">subways</span><span class="p">.</span><span class="n">routes</span><span class="p">,</span> <span class="n">lines</span><span class="p">.</span><span class="n">route</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">lines</span><span class="p">.</span><span class="n">route</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">black_pct</span> <span class="k">DESC</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">route</span> <span class="o">|</span> <span class="n">white_pct</span> <span class="o">|</span> <span class="n">black_pct</span> <span class="o">|</span> <span class="n">popn_total</span>
<span class="o">-------+-----------+-----------+------------</span>
 <span class="n">S</span>     <span class="o">|</span>      <span class="mf">39.8</span> <span class="o">|</span>      <span class="mf">46.5</span> <span class="o">|</span>      <span class="mi">33301</span>
 <span class="mi">3</span>     <span class="o">|</span>      <span class="mf">42.7</span> <span class="o">|</span>      <span class="mf">42.1</span> <span class="o">|</span>     <span class="mi">223047</span>
 <span class="mi">5</span>     <span class="o">|</span>      <span class="mf">33.8</span> <span class="o">|</span>      <span class="mf">41.4</span> <span class="o">|</span>     <span class="mi">218919</span>
 <span class="mi">2</span>     <span class="o">|</span>      <span class="mf">39.3</span> <span class="o">|</span>      <span class="mf">38.4</span> <span class="o">|</span>     <span class="mi">291661</span>
 <span class="n">C</span>     <span class="o">|</span>      <span class="mf">46.9</span> <span class="o">|</span>      <span class="mf">30.6</span> <span class="o">|</span>     <span class="mi">224411</span>
 <span class="mi">4</span>     <span class="o">|</span>      <span class="mf">37.6</span> <span class="o">|</span>      <span class="mf">27.4</span> <span class="o">|</span>     <span class="mi">174998</span>
 <span class="n">B</span>     <span class="o">|</span>      <span class="mf">40.0</span> <span class="o">|</span>      <span class="mf">26.9</span> <span class="o">|</span>     <span class="mi">256583</span>
 <span class="n">A</span>     <span class="o">|</span>      <span class="mf">45.6</span> <span class="o">|</span>      <span class="mf">22.1</span> <span class="o">|</span>     <span class="mi">189824</span>
 <span class="n">J</span>     <span class="o">|</span>      <span class="mf">37.6</span> <span class="o">|</span>      <span class="mf">21.6</span> <span class="o">|</span>     <span class="mi">132861</span>
 <span class="n">Q</span>     <span class="o">|</span>      <span class="mf">56.9</span> <span class="o">|</span>      <span class="mf">20.6</span> <span class="o">|</span>     <span class="mi">127112</span>
 <span class="n">Z</span>     <span class="o">|</span>      <span class="mf">38.4</span> <span class="o">|</span>      <span class="mf">20.2</span> <span class="o">|</span>      <span class="mi">87131</span>
 <span class="n">D</span>     <span class="o">|</span>      <span class="mf">39.5</span> <span class="o">|</span>      <span class="mf">19.4</span> <span class="o">|</span>     <span class="mi">234931</span>
 <span class="n">L</span>     <span class="o">|</span>      <span class="mf">57.6</span> <span class="o">|</span>      <span class="mf">16.8</span> <span class="o">|</span>     <span class="mi">110118</span>
 <span class="n">G</span>     <span class="o">|</span>      <span class="mf">49.6</span> <span class="o">|</span>      <span class="mf">16.1</span> <span class="o">|</span>     <span class="mi">135012</span>
 <span class="mi">6</span>     <span class="o">|</span>      <span class="mf">52.3</span> <span class="o">|</span>      <span class="mf">15.7</span> <span class="o">|</span>     <span class="mi">260240</span>
 <span class="mi">1</span>     <span class="o">|</span>      <span class="mf">59.1</span> <span class="o">|</span>      <span class="mf">11.3</span> <span class="o">|</span>     <span class="mi">327742</span>
 <span class="n">F</span>     <span class="o">|</span>      <span class="mf">60.9</span> <span class="o">|</span>       <span class="mf">7.5</span> <span class="o">|</span>     <span class="mi">229439</span>
 <span class="n">M</span>     <span class="o">|</span>      <span class="mf">56.5</span> <span class="o">|</span>       <span class="mf">6.4</span> <span class="o">|</span>     <span class="mi">174196</span>
 <span class="n">E</span>     <span class="o">|</span>      <span class="mf">66.8</span> <span class="o">|</span>       <span class="mf">4.7</span> <span class="o">|</span>      <span class="mi">90958</span>
 <span class="n">R</span>     <span class="o">|</span>      <span class="mf">58.5</span> <span class="o">|</span>       <span class="mf">4.0</span> <span class="o">|</span>     <span class="mi">196999</span>
 <span class="mi">7</span>     <span class="o">|</span>      <span class="mf">35.7</span> <span class="o">|</span>       <span class="mf">3.5</span> <span class="o">|</span>     <span class="mi">102401</span>
 <span class="n">N</span>     <span class="o">|</span>      <span class="mf">59.7</span> <span class="o">|</span>       <span class="mf">3.5</span> <span class="o">|</span>     <span class="mi">147792</span>
</pre></div>
</div>
<p>As before, the joins create a virtual table of all the possible combinations available within the constraints of the <code class="docutils literal notranslate"><span class="pre">JOIN</span> <span class="pre">ON</span></code> restrictions, and those rows are then fed into a <code class="docutils literal notranslate"><span class="pre">GROUP</span></code> summary. The spatial magic is in the <code class="docutils literal notranslate"><span class="pre">ST_DWithin</span></code> function, that ensures only census blocks close to the appropriate subway stations are included in the calculation.</p>
</div>
<div class="section" id="id13">
<h3>5.7.3. Function List<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://postgis.net/docs/manual-2.1/ST_Contains.html">ST_Contains(geometry A, geometry B)</a>: Returns true if and only if no points of B lie in the exterior of A, and at least one point of the interior of B lies in the interior of A.</p>
<p><a class="reference external" href="http://postgis.net/docs/manual-2.1/ST_DWithin.html">ST_DWithin(geometry A, geometry B, radius)</a>: Returns true if the geometries are within the specified distance of one another.</p>
<p><a class="reference external" href="http://postgis.net/docs/manual-2.1/ST_Intersects.html">ST_Intersects(geometry A, geometry B)</a>: Returns TRUE if the Geometries/Geography “spatially intersect” - (share any portion of space) and FALSE if they don’t (they are Disjoint).</p>
<p><a class="reference external" href="http://www.postgresql.org/docs/current/interactive/functions-math.html">round(v numeric, s integer)</a>: PostgreSQL math function that rounds to s decimal places</p>
<p><a class="reference external" href="http://www.postgresql.org/docs/current/static/functions-string.html">strpos(string, substring)</a>: PostgreSQL string function that returns an integer location of a specified substring.</p>
<p><a class="reference external" href="http://www.postgresql.org/docs/current/static/functions-aggregate.html#FUNCTIONS-AGGREGATE-TABLE">sum(expression)</a>: PostgreSQL aggregate function that returns the sum of records in a set of records.</p>
<p class="rubric">Footnotes</p>
<table class="docutils footnote" frame="void" id="postgis-doco" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[1]</td><td><a class="reference external" href="http://postgis.net/docs/manual-2.1/">http://postgis.net/docs/manual-2.1/</a></td></tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="spatial-joins-exercises">
<span id="joins-exercises"></span><h2>5.8. Spatial Joins Exercises<a class="headerlink" href="#spatial-joins-exercises" title="Permalink to this headline">¶</a></h2>
<p>Here’s a reminder of some of the functions we have seen.  Hint: they should be useful for the exercises!</p>
<ul class="simple">
<li><strong class="command">sum(expression)</strong>: aggregate to return a sum for a set of records</li>
<li><strong class="command">count(expression)</strong>: aggregate to return the size of a set of records</li>
<li><strong class="command">ST_Area(geometry)</strong> returns the area of the polygons</li>
<li><strong class="command">ST_AsText(geometry)</strong> returns WKT <code class="docutils literal notranslate"><span class="pre">text</span></code></li>
<li><strong class="command">ST_Contains(geometry A, geometry B)</strong> returns the true if geometry A contains geometry B</li>
<li><strong class="command">ST_Distance(geometry A, geometry B)</strong> returns the minimum distance between geometry A and geometry B</li>
<li><strong class="command">ST_DWithin(geometry A, geometry B, radius)</strong> returns the true if geometry A is radius distance or less from geometry B</li>
<li><strong class="command">ST_GeomFromText(text)</strong> returns <code class="docutils literal notranslate"><span class="pre">geometry</span></code></li>
<li><strong class="command">ST_Intersects(geometry A, geometry B)</strong> returns the true if geometry A intersects geometry B</li>
<li><strong class="command">ST_Length(linestring)</strong> returns the length of the linestring</li>
<li><strong class="command">ST_Touches(geometry A, geometry B)</strong> returns the true if the boundary of geometry A touches geometry B</li>
<li><strong class="command">ST_Within(geometry A, geometry B)</strong> returns the true if geometry A is within geometry B</li>
</ul>
<p>Also remember the tables we have available:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">nyc_census_blocks</span></code><ul>
<li>name, popn_total, boroname, geom</li>
</ul>
</li>
<li><code class="docutils literal notranslate"><span class="pre">nyc_streets</span></code><ul>
<li>name, type, geom</li>
</ul>
</li>
<li><code class="docutils literal notranslate"><span class="pre">nyc_subway_stations</span></code><ul>
<li>name, routes, geom</li>
</ul>
</li>
<li><code class="docutils literal notranslate"><span class="pre">nyc_neighborhoods</span></code><ul>
<li>name, boroname, geom</li>
</ul>
</li>
</ul>
<div class="section" id="id18">
<h3>5.8.1. Exercises<a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p class="first"><strong>“What subway station is in ‘Little Italy’? What subway route is it on?”</strong></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">routes</span>
<span class="k">FROM</span> <span class="n">nyc_subway_stations</span> <span class="k">AS</span> <span class="n">s</span>
<span class="k">JOIN</span> <span class="n">nyc_neighborhoods</span> <span class="k">AS</span> <span class="n">n</span>
<span class="k">ON</span> <span class="n">ST_Contains</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span>
<span class="k">WHERE</span> <span class="n">n</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Little Italy&#39;</span><span class="p">;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Recall: the function <code class="docutils literal notranslate"><span class="pre">AS</span></code> is used to give a table another name by using an alias, which can make queries easier to read and write. In this case, <code class="docutils literal notranslate"><span class="pre">s</span></code> is an alias for <code class="docutils literal notranslate"><span class="pre">nyc_subway_stations</span></code>, <code class="docutils literal notranslate"><span class="pre">n</span></code> is an alias for <code class="docutils literal notranslate"><span class="pre">nyc_neighborhoods</span></code>, <code class="docutils literal notranslate"><span class="pre">s.name</span></code> refers to the name column in the <code class="docutils literal notranslate"><span class="pre">nyc_subway_stations</span></code> table, etc.</p>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   <span class="n">name</span>    <span class="o">|</span> <span class="n">routes</span>
<span class="o">-----------+--------</span>
 <span class="n">Spring</span> <span class="n">St</span> <span class="o">|</span> <span class="mi">6</span>
</pre></div>
</div>
</li>
<li><p class="first"><strong>“What are all the neighborhoods served by the 6-train?”</strong> (Hint: The <code class="docutils literal notranslate"><span class="pre">routes</span></code> column in the <code class="docutils literal notranslate"><span class="pre">nyc_subway_stations</span></code> table has values like ‘B,D,6,V’ and ‘C,6’)</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="n">n</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">n</span><span class="p">.</span><span class="n">boroname</span>
<span class="k">FROM</span> <span class="n">nyc_subway_stations</span> <span class="k">AS</span> <span class="n">s</span>
<span class="k">JOIN</span> <span class="n">nyc_neighborhoods</span> <span class="k">AS</span> <span class="n">n</span>
<span class="k">ON</span> <span class="n">ST_Contains</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span>
<span class="k">WHERE</span> <span class="n">strpos</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">routes</span><span class="p">,</span><span class="s1">&#39;6&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>        <span class="n">name</span>        <span class="o">|</span> <span class="n">boroname</span>
<span class="o">--------------------+-----------</span>
 <span class="n">Chinatown</span>          <span class="o">|</span> <span class="n">Manhattan</span>
 <span class="n">East</span> <span class="n">Harlem</span>        <span class="o">|</span> <span class="n">Manhattan</span>
 <span class="n">Financial</span> <span class="n">District</span> <span class="o">|</span> <span class="n">Manhattan</span>
 <span class="n">Gramercy</span>           <span class="o">|</span> <span class="n">Manhattan</span>
 <span class="n">Greenwich</span> <span class="n">Village</span>  <span class="o">|</span> <span class="n">Manhattan</span>
 <span class="n">Hunts</span> <span class="n">Point</span>        <span class="o">|</span> <span class="n">The</span> <span class="n">Bronx</span>
 <span class="n">Little</span> <span class="n">Italy</span>       <span class="o">|</span> <span class="n">Manhattan</span>
 <span class="n">Midtown</span>            <span class="o">|</span> <span class="n">Manhattan</span>
 <span class="n">Mott</span> <span class="n">Haven</span>         <span class="o">|</span> <span class="n">The</span> <span class="n">Bronx</span>
 <span class="n">Murray</span> <span class="n">Hill</span>        <span class="o">|</span> <span class="n">Manhattan</span>
 <span class="n">Parkchester</span>        <span class="o">|</span> <span class="n">The</span> <span class="n">Bronx</span>
 <span class="n">Soundview</span>          <span class="o">|</span> <span class="n">The</span> <span class="n">Bronx</span>
 <span class="n">South</span> <span class="n">Bronx</span>        <span class="o">|</span> <span class="n">The</span> <span class="n">Bronx</span>
 <span class="n">Upper</span> <span class="n">East</span> <span class="n">Side</span>    <span class="o">|</span> <span class="n">Manhattan</span>
 <span class="n">Yorkville</span>          <span class="o">|</span> <span class="n">Manhattan</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">We used the <code class="docutils literal notranslate"><span class="pre">DISTINCT</span></code> keyword to remove duplicate values from our result set where there were more than one subway station in a neighborhood.</p>
</div>
</li>
<li><p class="first"><strong>“After 9/11, the ‘Battery Park’ neighborhood was off limits for several days. How many people had to be evacuated?”</strong></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="k">Sum</span><span class="p">(</span><span class="n">popn_total</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">nyc_neighborhoods</span> <span class="k">AS</span> <span class="n">n</span>
<span class="k">JOIN</span> <span class="n">nyc_census_blocks</span> <span class="k">AS</span> <span class="k">c</span>
<span class="k">ON</span> <span class="n">ST_Intersects</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span>
<span class="k">WHERE</span> <span class="n">n</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Battery Park&#39;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">17153</span>
</pre></div>
</div>
</li>
<li><p class="first"><strong>“What are the population density (people / km^2) of the ‘Upper West Side’ and ‘Upper East Side’?”</strong> (Hint: There are 1000000 m^2 in one km^2.)</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span>
  <span class="n">n</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
  <span class="k">Sum</span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">popn_total</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ST_Area</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">AS</span> <span class="n">popn_per_sqkm</span>
<span class="k">FROM</span> <span class="n">nyc_census_blocks</span> <span class="k">AS</span> <span class="k">c</span>
<span class="k">JOIN</span> <span class="n">nyc_neighborhoods</span> <span class="k">AS</span> <span class="n">n</span>
<span class="k">ON</span> <span class="n">ST_Intersects</span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">n</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span>
<span class="k">WHERE</span> <span class="n">n</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Upper West Side&#39;</span>
<span class="k">OR</span> <span class="n">n</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Upper East Side&#39;</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">n</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">n</span><span class="p">.</span><span class="n">geom</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>      <span class="n">name</span>       <span class="o">|</span>  <span class="n">popn_per_sqkm</span>
<span class="o">-----------------+------------------</span>
 <span class="n">Upper</span> <span class="n">East</span> <span class="n">Side</span> <span class="o">|</span> <span class="mf">48524.4877489857</span>
 <span class="n">Upper</span> <span class="n">West</span> <span class="n">Side</span> <span class="o">|</span> <span class="mf">40152.4896080024</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<div class="section" id="spatial-indexing">
<span id="indexing"></span><h2>5.9. Spatial Indexing<a class="headerlink" href="#spatial-indexing" title="Permalink to this headline">¶</a></h2>
<p>Recall that spatial index is one of the three key features of a spatial database. Indexes are what make using a spatial database for large data sets possible. Without indexing, any search for a feature would require a “sequential scan” of every record in the database. Indexing speeds up searching by organizing the data into a search tree which can be quickly traversed to find a particular record.</p>
<p>Spatial indices are one of the greatest assets of PostGIS.  In the previous example building spatial joins requires comparing whole tables with each other. This can get very costly: joining two tables of 10,000 records each without indexes would require 100,000,000 comparisons; with indexes the cost could be as low as 20,000 comparisons.</p>
<p>When we loaded the <code class="docutils literal notranslate"><span class="pre">nyc_census_blocks</span></code> table, the QGIS DB Manager was set to automatically create a spatial index called <code class="docutils literal notranslate"><span class="pre">sidx_nyc_census_blocks_geom</span></code></p>
<p>To demonstrate how important indexes are for performance, let’s search <code class="docutils literal notranslate"><span class="pre">nyc_census_blocks</span></code> <strong>without</strong> our spatial index.</p>
<p>Our first step is to remove the index.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">DROP</span> <span class="k">INDEX</span> <span class="n">sidx_nyc_census_blocks_geom</span><span class="p">;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <code class="docutils literal notranslate"><span class="pre">DROP</span> <span class="pre">INDEX</span></code> statement drops an existing index from the database system. For more information, see the PostgreSQL <a class="reference external" href="https://www.postgresql.org/docs/11/sql-dropindex.html">documentation</a>.</p>
</div>
<p>Now, watch the “Timing” meter at the lower right-hand corner of the pgAdmin query window and run the following. Our query searches through every single census block in order to identify the Broad Street entry.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">blocks</span><span class="p">.</span><span class="n">blkid</span>
 <span class="k">FROM</span> <span class="n">nyc_census_blocks</span> <span class="n">blocks</span>
 <span class="k">JOIN</span> <span class="n">nyc_subway_stations</span> <span class="n">subways</span>
 <span class="k">ON</span> <span class="n">ST_Contains</span><span class="p">(</span><span class="n">blocks</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">subways</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span>
 <span class="k">WHERE</span> <span class="n">subways</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Broad St&#39;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>      <span class="n">blkid</span>
<span class="o">-----------------</span>
 <span class="mi">360610007001009</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">nyc_census_blocks</span></code> table is very small (only a few thousand records) so even without an index, the query only takes <strong>103 ms</strong> on my test computer.</p>
<p>Now add the spatial index back in and run the query again.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">sidx_nyc_census_blocks_geom</span>
  <span class="k">ON</span> <span class="n">nyc_census_blocks</span>
  <span class="k">USING</span> <span class="n">GIST</span> <span class="p">(</span><span class="n">geom</span><span class="p">);</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <code class="docutils literal notranslate"><span class="pre">USING</span> <span class="pre">GIST</span></code> clause tells PostgreSQL to use the generic index structure (GIST) when building the index.  If you receive an error that looks like <code class="docutils literal notranslate"><span class="pre">ERROR:</span> <span class="pre">index</span> <span class="pre">row</span> <span class="pre">requires</span> <span class="pre">11340</span> <span class="pre">bytes,</span> <span class="pre">maximum</span> <span class="pre">size</span> <span class="pre">is</span> <span class="pre">8191</span></code> when creating your index, you have likely neglected to add the <code class="docutils literal notranslate"><span class="pre">USING</span> <span class="pre">GIST</span></code> clause.</p>
</div>
<p>On my test computer the time drops to <strong>66 ms</strong>. The larger your table, the larger the relative speed improvement of an indexed query will be.</p>
<div class="section" id="how-spatial-indexes-work">
<h3>5.9.1. How Spatial Indexes Work<a class="headerlink" href="#how-spatial-indexes-work" title="Permalink to this headline">¶</a></h3>
<p>Standard database indexes create a hierarchical tree based on the values of the column being indexed. Spatial indexes are a little different – they are unable to index the geometric features themselves  and instead index the bounding boxes of the features.</p>
<img alt="_images/bbox.png" class="inline" src="_images/bbox.png" />
<p>In the figure above, the number of lines that intersect the yellow star is <strong>one</strong>, the red line. But the bounding boxes of features that intersect the yellow box is <strong>two</strong>, the red and blue ones.</p>
<p>The way the database efficiently answers the question “what lines intersect the yellow star” is to first answer the question “what boxes intersect the yellow box” using the index (which is very fast) and then do an exact calculation of “what lines intersect the yellow star” <strong>only for those features returned by the first test</strong>.</p>
<p>For a large table, this “two pass” system of evaluating the approximate index first, then carrying out an exact test can radically reduce the amount of calculations necessary to answer a query.</p>
<p>Both PostGIS and Oracle Spatial share the same “R-Tree” <a class="footnote-reference" href="#rtree" id="id19">[2]</a> spatial index structure. R-Trees break up data into rectangles, and sub-rectangles, and sub-sub rectangles, etc.  It is a self-tuning index structure that automatically handles variable data density and object size.</p>
<img alt="_images/index-01.png" src="_images/index-01.png" />
</div>
<div class="section" id="index-only-queries">
<h3>5.9.2. Index-Only Queries<a class="headerlink" href="#index-only-queries" title="Permalink to this headline">¶</a></h3>
<p>Most of the commonly used functions in PostGIS (<strong class="command">ST_Contains</strong>, <strong class="command">ST_Intersects</strong>, <strong class="command">ST_DWithin</strong>, etc) include an index filter automatically. But some functions (e.g., <strong class="command">ST_Relate</strong>) do not include an index filter.</p>
<p>To do a bounding-box search using the index (and no filtering), make use of the <strong class="command">&amp;&amp;</strong> operator. For geometries, the <strong class="command">&amp;&amp;</strong> operator means “bounding boxes overlap or touch” in the same way that for number the <strong class="command">=</strong> operator means “values are the same”.</p>
<p>Let’s compare an index-only query for the population of the ‘West Village’ to a more exact query. Using <strong class="command">&amp;&amp;</strong> our index-only query looks like the following:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="k">Sum</span><span class="p">(</span><span class="n">popn_total</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">nyc_neighborhoods</span> <span class="n">neighborhoods</span>
<span class="k">JOIN</span> <span class="n">nyc_census_blocks</span> <span class="n">blocks</span>
<span class="k">ON</span> <span class="n">neighborhoods</span><span class="p">.</span><span class="n">geom</span> <span class="o">&amp;&amp;</span> <span class="n">blocks</span><span class="p">.</span><span class="n">geom</span>
<span class="k">WHERE</span> <span class="n">neighborhoods</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;West Village&#39;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">49821</span>
</pre></div>
</div>
<p>Now let’s do the same query using the more exact <strong class="command">ST_Intersects</strong> function.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="k">Sum</span><span class="p">(</span><span class="n">popn_total</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">nyc_neighborhoods</span> <span class="n">neighborhoods</span>
<span class="k">JOIN</span> <span class="n">nyc_census_blocks</span> <span class="n">blocks</span>
<span class="k">ON</span> <span class="n">ST_Intersects</span><span class="p">(</span><span class="n">neighborhoods</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">blocks</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span>
<span class="k">WHERE</span> <span class="n">neighborhoods</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;West Village&#39;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">26718</span>
</pre></div>
</div>
<p>A much lower answer! The first query summed up every block that intersected the neighborhood’s bounding box; the second query only summed up those blocks that intersected the neighborhood itself.</p>
</div>
<div class="section" id="analyzing">
<h3>5.9.3. Analyzing<a class="headerlink" href="#analyzing" title="Permalink to this headline">¶</a></h3>
<p>The PostgreSQL query planner intelligently chooses when to use or not to use indexes to evaluate a query. Counter-intuitively, it is not always faster to do an index search: if the search is going to return every record in the table, traversing the index tree to get each record will actually be slower than just linearly reading the whole table from the start.</p>
<p>In order to figure out what situation it is dealing with (reading a small part of the table versus reading a large portion of the table), PostgreSQL keeps statistics about the distribution of data in each indexed table column.  By default, PostgreSQL gathers statistics on a regular basis. However, if you dramatically change the make-up of your table within a short period of time, the statistics will not be up-to-date.</p>
<p>To ensure your statistics match your table contents, it is wise to run the <code class="docutils literal notranslate"><span class="pre">ANALYZE</span></code> command after bulk data loads and deletes in your tables. This force the statistics system to gather data for all your indexed columns.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">ANALYZE</span></code> command asks PostgreSQL to traverse the table and update its internal statistics used for query plan estimation (query plan analysis will be discussed later).</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">ANALYZE</span> <span class="n">nyc_census_blocks</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="vacuuming">
<h3>5.9.4. Vacuuming<a class="headerlink" href="#vacuuming" title="Permalink to this headline">¶</a></h3>
<p>It’s worth stressing that just creating an index is not enough to allow PostgreSQL to use it effectively.  VACUUMing must be performed whenever a new index is created or after a large number of UPDATEs, INSERTs or DELETEs are issued against a table.  The <code class="docutils literal notranslate"><span class="pre">VACUUM</span></code> command asks PostgreSQL to reclaim any unused space in the table pages left by updates or deletes to records.</p>
<p>Vacuuming is so critical for the efficient running of the database that PostgreSQL provides an “autovacuum” option.</p>
<p>Enabled by default, autovacuum both vacuums (recovers space) and analyzes (updates statistics) on your tables at sensible intervals determined by the level of activity.  While this is essential for highly transactional databases, it is not advisable to wait for an autovacuum run after adding indices or bulk-loading data.  If a large batch update is performed, you should manually run <code class="docutils literal notranslate"><span class="pre">VACUUM</span></code>.</p>
<p>Vacuuming and analyzing the database can be performed separately as needed.  Issuing <code class="docutils literal notranslate"><span class="pre">VACUUM</span></code> command will not update the database statistics; likewise issuing an <code class="docutils literal notranslate"><span class="pre">ANALYZE</span></code> command will not recover unused table rows.  Both commands can be run against the entire database, a single table, or a single column.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">VACUUM</span> <span class="k">ANALYZE</span> <span class="n">nyc_census_blocks</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="id20">
<h3>5.9.5. Function List<a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://postgis.net/docs/manual-1.5/ST_Geometry_Overlap.html">geometry_a &amp;&amp; geometry_b</a>: Returns TRUE if A’s bounding box overlaps B’s.</p>
<p><a class="reference external" href="https://postgis.net/docs/ST_Geometry_EQ.html">geometry_a = geometry_b</a>: Returns TRUE if A’s bounding box is the same as B’s.</p>
<p><a class="reference external" href="https://postgis.net/docs/ST_Intersects.html">ST_Intersects(geometry_a, geometry_b)</a>: Returns TRUE if the Geometries/Geography “spatially intersect” - (share any portion of space) and FALSE if they don’t (they are Disjoint).</p>
<p class="rubric">Footnotes</p>
<table class="docutils footnote" frame="void" id="rtree" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id19">[2]</a></td><td><a class="reference external" href="http://postgis.org/support/rtree.pdf">http://postgis.org/support/rtree.pdf</a></td></tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="projecting-data">
<span id="projection"></span><h2>5.10. Projecting Data<a class="headerlink" href="#projecting-data" title="Permalink to this headline">¶</a></h2>
<p>The earth is not flat, and there is no simple way of putting it down on a flat paper map (or computer screen), so people have come up with all sorts of ingenious solutions, each with pros and cons. Some projections preserve area, so all objects have a relative size to each other; other projections preserve angles (conformal) like the Mercator projection; some projections try to find a good intermediate mix with only little distortion on several parameters. Common to all projections is that they transform the (spherical) world onto a flat Cartesian coordinate system, and which projection to choose depends on how you will be using the data.</p>
<p>We’ve already encountered projections when we <a class="reference internal" href="setup/loading_data.html#loading-data"><span class="std std-ref">loaded our nyc data</span></a>.  (Recall that pesky SRID 26918).  Sometimes, however, you need to transform and re-project between spatial reference systems. PostGIS includes built-in support for changing the projection of data, using the <strong class="command">ST_Transform(geometry, srid)</strong> function. For managing the spatial reference identifiers on geometries, PostGIS provides the <strong class="command">ST_SRID(geometry)</strong> and <strong class="command">ST_SetSRID(geometry, srid)</strong> functions.</p>
<p>We can confirm the SRID of our data with the <strong class="command">ST_SRID</strong> command:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">ST_SRID</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">nyc_streets</span> <span class="k">LIMIT</span> <span class="mi">1</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">26918</span>
</pre></div>
</div>
<p>And what is definition of “26918”? As we saw in “<a class="reference internal" href="setup/loading_data.html#loading-data"><span class="std std-ref">loading data section</span></a>”, the definition is contained in the <code class="docutils literal notranslate"><span class="pre">spatial_ref_sys</span></code> table. In fact, <strong>two</strong> definitions are there. The “well-known text” (<a class="reference internal" href="glossary.html#term-wkt"><span class="xref std std-term">WKT</span></a>) definition is in the <code class="docutils literal notranslate"><span class="pre">srtext</span></code> column, and there is a second definition in “proj.4” format in the <code class="docutils literal notranslate"><span class="pre">proj4text</span></code> column.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">spatial_ref_sys</span> <span class="k">WHERE</span> <span class="n">srid</span> <span class="o">=</span> <span class="mi">26918</span><span class="p">;</span>
</pre></div>
</div>
<p>In fact, for the internal PostGIS re-projection calculations, it is the contents of the <code class="docutils literal notranslate"><span class="pre">proj4text</span></code> column that are used. For our 26918 projection, here is the proj.4 text:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">proj4text</span> <span class="k">FROM</span> <span class="n">spatial_ref_sys</span> <span class="k">WHERE</span> <span class="n">srid</span> <span class="o">=</span> <span class="mi">26918</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">+</span><span class="n">proj</span><span class="o">=</span><span class="n">utm</span> <span class="o">+</span><span class="n">zone</span><span class="o">=</span><span class="mi">18</span> <span class="o">+</span><span class="n">ellps</span><span class="o">=</span><span class="n">GRS80</span> <span class="o">+</span><span class="n">datum</span><span class="o">=</span><span class="n">NAD83</span> <span class="o">+</span><span class="n">units</span><span class="o">=</span><span class="n">m</span> <span class="o">+</span><span class="n">no_defs</span>
</pre></div>
</div>
<p>In practice, both the <code class="docutils literal notranslate"><span class="pre">srtext</span></code> and the <code class="docutils literal notranslate"><span class="pre">proj4text</span></code> columns are important: the <code class="docutils literal notranslate"><span class="pre">srtext</span></code> column is used by external programs like <a class="reference external" href="http://geoserver.org">GeoServer</a>, <a class="reference external" href="udig.refractions.net">uDig</a>, and <a class="reference external" href="http://www.safe.com/">FME</a>  and others; the <code class="docutils literal notranslate"><span class="pre">proj4text</span></code> column is used internally.</p>
<div class="section" id="comparing-data">
<h3>5.10.1. Comparing Data<a class="headerlink" href="#comparing-data" title="Permalink to this headline">¶</a></h3>
<p>Taken together, a coordinate and an SRID define a location on the globe. Without an SRID, a coordinate is just an abstract notion. A “Cartesian” coordinate plane is defined as a “flat” coordinate system placed on the surface of Earth. Because PostGIS functions work on such a plane, comparison operations require that both geometries be represented in the same SRID.</p>
<p>If you feed in geometries with differing SRIDs you will just get an error:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">ST_Equals</span><span class="p">(</span>
         <span class="n">ST_GeomFromText</span><span class="p">(</span><span class="s1">&#39;POINT(0 0)&#39;</span><span class="p">,</span> <span class="mi">4326</span><span class="p">),</span>
         <span class="n">ST_GeomFromText</span><span class="p">(</span><span class="s1">&#39;POINT(0 0)&#39;</span><span class="p">,</span> <span class="mi">26918</span><span class="p">)</span>
         <span class="p">);</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ERROR</span><span class="p">:</span>  <span class="n">Operation</span> <span class="n">on</span> <span class="n">mixed</span> <span class="n">SRID</span> <span class="n">geometries</span>
<span class="n">CONTEXT</span><span class="p">:</span>  <span class="n">SQL</span> <span class="n">function</span> <span class="s2">&quot;st_equals&quot;</span> <span class="n">statement</span> <span class="mi">1</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Be careful of getting too happy with using <strong class="command">ST_Transform</strong> for on-the-fly conversion. Spatial indexes are built using SRID of the stored geometries.  If comparison are done in a different SRID, spatial indexes are (often) not used. It is best practice to choose <strong>one SRID</strong> for all the tables in your database. Only use the transformation function when you are reading or writing data to external applications.</p>
</div>
</div>
<div class="section" id="transforming-data">
<h3>5.10.2. Transforming Data<a class="headerlink" href="#transforming-data" title="Permalink to this headline">¶</a></h3>
<p>If we return to our proj4 definition for SRID 26918, we can see that our working projection is UTM (Universal Transverse Mercator) of zone 18, with meters as the unit of measurement.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">+</span><span class="n">proj</span><span class="o">=</span><span class="n">utm</span> <span class="o">+</span><span class="n">zone</span><span class="o">=</span><span class="mi">18</span> <span class="o">+</span><span class="n">ellps</span><span class="o">=</span><span class="n">GRS80</span> <span class="o">+</span><span class="n">datum</span><span class="o">=</span><span class="n">NAD83</span> <span class="o">+</span><span class="n">units</span><span class="o">=</span><span class="n">m</span> <span class="o">+</span><span class="n">no_defs</span>
</pre></div>
</div>
<p>Let’s convert some data from our working projection to geographic coordinates – also known as “longitude/latitude”.</p>
<p>To convert data from one SRID to another, you must first verify that your geometry has a valid SRID. Since we have already confirmed a valid SRID, we next need the SRID of the projection to transform into. In other words, what is the SRID of geographic coordinates?</p>
<p>The most common SRID for geographic coordinates is 4326, which corresponds to “longitude/latitude on the WGS84 spheroid”. You can see the definition at the spatialreference.org site:</p>
<blockquote>
<div><a class="reference external" href="http://spatialreference.org/ref/epsg/4326/">http://spatialreference.org/ref/epsg/4326/</a></div></blockquote>
<p>You can also pull the definitions from the <code class="docutils literal notranslate"><span class="pre">spatial_ref_sys</span></code> table:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">srtext</span> <span class="k">FROM</span> <span class="n">spatial_ref_sys</span> <span class="k">WHERE</span> <span class="n">srid</span> <span class="o">=</span> <span class="mi">4326</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">GEOGCS</span><span class="p">[</span><span class="s2">&quot;WGS 84&quot;</span><span class="p">,</span>
  <span class="n">DATUM</span><span class="p">[</span><span class="s2">&quot;WGS_1984&quot;</span><span class="p">,</span>
    <span class="n">SPHEROID</span><span class="p">[</span><span class="s2">&quot;WGS 84&quot;</span><span class="p">,</span><span class="mi">6378137</span><span class="p">,</span><span class="mf">298.257223563</span><span class="p">,</span><span class="n">AUTHORITY</span><span class="p">[</span><span class="s2">&quot;EPSG&quot;</span><span class="p">,</span><span class="s2">&quot;7030&quot;</span><span class="p">]],</span>
    <span class="n">AUTHORITY</span><span class="p">[</span><span class="s2">&quot;EPSG&quot;</span><span class="p">,</span><span class="s2">&quot;6326&quot;</span><span class="p">]],</span>
  <span class="n">PRIMEM</span><span class="p">[</span><span class="s2">&quot;Greenwich&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">AUTHORITY</span><span class="p">[</span><span class="s2">&quot;EPSG&quot;</span><span class="p">,</span><span class="s2">&quot;8901&quot;</span><span class="p">]],</span>
  <span class="n">UNIT</span><span class="p">[</span><span class="s2">&quot;degree&quot;</span><span class="p">,</span><span class="mf">0.01745329251994328</span><span class="p">,</span><span class="n">AUTHORITY</span><span class="p">[</span><span class="s2">&quot;EPSG&quot;</span><span class="p">,</span><span class="s2">&quot;9122&quot;</span><span class="p">]],</span>
  <span class="n">AUTHORITY</span><span class="p">[</span><span class="s2">&quot;EPSG&quot;</span><span class="p">,</span><span class="s2">&quot;4326&quot;</span><span class="p">]]</span>
</pre></div>
</div>
<p>Let’s convert the coordinates of the ‘Broad St’ subway station into geographics:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">ST_AsText</span><span class="p">(</span><span class="n">ST_Transform</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span><span class="mi">4326</span><span class="p">))</span>
<span class="k">FROM</span> <span class="n">nyc_subway_stations</span>
<span class="k">WHERE</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Broad St&#39;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">POINT</span><span class="p">(</span><span class="o">-</span><span class="mf">74.0106714688735</span> <span class="mf">40.7071048155841</span><span class="p">)</span>
</pre></div>
</div>
<p>If you load data or create a new geometry without specifying an SRID, the SRID value will be 0.  Recall in <a class="reference internal" href="geometries.html#geometries"><span class="std std-ref">Geometries</span></a>, that when we created our <code class="docutils literal notranslate"><span class="pre">geometries</span></code> table we didn’t specify an SRID. If we query our database, we should expect all the <code class="docutils literal notranslate"><span class="pre">nyc_</span></code> tables to have an SRID of 26918, while  the <code class="docutils literal notranslate"><span class="pre">geometries</span></code> table defaulted to an SRID of 0.</p>
<p>To view a table’s SRID assignment, query the database’s <code class="docutils literal notranslate"><span class="pre">geometry_columns</span></code> table.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">f_table_name</span> <span class="k">AS</span> <span class="n">name</span><span class="p">,</span> <span class="n">srid</span>
<span class="k">FROM</span> <span class="n">geometry_columns</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>        <span class="n">name</span>         <span class="o">|</span> <span class="n">srid</span>
<span class="o">---------------------+-------</span>
 <span class="n">nyc_census_blocks</span>   <span class="o">|</span> <span class="mi">26918</span>
 <span class="n">nyc_neighborhoods</span>   <span class="o">|</span> <span class="mi">26918</span>
 <span class="n">nyc_streets</span>         <span class="o">|</span> <span class="mi">26918</span>
 <span class="n">nyc_subway_stations</span> <span class="o">|</span> <span class="mi">26918</span>
 <span class="n">geometries</span>          <span class="o">|</span>     <span class="mi">0</span>
</pre></div>
</div>
<p>However, if you know what the SRID of the coordinates is supposed to be, you can set it post-facto, using <strong class="command">ST_SetSRID</strong> on the geometry. Then you will be able to transform the geometry into other systems.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">ST_AsText</span><span class="p">(</span>
 <span class="n">ST_Transform</span><span class="p">(</span>
   <span class="n">ST_SetSRID</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span><span class="mi">26918</span><span class="p">),</span>
 <span class="mi">4326</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">FROM</span> <span class="n">geometries</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="id23">
<h3>5.10.3. Function List<a class="headerlink" href="#id23" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://postgis.net/docs/ST_AsText.html">ST_AsText</a>: Returns the Well-Known Text (WKT) representation of the geometry/geography without SRID metadata.</p>
<p><a class="reference external" href="http://postgis.net/docs/ST_SetSRID.html">ST_SetSRID(geometry, srid)</a>: Sets the SRID on a geometry to a particular integer value.</p>
<p><a class="reference external" href="http://postgis.net/docs/ST_SRID.html">ST_SRID(geometry)</a>: Returns the spatial reference identifier for the ST_Geometry as defined in spatial_ref_sys table.</p>
<p><a class="reference external" href="http://postgis.net/docs/ST_Transform.html">ST_Transform(geometry, srid)</a>: Returns a new geometry with its coordinates transformed to the SRID referenced by the integer parameter.</p>
</div>
</div>
<div class="section" id="projection-exercises">
<span id="id25"></span><h2>5.11. Projection Exercises<a class="headerlink" href="#projection-exercises" title="Permalink to this headline">¶</a></h2>
<p>Here’s a reminder of some of the functions we have seen.  Hint: they should be useful for the exercises!</p>
<ul class="simple">
<li><strong class="command">sum(expression)</strong> aggregate to return a sum for a set of records</li>
<li><strong class="command">ST_Length(linestring)</strong> returns the length of the linestring</li>
<li><strong class="command">ST_SRID(geometry, srid)</strong> returns the SRID of the geometry</li>
<li><strong class="command">ST_Transform(geometry, srid)</strong> converts geometries into different spatial reference systems</li>
<li><strong class="command">ST_GeomFromText(text)</strong> returns <code class="docutils literal notranslate"><span class="pre">geometry</span></code></li>
<li><strong class="command">ST_AsText(geometry)</strong> returns WKT <code class="docutils literal notranslate"><span class="pre">text</span></code></li>
<li><strong class="command">ST_AsGML(geometry)</strong> returns GML <code class="docutils literal notranslate"><span class="pre">text</span></code></li>
</ul>
<p>Remember the online resources that are available to you:</p>
<ul class="simple">
<li><a class="reference external" href="http://spatialreference.org">http://spatialreference.org</a></li>
<li><a class="reference external" href="http://prj2epsg.org">http://prj2epsg.org</a></li>
</ul>
<p>Also remember the tables we have available:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">nyc_census_blocks</span></code><ul>
<li>name, popn_total, boroname, geom</li>
</ul>
</li>
<li><code class="docutils literal notranslate"><span class="pre">nyc_streets</span></code><ul>
<li>name, type, geom</li>
</ul>
</li>
<li><code class="docutils literal notranslate"><span class="pre">nyc_subway_stations</span></code><ul>
<li>name, geom</li>
</ul>
</li>
<li><code class="docutils literal notranslate"><span class="pre">nyc_neighborhoods</span></code><ul>
<li>name, boroname, geom</li>
</ul>
</li>
</ul>
<div class="section" id="id26">
<h3>5.11.1. Exercises<a class="headerlink" href="#id26" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p class="first"><strong>“What is the length of all streets in New York, as measured in UTM 18?”</strong></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="k">Sum</span><span class="p">(</span><span class="n">ST_Length</span><span class="p">(</span><span class="n">geom</span><span class="p">))</span>
  <span class="k">FROM</span> <span class="n">nyc_streets</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">10418904.7172</span>
</pre></div>
</div>
</li>
<li><p class="first"><strong>“What is the WKT definition of SRID 2831?”</strong></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">srtext</span> <span class="k">FROM</span> <span class="n">spatial_ref_sys</span>
<span class="k">WHERE</span> <span class="n">SRID</span> <span class="o">=</span> <span class="mi">2831</span><span class="p">;</span>
</pre></div>
</div>
<p>Or, via <a class="reference external" href="http://prj2epsg.org/epsg/2831">prj2epsg</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PROJCS</span><span class="p">[</span><span class="s2">&quot;NAD83(HARN) / New York Long Island&quot;</span><span class="p">,</span>
  <span class="n">GEOGCS</span><span class="p">[</span><span class="s2">&quot;NAD83(HARN)&quot;</span><span class="p">,</span>
    <span class="n">DATUM</span><span class="p">[</span><span class="s2">&quot;NAD83 (High Accuracy Regional Network)&quot;</span><span class="p">,</span>
      <span class="n">SPHEROID</span><span class="p">[</span><span class="s2">&quot;GRS 1980&quot;</span><span class="p">,</span> <span class="mf">6378137.0</span><span class="p">,</span> <span class="mf">298.257222101</span><span class="p">,</span>
        <span class="n">AUTHORITY</span><span class="p">[</span><span class="s2">&quot;EPSG&quot;</span><span class="p">,</span><span class="s2">&quot;7019&quot;</span><span class="p">]],</span>
      <span class="n">TOWGS84</span><span class="p">[</span><span class="o">-</span><span class="mf">0.991</span><span class="p">,</span> <span class="mf">1.9072</span><span class="p">,</span> <span class="mf">0.5129</span><span class="p">,</span> <span class="mf">0.0257899075194932</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.009650098960270402</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.011659943232342112</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
      <span class="n">AUTHORITY</span><span class="p">[</span><span class="s2">&quot;EPSG&quot;</span><span class="p">,</span><span class="s2">&quot;6152&quot;</span><span class="p">]],</span>
    <span class="n">PRIMEM</span><span class="p">[</span><span class="s2">&quot;Greenwich&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span>
      <span class="n">AUTHORITY</span><span class="p">[</span><span class="s2">&quot;EPSG&quot;</span><span class="p">,</span><span class="s2">&quot;8901&quot;</span><span class="p">]],</span>
    <span class="n">UNIT</span><span class="p">[</span><span class="s2">&quot;degree&quot;</span><span class="p">,</span> <span class="mf">0.017453292519943295</span><span class="p">],</span>
    <span class="n">AXIS</span><span class="p">[</span><span class="s2">&quot;Geodetic longitude&quot;</span><span class="p">,</span> <span class="n">EAST</span><span class="p">],</span>
    <span class="n">AXIS</span><span class="p">[</span><span class="s2">&quot;Geodetic latitude&quot;</span><span class="p">,</span> <span class="n">NORTH</span><span class="p">],</span>
    <span class="n">AUTHORITY</span><span class="p">[</span><span class="s2">&quot;EPSG&quot;</span><span class="p">,</span><span class="s2">&quot;4152&quot;</span><span class="p">]],</span>
  <span class="n">PROJECTION</span><span class="p">[</span><span class="s2">&quot;Lambert Conic Conformal (2SP)&quot;</span><span class="p">,</span>
    <span class="n">AUTHORITY</span><span class="p">[</span><span class="s2">&quot;EPSG&quot;</span><span class="p">,</span><span class="s2">&quot;9802&quot;</span><span class="p">]],</span>
  <span class="n">PARAMETER</span><span class="p">[</span><span class="s2">&quot;central_meridian&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mf">74.0</span><span class="p">],</span>
  <span class="n">PARAMETER</span><span class="p">[</span><span class="s2">&quot;latitude_of_origin&quot;</span><span class="p">,</span> <span class="mf">40.166666666666664</span><span class="p">],</span>
  <span class="n">PARAMETER</span><span class="p">[</span><span class="s2">&quot;standard_parallel_1&quot;</span><span class="p">,</span> <span class="mf">41.03333333333333</span><span class="p">],</span>
  <span class="n">PARAMETER</span><span class="p">[</span><span class="s2">&quot;false_easting&quot;</span><span class="p">,</span> <span class="mf">300000.0</span><span class="p">],</span>
  <span class="n">PARAMETER</span><span class="p">[</span><span class="s2">&quot;false_northing&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
  <span class="n">PARAMETER</span><span class="p">[</span><span class="s2">&quot;scale_factor&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
  <span class="n">PARAMETER</span><span class="p">[</span><span class="s2">&quot;standard_parallel_2&quot;</span><span class="p">,</span> <span class="mf">40.666666666666664</span><span class="p">],</span>
  <span class="n">UNIT</span><span class="p">[</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
  <span class="n">AXIS</span><span class="p">[</span><span class="s2">&quot;Easting&quot;</span><span class="p">,</span> <span class="n">EAST</span><span class="p">],</span>
  <span class="n">AXIS</span><span class="p">[</span><span class="s2">&quot;Northing&quot;</span><span class="p">,</span> <span class="n">NORTH</span><span class="p">],</span>
  <span class="n">AUTHORITY</span><span class="p">[</span><span class="s2">&quot;EPSG&quot;</span><span class="p">,</span><span class="s2">&quot;2831&quot;</span><span class="p">]]</span>
</pre></div>
</div>
</li>
<li><p class="first"><strong>“What is the length of all streets in New York, as measured in SRID 2831?”</strong></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="k">Sum</span><span class="p">(</span><span class="n">ST_Length</span><span class="p">(</span><span class="n">ST_Transform</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span><span class="mi">2831</span><span class="p">)))</span>
  <span class="k">FROM</span> <span class="n">nyc_streets</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">10421993.7063767</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The difference between the UTM 18 and the State Plane Long Island measurements is (10421993 - 10418904)/10418904, or 0.02%. Calculated on the spheroid using <a class="reference internal" href="geography.html#geography"><span class="std std-ref">Geography</span></a> the total street length is 10421999, which is closer to the State Plane value. This is not surprising, since the State Plane Long Island projection is precisely calibrated for a very small area (New York City) while UTM 18 has to provide reasonable results for a large regional area.</p>
</div>
</li>
<li><p class="first"><strong>“What is the KML representation of the point at ‘Broad St’ subway station?”</strong></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">ST_AsKML</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">nyc_subway_stations</span>
<span class="k">WHERE</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Broad St&#39;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">Point</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">coordinates</span><span class="o">&gt;</span>
    <span class="o">-</span><span class="mf">74.010671468873412</span><span class="p">,</span><span class="mf">40.707104815587613</span>
  <span class="o">&lt;/</span><span class="n">coordinates</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">Point</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Hey! The coordinates are in geographics even though we didn’t call <strong class="command">ST_Transform</strong>, why? Because the KML standard dictates that all coordinates <em>must</em> be in geographics (ESPG:4326, in fact) so the <strong class="command">ST_AsKML</strong> function does the transformation automatically.</p>
</li>
</ul>
</div>
</div>
<div class="section" id="geography">
<span id="id27"></span><h2>5.12. Geography<a class="headerlink" href="#geography" title="Permalink to this headline">¶</a></h2>
<p>It is very common to have data in which the coordinate are “geographics” or “latitude/longitude”.</p>
<p>Unlike coordinates in Mercator, UTM, or Stateplane, geographic coordinates are <strong>not Cartesian coordinates</strong>. Geographic coordinates do not represent a linear distance from an origin as plotted on a plane.  Rather, these <strong>spherical coordinates</strong> describe angular coordinates on a globe. In spherical coordinates a point is specified by the angle of rotation from a reference meridian (longitude), and the angle from the equator (latitude).</p>
<img alt="_images/cartesian_spherical.jpg" class="inline" src="_images/cartesian_spherical.jpg" />
<p>You can treat geographic coordinates as approximate Cartesian coordinates and continue to do spatial calculations. However, measurements of distance, length and area will be nonsensical. Since spherical coordinates measure <strong>angular</strong> distance, the units are in “degrees.” Further, the approximate results from indexes and true/false tests like intersects and contains can become terribly wrong. The distance between points get larger as problem areas like the poles or the international dateline are approached.</p>
<p>For example, here are the coordinates of Los Angeles and Paris.</p>
<ul class="simple">
<li>Los Angeles: <code class="docutils literal notranslate"><span class="pre">POINT(-118.4079</span> <span class="pre">33.9434)</span></code></li>
<li>Paris: <code class="docutils literal notranslate"><span class="pre">POINT(2.3490</span> <span class="pre">48.8533)</span></code></li>
</ul>
<p>The following calculates the distance between Los Angeles and Paris using the standard PostGIS Cartesian <strong class="command">ST_Distance(geometry, geometry)</strong>.  Note that the SRID of 4326 declares a geographic spatial reference system.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">ST_Distance</span><span class="p">(</span>
  <span class="n">ST_GeometryFromText</span><span class="p">(</span><span class="s1">&#39;POINT(-118.4079 33.9434)&#39;</span><span class="p">,</span> <span class="mi">4326</span><span class="p">),</span> <span class="c1">-- Los Angeles (LAX)</span>
  <span class="n">ST_GeometryFromText</span><span class="p">(</span><span class="s1">&#39;POINT(2.5559 49.0083)&#39;</span><span class="p">,</span> <span class="mi">4326</span><span class="p">)</span>     <span class="c1">-- Paris (CDG)</span>
  <span class="p">);</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">121.898285970107</span>
</pre></div>
</div>
<p>Aha! 121! But, what does that mean?</p>
<p>The units for spatial reference 4326 are degrees. So our answer is 121 degrees. But (again), what does that mean?</p>
<p>On a sphere, the size of one “degree square” is quite variable, becoming smaller as you move away from the equator. Think of the meridians (vertical lines) on the globe getting closer to each other as you go towards the poles. So, a distance of 121 degrees doesn’t <em>mean</em> anything. It is a nonsense number.</p>
<p>In order to calculate a meaningful distance, we must treat geographic coordinates not as approximate Cartesian coordinates but rather as true spherical coordinates.  We must measure the distances between points as true paths over a sphere – a portion of a great circle.</p>
<p>Starting with version 1.5, PostGIS provides this functionality through the <code class="docutils literal notranslate"><span class="pre">geography</span></code> type.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Different spatial databases have different approaches for “handling geographics”</p>
<ul class="last simple">
<li>Oracle attempts to paper over the differences by transparently doing geographic calculations when the SRID is geographic.</li>
<li>SQL Server uses two spatial types, “STGeometry” for Cartesian data and “STGeography” for geographics.</li>
<li>Informix Spatial is a pure Cartesian extension to Informix, while Informix Geodetic is a pure geographic extension.</li>
<li>Similar to SQL Server, PostGIS uses two types, “geometry” and “geography”.</li>
</ul>
</div>
<p>Using the <code class="docutils literal notranslate"><span class="pre">geography</span></code> instead of <code class="docutils literal notranslate"><span class="pre">geometry</span></code> type, let’s try again to measure the distance between Los Angeles and Paris. Instead of <strong class="command">ST_GeometryFromText(text)</strong>, we will use <strong class="command">ST_GeographyFromText(text)</strong>.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">ST_Distance</span><span class="p">(</span>
  <span class="n">ST_GeographyFromText</span><span class="p">(</span><span class="s1">&#39;POINT(-118.4079 33.9434)&#39;</span><span class="p">),</span> <span class="c1">-- Los Angeles (LAX)</span>
  <span class="n">ST_GeographyFromText</span><span class="p">(</span><span class="s1">&#39;POINT(2.5559 49.0083)&#39;</span><span class="p">)</span>     <span class="c1">-- Paris (CDG)</span>
  <span class="p">);</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">9124665.27317673</span>
</pre></div>
</div>
<p>A big number! All return values from <code class="docutils literal notranslate"><span class="pre">geography</span></code> calculations are in meters, so our answer is 9124km.</p>
<p>Older versions of PostGIS supported very basic calculations over the sphere using the <strong class="command">ST_Distance_Spheroid(point, point, measurement)</strong> function. However, <strong class="command">ST_Distance_Spheroid</strong> is substantially limited. The function only works on points and provides no support for indexing across the poles or international dateline.</p>
<p>The need to support non-point geometries becomes very clear when posing a question like “How close will a flight from Los Angeles to Paris come to Iceland?”</p>
<img alt="_images/lax_cdg.jpg" src="_images/lax_cdg.jpg" />
<p>Working with geographic coordinates on a Cartesian plane (the purple line) yields a <em>very</em> wrong answer indeed! Using great circle routes (the red lines) gives the right answer. If we convert our LAX-CDG flight into a line string and calculate the distance to a point in Iceland using <code class="docutils literal notranslate"><span class="pre">geography</span></code> we’ll get the right answer (recall) in meters.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">ST_Distance</span><span class="p">(</span>
  <span class="n">ST_GeographyFromText</span><span class="p">(</span><span class="s1">&#39;LINESTRING(-118.4079 33.9434, 2.5559 49.0083)&#39;</span><span class="p">),</span> <span class="c1">-- LAX-CDG</span>
  <span class="n">ST_GeographyFromText</span><span class="p">(</span><span class="s1">&#39;POINT(-22.6056 63.9850)&#39;</span><span class="p">)</span>                        <span class="c1">-- Iceland (KEF)</span>
<span class="p">);</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">502454.90667289</span>
</pre></div>
</div>
<p>So the closest approach to Iceland (as measured from its international airport) on the LAX-CDG route is a relatively small 502km.</p>
<p>The Cartesian approach to handling geographic coordinates breaks down entirely for features that cross the international dateline. The shortest great-circle route from Los Angeles to Tokyo crosses the Pacific Ocean. The shortest Cartesian route crosses the Atlantic and Indian Oceans.</p>
<img alt="_images/lax_nrt.png" src="_images/lax_nrt.png" />
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">ST_Distance</span><span class="p">(</span>
  <span class="n">ST_GeometryFromText</span><span class="p">(</span><span class="s1">&#39;Point(-118.4079 33.9434)&#39;</span><span class="p">),</span>  <span class="c1">-- LAX</span>
  <span class="n">ST_GeometryFromText</span><span class="p">(</span><span class="s1">&#39;Point(139.733 35.567)&#39;</span><span class="p">))</span>     <span class="c1">-- NRT (Tokyo/Narita)</span>
    <span class="k">AS</span> <span class="n">geometry_distance</span><span class="p">,</span>
<span class="n">ST_Distance</span><span class="p">(</span>
  <span class="n">ST_GeographyFromText</span><span class="p">(</span><span class="s1">&#39;Point(-118.4079 33.9434)&#39;</span><span class="p">),</span> <span class="c1">-- LAX</span>
  <span class="n">ST_GeographyFromText</span><span class="p">(</span><span class="s1">&#39;Point(139.733 35.567)&#39;</span><span class="p">))</span>    <span class="c1">-- NRT (Tokyo/Narita)</span>
    <span class="k">AS</span> <span class="n">geography_distance</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">geometry_distance</span> <span class="o">|</span> <span class="n">geography_distance</span>
<span class="o">-------------------+--------------------</span>
  <span class="mf">258.146005837336</span> <span class="o">|</span>   <span class="mf">8833954.77277118</span>
</pre></div>
</div>
<div class="section" id="using-geography">
<h3>5.12.1. Using Geography<a class="headerlink" href="#using-geography" title="Permalink to this headline">¶</a></h3>
<p>In order to load geometry data into a geography table, the geometry first needs to be projected into EPSG:4326 (longitude/latitude), then it needs to be changed into geography.  The <strong class="command">ST_Transform(geometry,srid)</strong> function converts coordinates to geographics and the <strong class="command">Geography(geometry)</strong> function “casts” them from geometry to geography.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">nyc_subway_stations_geog</span> <span class="k">AS</span>
<span class="k">SELECT</span>
  <span class="n">Geography</span><span class="p">(</span><span class="n">ST_Transform</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span><span class="mi">4326</span><span class="p">))</span> <span class="k">AS</span> <span class="n">geog</span><span class="p">,</span>
  <span class="n">name</span><span class="p">,</span>
  <span class="n">routes</span>
<span class="k">FROM</span> <span class="n">nyc_subway_stations</span><span class="p">;</span>
</pre></div>
</div>
<p>Building a spatial index on a geography table is exactly the same as for geometry:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">sidx_nyc_subway_stations_geog</span>
<span class="k">ON</span> <span class="n">nyc_subway_stations_geog</span> <span class="k">USING</span> <span class="n">GIST</span> <span class="p">(</span><span class="n">geog</span><span class="p">);</span>
</pre></div>
</div>
<p>The difference is under the covers: the geography index type provides native support for spatial features represented on “geographic” coordinates (sometimes called “geodetic” coordinates, or “lat/lon”, or “lon/lat”). Geographic coordinates are spherical coordinates expressed in angular units (degrees) and will correctly handle queries that cover the poles or the international date-line, while the geometry one will not, since the basis for the PostGIS geometry type is a plane. The shortest path between two points on the plane is a straight line. That means calculations on geometries (areas, distances, lengths, intersections, etc) can be calculated using cartesian mathematics and straight line vectors. Not so useful for spherical (pole to pole distances).</p>
<p>There are only a small number of native functions for the geography type:</p>
<ul class="simple">
<li><strong class="command">ST_AsText(geography)</strong> returns <code class="docutils literal notranslate"><span class="pre">text</span></code></li>
<li><strong class="command">ST_GeographyFromText(text)</strong> returns <code class="docutils literal notranslate"><span class="pre">geography</span></code></li>
<li><strong class="command">ST_AsBinary(geography)</strong> returns <code class="docutils literal notranslate"><span class="pre">bytea</span></code></li>
<li><strong class="command">ST_GeogFromWKB(bytea)</strong> returns <code class="docutils literal notranslate"><span class="pre">geography</span></code></li>
<li><strong class="command">ST_AsSVG(geography)</strong> returns <code class="docutils literal notranslate"><span class="pre">text</span></code></li>
<li><strong class="command">ST_AsGML(geography)</strong> returns <code class="docutils literal notranslate"><span class="pre">text</span></code></li>
<li><strong class="command">ST_AsKML(geography)</strong> returns <code class="docutils literal notranslate"><span class="pre">text</span></code></li>
<li><strong class="command">ST_AsGeoJson(geography)</strong> returns <code class="docutils literal notranslate"><span class="pre">text</span></code></li>
<li><strong class="command">ST_Distance(geography, geography)</strong> returns <code class="docutils literal notranslate"><span class="pre">double</span></code></li>
<li><strong class="command">ST_DWithin(geography, geography, float8)</strong> returns <code class="docutils literal notranslate"><span class="pre">boolean</span></code></li>
<li><strong class="command">ST_Area(geography)</strong> returns <code class="docutils literal notranslate"><span class="pre">double</span></code></li>
<li><strong class="command">ST_Length(geography)</strong> returns <code class="docutils literal notranslate"><span class="pre">double</span></code></li>
<li><strong class="command">ST_Covers(geography, geography)</strong> returns <code class="docutils literal notranslate"><span class="pre">boolean</span></code></li>
<li><strong class="command">ST_CoveredBy(geography, geography)</strong> returns <code class="docutils literal notranslate"><span class="pre">boolean</span></code></li>
<li><strong class="command">ST_Intersects(geography, geography)</strong> returns <code class="docutils literal notranslate"><span class="pre">boolean</span></code></li>
<li><strong class="command">ST_Buffer(geography, float8)</strong> returns <code class="docutils literal notranslate"><span class="pre">geography</span></code> <a class="footnote-reference" href="#casting-note" id="id28">[3]</a></li>
<li><strong class="command">ST_Intersection(geography, geography)</strong> returns <code class="docutils literal notranslate"><span class="pre">geography</span></code> <a class="footnote-reference" href="#casting-note" id="id29">[3]</a></li>
</ul>
</div>
<div class="section" id="creating-a-geography-table">
<h3>5.12.2. Creating a Geography Table<a class="headerlink" href="#creating-a-geography-table" title="Permalink to this headline">¶</a></h3>
<p>The SQL for creating a new table with a geography column is much like that for creating a geometry table. For example:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">airports</span> <span class="p">(</span>
  <span class="n">code</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
  <span class="n">geog</span> <span class="n">GEOGRAPHY</span><span class="p">(</span><span class="n">Point</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">airports</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;LAX&#39;</span><span class="p">,</span> <span class="s1">&#39;POINT(-118.4079 33.9434)&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">airports</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;CDG&#39;</span><span class="p">,</span> <span class="s1">&#39;POINT(2.5559 49.0083)&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">airports</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;KEF&#39;</span><span class="p">,</span> <span class="s1">&#39;POINT(-22.6056 63.9850)&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>In the table definition, the <code class="docutils literal notranslate"><span class="pre">GEOGRAPHY(Point)</span></code> specifies our airport data type as points. The new geography fields don’t get registered in the <code class="docutils literal notranslate"><span class="pre">geometry_columns</span></code> view. Instead, they are registered in a view called <code class="docutils literal notranslate"><span class="pre">geography_columns</span></code>.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">geography_columns</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>          <span class="n">f_table_name</span>    <span class="o">|</span> <span class="n">f_geography_column</span> <span class="o">|</span> <span class="n">srid</span> <span class="o">|</span>   <span class="nb">type</span>
<span class="o">--------------------------+--------------------+------+----------</span>
 <span class="n">nyc_subway_stations_geog</span> <span class="o">|</span> <span class="n">geog</span>               <span class="o">|</span>    <span class="mi">0</span> <span class="o">|</span> <span class="n">Geometry</span>
 <span class="n">airports</span>                 <span class="o">|</span> <span class="n">geog</span>               <span class="o">|</span> <span class="mi">4326</span> <span class="o">|</span> <span class="n">Point</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Some columns were omitted from the above output.</p>
</div>
</div>
<div class="section" id="casting-to-geometry">
<h3>5.12.3. Casting to Geometry<a class="headerlink" href="#casting-to-geometry" title="Permalink to this headline">¶</a></h3>
<p>While the basic functions for geography types can handle many use cases, there are times when you might need access to other functions only supported by the geometry type. Fortunately, you can convert objects back and forth from geography to geometry.</p>
<p>The PostgreSQL syntax convention for casting is to append <code class="docutils literal notranslate"><span class="pre">::typename</span></code> to the end of the value you wish to cast. So, <code class="docutils literal notranslate"><span class="pre">2::text</span></code> with convert a numeric two to a text string ‘2’. And <code class="docutils literal notranslate"><span class="pre">'POINT(0</span> <span class="pre">0)'::geometry</span></code> will convert the text representation of point into a geometry point.</p>
<p>The <strong class="command">ST_X(point)</strong> function only supports the geometry type. How can we read the X coordinate from our geographies?</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">code</span><span class="p">,</span> <span class="n">ST_X</span><span class="p">(</span><span class="n">geog</span><span class="p">::</span><span class="n">geometry</span><span class="p">)</span> <span class="k">AS</span> <span class="n">longitude</span> <span class="k">FROM</span> <span class="n">airports</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">code</span> <span class="o">|</span> <span class="n">longitude</span>
<span class="o">------+-----------</span>
 <span class="n">LAX</span>  <span class="o">|</span> <span class="o">-</span><span class="mf">118.4079</span>
 <span class="n">CDG</span>  <span class="o">|</span>    <span class="mf">2.5559</span>
 <span class="n">KEF</span>  <span class="o">|</span>  <span class="o">-</span><span class="mf">22.6056</span>
</pre></div>
</div>
<p>By appending <code class="docutils literal notranslate"><span class="pre">::geometry</span></code> to our geography value, we convert the object to a geometry with an SRID of 4326. From there we can use as many geometry functions as strike our fancy. But, remember – now that our object is a geometry, the coordinates will be interpretted as Cartesian coordinates, not spherical ones.</p>
</div>
<div class="section" id="why-not-use-geography">
<h3>5.12.4. Why (Not) Use Geography<a class="headerlink" href="#why-not-use-geography" title="Permalink to this headline">¶</a></h3>
<p>Geographics are universally accepted coordinates – everyone understands what latitude/longitude mean, but very few people understand what UTM coordinates mean. Why not use geography all the time?</p>
<ul class="simple">
<li>First, as noted earlier, there are far fewer functions available (right now) that directly support the geography type. You may spend a lot of time working around geography type limitations.</li>
<li>Second, the calculations on a sphere are computationally far more expensive than Cartesian calculations. For example, the Cartesian formula for distance (Pythagoras) involves one call to sqrt(). The spherical formula for distance (Haversine) involves two sqrt() calls, an arctan() call, four sin() calls and two cos() calls. Trigonometric functions are very costly, and spherical calculations involve a lot of them.</li>
</ul>
<p>The conclusion?</p>
<p><strong>If your data is geographically compact</strong> (contained within a state, county or city), <strong>use the geometry type with a Cartesian projection</strong> that makes sense with your data. See the <a class="reference external" href="http://spatialreference.org">http://spatialreference.org</a> site and type in the name of your region for a selection of possible reference systems.</p>
<p><strong>If you need to measure distance with a dataset that is geographically dispersed</strong> (covering much of the world), <strong>use the geography type.</strong> The application complexity you save by working in <code class="docutils literal notranslate"><span class="pre">geography</span></code> will offset any performance issues. And casting to <code class="docutils literal notranslate"><span class="pre">geometry</span></code> can offset most functionality limitations.</p>
</div>
<div class="section" id="id30">
<h3>5.12.5. Function List<a class="headerlink" href="#id30" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://postgis.net/docs/ST_Distance.html">ST_Distance(geometry, geometry)</a>: For geometry type Returns the 2-dimensional Cartesian minimum distance (based on spatial ref) between two geometries in projected units. For geography type defaults to return spheroidal minimum distance between two geographies in meters.</p>
<p><a class="reference external" href="http://postgis.net/docs/ST_GeographyFromText.html">ST_GeographyFromText(text)</a>: Returns a specified geography value from Well-Known Text representation or extended (WKT).</p>
<p><a class="reference external" href="http://postgis.net/docs/ST_Transform.html">ST_Transform(geometry, srid)</a>: Returns a new geometry with its coordinates transformed to the SRID referenced by the integer parameter.</p>
<p><a class="reference external" href="http://postgis.net/docs/ST_X.html">ST_X(point)</a>: Returns the X coordinate of the point, or NULL if not available. Input must be a point.</p>
<p class="rubric">Footnotes</p>
<table class="docutils footnote" frame="void" id="casting-note" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[3]</td><td><em>(<a class="fn-backref" href="#id28">1</a>, <a class="fn-backref" href="#id29">2</a>)</em> <p>The buffer and intersection functions are actually wrappers on top of a cast to geometry, and are not carried out natively in spherical coordinates. As a result, they may fail to return correct results for objects with very large extents that cannot be cleanly converted to a planar representation.</p>
<p class="last">For example, the <strong class="command">ST_Buffer(geography,distance)</strong> function transforms the geography object into a “best” projection, buffers it, and then transforms it back to geographics. If there is no “best” projection (the object is too large), the operation can fail or return a malformed buffer.</p>
</td></tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="geometry-constructing-functions">
<span id="geometry-returning"></span><h2>5.13. Geometry Constructing Functions<a class="headerlink" href="#geometry-constructing-functions" title="Permalink to this headline">¶</a></h2>
<p>All the functions we have seen so far work with geometries “as they are” and returns</p>
<ul class="simple">
<li>analyses of the objects (<strong class="command">ST_Length(geometry)</strong>, <strong class="command">ST_Area(geometry)</strong>),</li>
<li>serializations of the objects (<strong class="command">ST_AsText(geometry)</strong>, <strong class="command">ST_AsGML(geometry)</strong>),</li>
<li>parts of the object (<strong class="command">ST_RingN(geometry,n)</strong>) or</li>
<li>true/false tests (<strong class="command">ST_Contains(geometry,geometry)</strong>, <strong class="command">ST_Intersects(geometry,geometry)</strong>).</li>
</ul>
<p>“Geometry constructing functions” take geometries as inputs and output new shapes.</p>
<div class="section" id="st-centroid-st-pointonsurface">
<h3>5.13.1. ST_Centroid / ST_PointOnSurface<a class="headerlink" href="#st-centroid-st-pointonsurface" title="Permalink to this headline">¶</a></h3>
<p>A common need when composing a spatial query is to replace a polygon feature with a point representation of the feature. This is useful for spatial joins (as discussed in <a class="reference internal" href="joins_advanced.html#polypolyjoins"><span class="std std-ref">Polygon/Polygon Joins</span></a>) because using <strong class="command">ST_Intersects(geometry,geometry)</strong> on two polygon layers often results in double-counting: a polygon on a boundary will intersect an object on both sides; replacing it with a point forces it to be on one side or the other, not both.</p>
<ul class="simple">
<li><strong class="command">ST_Centroid(geometry)</strong> returns a point that is approximately on the center of mass of the input argument. This simple calculation is very fast, but sometimes not desirable, because the returned point is not necessarily in the feature itself. If the input feature has a convexity (imagine the letter ‘C’) the returned centroid might not be in the interior of the feature.</li>
<li><strong class="command">ST_PointOnSurface(geometry)</strong> returns a point that is guaranteed to be inside the input argument. It is substantially more computationally expensive than the centroid operation.</li>
</ul>
<img alt="_images/centroid.jpg" class="inline" src="_images/centroid.jpg" />
</div>
<div class="section" id="st-buffer">
<h3>5.13.2. ST_Buffer<a class="headerlink" href="#st-buffer" title="Permalink to this headline">¶</a></h3>
<p>The buffering operation is common in GIS workflows, and is also available in PostGIS. <strong class="command">ST_Buffer(geometry,distance)</strong> takes in a buffer distance and geometry type and outputs a polygon with a boundary the buffer distance away from the input geometry.</p>
<img alt="_images/st_buffer.png" class="inline" src="_images/st_buffer.png" />
<p>For example, if the US Park Service wanted to enforce a marine traffic zone around Liberty Island, they might build a 500 meter buffer polygon around the island. Liberty Island is a single census block in our <code class="docutils literal notranslate"><span class="pre">nyc_census_blocks</span></code> table, so we can easily extract and buffer it.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Make a new table with a Liberty Island 500m buffer zone</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">liberty_island_zone</span> <span class="k">AS</span>
<span class="k">SELECT</span> <span class="n">ST_Buffer</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span><span class="mi">500</span><span class="p">)::</span><span class="n">geometry</span><span class="p">(</span><span class="n">Polygon</span><span class="p">,</span><span class="mi">26918</span><span class="p">)</span> <span class="k">AS</span> <span class="n">geom</span>
<span class="k">FROM</span> <span class="n">nyc_census_blocks</span>
<span class="k">WHERE</span> <span class="n">blkid</span> <span class="o">=</span> <span class="s1">&#39;360610001001001&#39;</span><span class="p">;</span>
</pre></div>
</div>
<img alt="_images/liberty_positive.jpg" class="inline" src="_images/liberty_positive.jpg" />
<p>The <strong class="command">ST_Buffer</strong> function also accepts negative distances and builds inscribed polygons within polygonal inputs. For lines and points you will just get an empty return.</p>
<img alt="_images/liberty_negative.jpg" class="inline" src="_images/liberty_negative.jpg" />
</div>
<div class="section" id="st-intersection">
<h3>5.13.3. ST_Intersection<a class="headerlink" href="#st-intersection" title="Permalink to this headline">¶</a></h3>
<p>Another classic GIS operation – the “overlay” – creates a new coverage by calculating the intersection of two superimposed polygons. The resultant has the property that any polygon in either of the parents can be built by merging polygons in the resultant.</p>
<p>The <strong class="command">ST_Intersection(geometry A, geometry B)</strong> function returns the spatial area (or line, or point) that both arguments have in common. If the arguments are disjoint, the function returns an empty geometry.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- What is the area these two circles have in common?</span>
<span class="c1">-- Using ST_Buffer to make the circles!</span>

<span class="k">SELECT</span> <span class="n">ST_AsText</span><span class="p">(</span><span class="n">ST_Intersection</span><span class="p">(</span>
  <span class="n">ST_Buffer</span><span class="p">(</span><span class="s1">&#39;POINT(0 0)&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
  <span class="n">ST_Buffer</span><span class="p">(</span><span class="s1">&#39;POINT(3 0)&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">));</span>
</pre></div>
</div>
<img alt="_images/intersection.jpg" class="inline" src="_images/intersection.jpg" />
</div>
<div class="section" id="st-union">
<h3>5.13.4. ST_Union<a class="headerlink" href="#st-union" title="Permalink to this headline">¶</a></h3>
<p>In the previous example we intersected geometries, creating a new geometry that had lines from both the inputs. The <strong class="command">ST_Union</strong> does the reverse; it takes inputs and removes common lines. There are two forms of the <strong class="command">ST_Union</strong> function:</p>
<ul>
<li><p class="first"><strong class="command">ST_Union(geometry, geometry)</strong>: A two-argument version that takes in two geometries and returns the merged union.  For example, our two-circle example from the previous section looks like this when you replace the intersection with a union.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- What is the total area these two circles cover?</span>
<span class="c1">-- Using ST_Buffer to make the circles!</span>

<span class="k">SELECT</span> <span class="n">ST_AsText</span><span class="p">(</span><span class="n">ST_Union</span><span class="p">(</span>
  <span class="n">ST_Buffer</span><span class="p">(</span><span class="s1">&#39;POINT(0 0)&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
  <span class="n">ST_Buffer</span><span class="p">(</span><span class="s1">&#39;POINT(3 0)&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">));</span>
</pre></div>
</div>
<img alt="_images/union.jpg" class="inline" src="_images/union.jpg" />
</li>
<li><p class="first"><strong class="command">ST_Union([geometry])</strong>: An aggregate version that takes in a set of geometries and returns the merged geometry for the entire group. The aggregate ST_Union can be used with the <code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code> SQL statement to create carefully merged subsets of basic geometries. It is very powerful,</p>
</li>
</ul>
<p>As an example of <strong class="command">ST_Union</strong> aggregation, consider our <code class="docutils literal notranslate"><span class="pre">nyc_census_blocks</span></code> table. Census geography is carefully constructed so that larger geographies can be built up from smaller ones. So, we can create a census tracts map by merging the blocks that form each tract (as we do later in <a class="reference internal" href="joins_advanced.html#creatingtractstable"><span class="std std-ref">Creating a Census Tracts Table</span></a>). Or, we can create a county map by merging blocks that fall within each county.</p>
<p>To carry out the merge, note that the unique key <code class="docutils literal notranslate"><span class="pre">blkid</span></code> actually embeds information about the higher level geographies. Here are the parts of the key for Liberty Island we used earlier:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">360610001001001</span> <span class="o">=</span> <span class="mi">36</span> <span class="mi">061</span> <span class="mi">000100</span> <span class="mi">1</span> <span class="mi">001</span>

<span class="mi">36</span>     <span class="o">=</span> <span class="n">State</span> <span class="n">of</span> <span class="n">New</span> <span class="n">York</span>
<span class="mi">061</span>    <span class="o">=</span> <span class="n">New</span> <span class="n">York</span> <span class="n">County</span> <span class="p">(</span><span class="n">Manhattan</span><span class="p">)</span>
<span class="mi">000100</span> <span class="o">=</span> <span class="n">Census</span> <span class="n">Tract</span>
<span class="mi">1</span>      <span class="o">=</span> <span class="n">Census</span> <span class="n">Block</span> <span class="n">Group</span>
<span class="mi">001</span>    <span class="o">=</span> <span class="n">Census</span> <span class="n">Block</span>
</pre></div>
</div>
<p>So, we can create a county map by merging all geometries that share the same first 5 digits of their <code class="docutils literal notranslate"><span class="pre">blkid</span></code>. Be patient; this is computationally expensive and can take a minute or two.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Create a nyc_census_counties table by merging census blocks</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">nyc_census_counties</span> <span class="k">AS</span>
<span class="k">SELECT</span>
  <span class="n">ST_Union</span><span class="p">(</span><span class="n">geom</span><span class="p">)::</span><span class="n">Geometry</span><span class="p">(</span><span class="n">MultiPolygon</span><span class="p">,</span><span class="mi">26918</span><span class="p">)</span> <span class="k">AS</span> <span class="n">geom</span><span class="p">,</span>
  <span class="n">SubStr</span><span class="p">(</span><span class="n">blkid</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="k">AS</span> <span class="n">countyid</span>
<span class="k">FROM</span> <span class="n">nyc_census_blocks</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">countyid</span><span class="p">;</span>
</pre></div>
</div>
<img alt="_images/union_counties.png" class="inline" src="_images/union_counties.png" />
<p>An area test can confirm that our union operation did not lose any geometry. First, we calculate the area of each individual census block, and sum those areas grouping by census county id.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">SubStr</span><span class="p">(</span><span class="n">blkid</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="k">AS</span> <span class="n">countyid</span><span class="p">,</span> <span class="k">Sum</span><span class="p">(</span><span class="n">ST_Area</span><span class="p">(</span><span class="n">geom</span><span class="p">))</span> <span class="k">AS</span> <span class="n">area</span>
<span class="k">FROM</span> <span class="n">nyc_census_blocks</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">countyid</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">countyid</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">countyid</span> <span class="o">|</span>       <span class="n">area</span>
<span class="o">----------+------------------</span>
 <span class="mi">36005</span>    <span class="o">|</span> <span class="mf">110196022.906506</span>
 <span class="mi">36047</span>    <span class="o">|</span> <span class="mf">181927497.678368</span>
 <span class="mi">36061</span>    <span class="o">|</span> <span class="mf">59091860.6261323</span>
 <span class="mi">36081</span>    <span class="o">|</span> <span class="mf">283194473.613692</span>
 <span class="mi">36085</span>    <span class="o">|</span> <span class="mf">150758328.111199</span>
</pre></div>
</div>
<p>Then we calculate the area of each of our new county polygons from the county table:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">countyid</span><span class="p">,</span> <span class="n">ST_Area</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span> <span class="k">AS</span> <span class="n">area</span>
<span class="k">FROM</span> <span class="n">nyc_census_counties</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">countyid</span> <span class="o">|</span>       <span class="n">area</span>
<span class="o">----------+------------------</span>
 <span class="mi">36005</span>    <span class="o">|</span> <span class="mf">110196022.906507</span>
 <span class="mi">36047</span>    <span class="o">|</span> <span class="mf">181927497.678367</span>
 <span class="mi">36061</span>    <span class="o">|</span> <span class="mf">59091860.6261324</span>
 <span class="mi">36081</span>    <span class="o">|</span> <span class="mf">283194473.593646</span>
 <span class="mi">36085</span>    <span class="o">|</span> <span class="mf">150758328.111199</span>
</pre></div>
</div>
<p>The same answer! We have successfully built an NYC county table from our census blocks data.</p>
</div>
<div class="section" id="id32">
<h3>5.13.5. Function List<a class="headerlink" href="#id32" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://postgis.net/docs/ST_AsText.html">ST_AsText(text)</a>: Returns the Well-Known Text (WKT) representation of the geometry/geography without SRID metadata.</p>
<p><a class="reference external" href="http://postgis.net/docs/ST_Buffer.html">ST_Buffer(geometry, distance)</a>: For geometry: Returns a geometry that represents all points whose distance from this Geometry is less than or equal to distance. Calculations are in the Spatial Reference System of this Geometry. For geography: Uses a planar transform wrapper.</p>
<p><a class="reference external" href="http://postgis.net/docs/ST_Intersection.html">ST_Intersection(geometry A, geometry B)</a>: Returns a geometry that represents the shared portion of geomA and geomB. The geography implementation does a transform to geometry to do the intersection and then transform back to WGS84.</p>
<p><a class="reference external" href="http://postgis.net/docs/ST_Union.html">ST_Union()</a>: Returns a geometry that represents the point set union of the Geometries.</p>
<p><a class="reference external" href="http://www.postgresql.org/docs/current/static/functions-string.html">substring(string [from int] [for int])</a>: PostgreSQL string function to extract substring matching SQL regular expression.</p>
<p><a class="reference external" href="http://www.postgresql.org/docs/current/static/functions-aggregate.html#FUNCTIONS-AGGREGATE-TABLE">sum(expression)</a>: PostgreSQL aggregate function that returns the sum of records in a set of records.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="index.html">Table of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="welcome.html">1. Welcome</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">2. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="instructions.html">3. Learning Outcomes</a></li>
<li class="toctree-l1"><a class="reference internal" href="setup.html">4. Setup Instructions</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">5. PostGIS - Basics</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#simple-sql">5.1. Simple SQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="#simple-sql-exercises">5.2. Simple SQL Exercises</a></li>
<li class="toctree-l2"><a class="reference internal" href="#geometries">5.3. Geometries</a></li>
<li class="toctree-l2"><a class="reference internal" href="#geometry-exercises">5.4. Geometry Exercises</a></li>
<li class="toctree-l2"><a class="reference internal" href="#spatial-relationships">5.5. Spatial Relationships</a></li>
<li class="toctree-l2"><a class="reference internal" href="#spatial-relationships-exercises">5.6. Spatial Relationships Exercises</a></li>
<li class="toctree-l2"><a class="reference internal" href="#spatial-joins">5.7. Spatial Joins</a></li>
<li class="toctree-l2"><a class="reference internal" href="#spatial-joins-exercises">5.8. Spatial Joins Exercises</a></li>
<li class="toctree-l2"><a class="reference internal" href="#spatial-indexing">5.9. Spatial Indexing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#projecting-data">5.10. Projecting Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#projection-exercises">5.11. Projection Exercises</a></li>
<li class="toctree-l2"><a class="reference internal" href="#geography">5.12. Geography</a></li>
<li class="toctree-l2"><a class="reference internal" href="#geometry-constructing-functions">5.13. Geometry Constructing Functions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="advanced.html">6. Advanced PostGIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="maintenance.html">7. Maintenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="postgis-functions.html">8. Appendix A: PostGIS Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">9. Appendix B: Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">10. Appendix C: License</a></li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="installation_linux.html"
                        title="previous chapter">4.1.3. Linux (Ubuntu 18.04 / Debian 10 Linux distribution)</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="advanced.html"
                        title="next chapter">6. Advanced PostGIS</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="advanced.html" title="6. Advanced PostGIS"
             >next</a></li>
        <li class="right" >
          <a href="installation_linux.html" title="4.1.3. Linux (Ubuntu 18.04 / Debian 10 Linux distribution)"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Introduction to PostGIS</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2019 Mayra Zurbaran and 2015, Paul Ramsey, Boundless | Mark Leslie, LISAsoft.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5.
    </div>
  </body>
</html>